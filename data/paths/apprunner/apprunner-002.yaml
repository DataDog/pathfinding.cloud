id: apprunner-002
name: apprunner:UpdateService
category: existing-passrole
services:
- apprunner
description: A principal with `apprunner:UpdateService` can modify an existing App Runner service's configuration. If the target service has a privileged IAM role attached, the attacker can update the service to leverage the attached role's permissions. They have multiple ways to exploit this, including configuring a StartCommand to execute AWS CLI commands when the service redeploys, updating to a container image with a web shell or reverse shell to access the role's credentials via the container metadata service, or pointing to a repository with a malicious apprunner.yaml file. This is similar to `lambda:UpdateFunctionCode` but for containerized applications. Unlike creating a new service, this doesn't require `iam:PassRole` since the role is already attached to the existing service.
prerequisites:
  admin:
  - An App Runner service must exist with an IAM role attached
  - The service's role must have administrative permissions
  lateral:
  - An App Runner service must exist with an IAM role attached
exploitationSteps:
  awscli:
  - step: 1
    command: aws apprunner list-services
    description: List existing App Runner services to find targets with privileged roles
  - step: 2
    command: aws apprunner describe-service --service-arn SERVICE_ARN
    description: Check the service's instance role ARN to confirm elevated permissions and note the current port configuration
  - step: 3
    command: aws sts get-caller-identity
    description: Verify your current identity and note your username for the next step
  - step: 4
    command: |
      aws apprunner update-service \
        --service-arn SERVICE_ARN \
        --source-configuration '{
          "ImageRepository": {
            "ImageIdentifier": "public.ecr.aws/aws-cli/aws-cli:latest",
            "ImageRepositoryType": "ECR_PUBLIC",
            "ImageConfiguration": {
              "Port": "CURRENT_PORT",
              "StartCommand": "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"
            }
          },
          "AutoDeploymentsEnabled": false
        }'
    description: Update the service to use the public AWS CLI image with a StartCommand that grants admin access to your user
  - step: 5
    command: aws apprunner describe-service --service-arn SERVICE_ARN --query 'Service.Status'
    description: Wait for the service to complete redeployment and reach 'RUNNING' status (may take 3-5 minutes). The StartCommand executes when the service starts.
  - step: 6
    command: sleep 15
    description: Wait 15 seconds for IAM policy changes to propagate
  - step: 7
    command: aws iam list-users --max-items 3
    description: Verify administrator access by listing IAM users (should now succeed)
recommendation: |
  Restrict the `apprunner:UpdateService` permission using resource-based constraints.

  ```json
  {
    "Effect": "Allow",
    "Action": "apprunner:UpdateService",
    "Resource": "arn:aws:apprunner:REGION:ACCOUNT_ID:service/SpecificService/HASH"
  }
  ```

  Additional controls:
  - Monitor CloudTrail for `UpdateService` events on sensitive App Runner services
  - Alert on changes to StartCommand, especially those executing IAM, STS, or security-related commands
  - Implement container image scanning and require signed images
  - Only allow images from approved ECR repositories using conditions (consider blocking public ECR if not needed)
  - Alert on source configuration changes to services with privileged roles
  - Use AWS Config to detect unauthorized service updates
  - Implement deployment approvals for production services
  - Enable auto-deployments only from trusted source repositories

limitations: |
  This path provides administrative access only if the target resource's execution role has administrative permissions. The attacker gains whatever permissions the resource's role has. If the role has limited permissions, the attacker gains limited access. However, even limited access may enable multi-hop attacks or access to sensitive data.

discoveryAttribution:
  firstDocumented:
    author: Seth Art
    organization: Datadog
    date: 2025
  derivativeOf:
    pathId: apprunner-001
    modification: "Uses apprunner:UpdateService to modify an existing service instead of apprunner:CreateService to create a new one. This bypasses the need for iam:PassRole since the role is already attached to the existing service."
  ultimateOrigin:
    pathId: apprunner-001
    author: Bollina Bhagavan
    organization: Appsecco
    date: 2021
    link: https://blog.appsecco.com/getting-shell-and-data-access-in-aws-app-runner-3632e844bc77
references:
- title: Getting Shell and Data Access in AWS App Runner
  url: https://blog.appsecco.com/getting-shell-and-data-access-in-aws-app-runner-3632e844bc77
relatedPaths:
- apprunner-001
- lambda-003
- glue-002
permissions:
  required:
  - permission: apprunner:UpdateService
    resourceConstraints: Target App Runner service must be in the Resource section
learningEnvironments:
  pathfinding-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinding-labs
    scenario: "privesc-one-hop/to-admin/apprunner-updateservice"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The principal with apprunner:UpdateService permission. Can be an IAM user or role. This principal can modify existing App Runner services to change their container image source.

  - id: target_service
    label: Existing App Runner Service
    type: resource
    description: |
      An existing App Runner service with an IAM role attached. The service runs containerized applications and can be reconfigured using multiple approaches to leverage the attached role's permissions. Unlike creating a new service, updating doesn't require iam:PassRole.

  - id: service_role
    label: Existing Role That Trusts the Apprunner Service
    type: principal
    description: |
      IAM role already attached to the App Runner service. The role trusts apprunner.amazonaws.com and was passed when the service was created. When the service is updated and redeploys, it continues to use this role and provides access to the role's permissions through various methods.

  - id: method_startcommand
    label: "Method 1: StartCommand"
    type: payload
    color: '#99ccff'
    description: |
      Update the service configuration to include a StartCommand that executes when the service redeploys, running AWS CLI commands with the service role's credentials. The StartCommand can perform privileged actions such as:
      - Attaching AdministratorAccess policy to the starting principal
      - Creating new access keys for privileged users
      - Modifying IAM policies or trust relationships
      - Exfiltrating data from S3, secrets, or databases
      - Any AWS API action the service role has permissions for

      Example: `StartCommand: "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"`

  - id: method_webshell
    label: "Method 2: ECR Image with Web Shell"
    type: payload
    color: '#99ccff'
    description: |
      Update the service to use a container image (from ECR or public registry) containing a web shell or reverse shell. The container runs with the service role's permissions and can access the role's temporary credentials via the container metadata service at 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI.

      The web shell provides an interface to:
      - Query the metadata service for temporary credentials (AccessKeyId, SecretAccessKey, SessionToken)
      - Execute arbitrary commands within the container
      - Exfiltrate the credentials for use outside the container

  - id: method_apprunner_yaml
    label: "Method 3: Repository with apprunner.yaml"
    type: payload
    color: '#99ccff'
    description: |
      Update the service to point to a source code repository containing a malicious apprunner.yaml configuration file. The apprunner.yaml file can specify build and run commands that execute during the service redeployment and startup, running with the service role's permissions.

      The apprunner.yaml can include:
      - Pre-build commands that execute during image build
      - Post-build commands after the build completes
      - Start commands that run when the service starts
      - All commands execute with access to the service role's credentials via environment variables or metadata service

  - id: admin
    label: Effective Administrator
    type: outcome
    description: |
      The service role has AdministratorAccess or equivalent permissions. Using any of the three exploitation methods, the attacker successfully leverages these permissions to gain full administrative access to the AWS account.

  - id: some_perms
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: |
      The service role has some elevated permissions (but not full admin). Using any of the three exploitation methods, the attacker can leverage these permissions for data exfiltration (S3, RDS, DynamoDB), modification of security configurations, or additional privilege escalation paths.

  - id: no_access
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: |
      The service role only has minimal permissions (like logs:PutLogEvents). Regardless of the exploitation method used, the privilege escalation provides minimal value.

  edges:
  - from: start
    to: target_service
    label: apprunner:UpdateService
    description: |
      Update the existing App Runner service's configuration. The service can be reconfigured using multiple approaches (StartCommand, container image, or source repository). Unlike creating a new service, this doesn't require iam:PassRole since the role is already attached.

      Example command (StartCommand approach):
      ```bash
      aws apprunner update-service \
        --service-arn SERVICE_ARN \
        --source-configuration '{
          "ImageRepository": {
            "ImageIdentifier": "public.ecr.aws/aws-cli/aws-cli:latest",
            "ImageRepositoryType": "ECR_PUBLIC",
            "ImageConfiguration": {
              "Port": "CURRENT_PORT",
              "StartCommand": "iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess"
            }
          },
          "AutoDeploymentsEnabled": false
        }'
      ```

  - from: target_service
    to: service_role
    label: Service uses existing role
    description: |
      The App Runner service redeploys with the updated configuration. The service continues to use its existing IAM role and has access to all permissions granted to this role.

  - from: service_role
    to: method_startcommand
    label: Option A
    description: |
      Update the service configuration to include a StartCommand that executes AWS CLI commands when the service redeploys. The command runs with the service role's credentials.

  - from: service_role
    to: method_webshell
    label: Option B
    description: |
      Update the service to use a container image containing a web shell or reverse shell. Access the role's credentials via the container metadata service.

  - from: service_role
    to: method_apprunner_yaml
    label: Option C
    description: |
      Update the service to use a source code repository with a malicious apprunner.yaml file that specifies commands to execute during build and runtime.

  - from: method_startcommand
    to: admin
    label: If service role has admin permissions
    branch: A1
    condition: admin
    description: |
      The StartCommand executes with AdministratorAccess permissions and successfully grants the starting principal full administrative access.

  - from: method_startcommand
    to: some_perms
    label: If service role has some elevated permissions
    branch: A2
    condition: some_permissions
    description: |
      The StartCommand executes with elevated permissions and can perform privileged actions within those permissions.

  - from: method_startcommand
    to: no_access
    label: If service role has minimal permissions
    branch: A3
    condition: no_permissions
    description: |
      The StartCommand has minimal permissions and provides limited value for privilege escalation.

  - from: method_webshell
    to: admin
    label: If service role has admin permissions
    branch: B1
    condition: admin
    description: |
      The web shell successfully exfiltrates credentials with AdministratorAccess permissions, granting full administrative access.

  - from: method_webshell
    to: some_perms
    label: If service role has some elevated permissions
    branch: B2
    condition: some_permissions
    description: |
      The web shell exfiltrates credentials with elevated permissions that can be used for data access or further escalation.

  - from: method_webshell
    to: no_access
    label: If service role has minimal permissions
    branch: B3
    condition: no_permissions
    description: |
      The exfiltrated credentials have minimal permissions and provide limited value.

  - from: method_apprunner_yaml
    to: admin
    label: If service role has admin permissions
    branch: C1
    condition: admin
    description: |
      The apprunner.yaml commands execute with AdministratorAccess permissions and successfully escalate privileges.

  - from: method_apprunner_yaml
    to: some_perms
    label: If service role has some elevated permissions
    branch: C2
    condition: some_permissions
    description: |
      The apprunner.yaml commands execute with elevated permissions and can perform privileged actions.

  - from: method_apprunner_yaml
    to: no_access
    label: If service role has minimal permissions
    branch: C3
    condition: no_permissions
    description: |
      The apprunner.yaml commands have minimal permissions and provide limited value.
