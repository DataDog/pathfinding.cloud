id: lambda-001
name: iam:PassRole + lambda:CreateFunction + lambda:InvokeFunction
category: service-passrole
services:
- iam
- lambda
description: A principal with `iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction` can create a new Lambda function and attach an existing IAM Role to it. When the function is invoked, the code executes with the permissions of the attached role. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - A role must exist that trusts lambda.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - A role must exist that trusts lambda.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws lambda create-function --function-name privesc-function --runtime python3.9 --role "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE"
      --handler index.handler --zip-file fileb://exploit.zip
    description: Create a Lambda function with the privileged role and malicious code
  - step: 2
    command: aws lambda invoke --function-name privesc-function output.txt
    description: Invoke the function to execute code with elevated privileges
  - step: 3
    command: cat output.txt
    description: View the output containing credentials or results of privileged API calls
  pacu:
  - step: 1
    command: run lambda__backdoor_new_roles --role PRIVILEGED_ROLE
    description: Use Pacu to create a backdoored Lambda function with the target role
  - step: 2
    command: run lambda__invoke --function-name privesc-function
    description: Invoke the function to retrieve credentials
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "`iam:PassRole`",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificLambdaRole",
    "Condition": {
      "StringEquals": {
        "`iam:PassedToService`": "lambda.amazonaws.com"
      }
    }
  }
  ```

  Additionally, restrict Lambda function creation and invocation:
  - Limit `lambda:CreateFunction` to specific function name patterns
  - Require resource-based policies on Lambda functions
  - Monitor CloudTrail for unusual Lambda function creation followed by immediate invocation
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - Lambda Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-lambda-privesc/index.html#iampassrole-lambdacreatefunction-lambdainvokefunction--lambdainvokefunctionurl
- title: IAM Vulnerable - PassExistingRoleToNewLambdaThenInvoke
  url: https://github.com/BishopFox/iam-vulnerable/blob/main/modules/free-resources/privesc-paths/privesc15-PassExistingRoleToNewLambdaThenInvoke.tf
- title: Well, That Escalated Quickly - Privesc 15
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- ec2-001
- cloudformation-001
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L152-L156
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L531
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L37-L41
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole+lambda-createfunction+lambda-invokefunction"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: Lambda-PassExistingRoleToNewLambdaThenInvoke
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: lambda_privesc
    description: "Deploy vulnerable infrastructure using CloudGoat to practice AWS Lambda privilege escalation"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS Lambda security labs"
    scenario: https://cybr.com/courses/aws-lambda-security-labs/
    scenarioPricingModel: paid
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: lambda:CreateFunction
    resourceConstraints: Must have permission to create Lambda functions
  - permission: lambda:InvokeFunction
    resourceConstraints: Must have permission to invoke Lambda functions
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `iam:PassRole`, `lambda:CreateFunction`, and `lambda:InvokeFunction` permissions. This principal will create a Lambda function with a privileged role attached and invoke it to gain elevated privileges.
  - id: lambda_function
    label: New Lambda Function
    type: resource
    description: |
      The newly created Lambda function with malicious code. The function is created with `lambda:CreateFunction` and configured to use a privileged IAM role via `iam:PassRole`. The function code is designed to exfiltrate credentials or perform privileged actions.
  - id: target_role
    label: Existing Role That Trusts the lambda Service
    type: principal
    description: |
      The privileged IAM role that is passed to the Lambda function during creation. This role must trust lambda.amazonaws.com as a principal in its trust policy. When the Lambda function is invoked, it executes with this role's permissions.
  - id: exfiltrate
    label: Exfiltrate credentials
    type: action
    color: '#99ccff'
    description: |
      The Lambda function code executes with the target role's permissions. The function can either return the temporary credentials directly in the response, or use the role's permissions to perform privileged API calls (create access keys, modify policies, etc.).
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent), the attacker gains full administrative access to the AWS account by using the credentials or results from the Lambda function execution.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has some elevated permissions but not full admin, the attacker gains partial privilege escalation. This could include access to sensitive data (S3, RDS, DynamoDB) or the ability to pursue additional escalation paths.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions or no interesting permissions, the privilege escalation may not provide meaningful additional access to the attacker.
  edges:
  - from: start
    to: lambda_function
    label: iam:PassRole + lambda:CreateFunction
    description: |
      The attacker creates a new Lambda function and passes a privileged role to it. The function is created with malicious code (typically in a ZIP file) that will execute when invoked.

      Command:
      ```bash
      aws lambda create-function \
        --function-name privesc-function \
        --runtime python3.9 \
        --role "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --handler index.handler \
        --zip-file fileb://exploit.zip
      ```

      The exploit.zip contains code to exfiltrate credentials or perform privileged actions.
  - from: lambda_function
    to: target_role
    label: Function assumes role
    description: |
      When the Lambda function is invoked, the Lambda service automatically assumes the target role on behalf of the function. The function code then executes with all the permissions granted to this role.
  - from: target_role
    to: exfiltrate
    label: lambda:InvokeFunction
    description: |
      The attacker invokes the Lambda function, which executes the malicious code with the target role's permissions. The function can retrieve its own credentials via the AWS SDK or IMDSv2, or directly perform privileged API calls.

      Command:
      ```bash
      aws lambda invoke \
        --function-name privesc-function \
        output.txt
      ```

      The output.txt file contains the function's response, which may include credentials or results of privileged operations.
  - from: exfiltrate
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent administrative permissions, the attacker gains full control over the AWS account. They can use the exfiltrated credentials to perform any action in the account.
  - from: exfiltrate
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation. This might include access to sensitive data stores (S3 buckets, RDS databases, DynamoDB tables) or permissions that enable additional privilege escalation techniques.
  - from: exfiltrate
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal or non-sensitive permissions, the privilege escalation may not yield meaningful additional access. However, even limited access could be useful for reconnaissance or as part of a multi-step attack chain.
