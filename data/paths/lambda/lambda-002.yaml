id: lambda-002
name: iam:PassRole + lambda:CreateFunction + lambda:CreateEventSourceMapping
category: service-passrole
services:
- iam
- lambda
description: A principal with `iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping` can create a Lambda function with a privileged role and configure it to be automatically triggered by an event source (such as DynamoDB streams, Kinesis, or SQS). This allows the attacker to execute code with elevated privileges without manually invoking the function.
prerequisites:
  admin:
  - A role must exist that trusts lambda.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  - An event source must exist (DynamoDB stream, Kinesis stream, or SQS queue)
  lateral:
  - A role must exist that trusts lambda.amazonaws.com to assume it
  - An event source must exist (DynamoDB stream, Kinesis stream, or SQS queue)
exploitationSteps:
  awscli:
  - step: 1
    command: |
      aws lambda create-function --function-name privesc-triggered \
        --runtime python3.9 --role arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --handler index.handler --zip-file fileb://exploit.zip
    description: Create a Lambda function with the privileged role
  - step: 2
    command: |
      aws lambda create-event-source-mapping --function-name privesc-triggered \
        --event-source-arn arn:aws:dynamodb:REGION:ACCOUNT_ID:table/TABLE_NAME/stream/STREAM_ID \
        --starting-position LATEST
    description: Configure the function to be triggered automatically by an event source
  - step: 3
    command: aws dynamodb put-item --table-name TABLE_NAME --item '{"id":{"S":"trigger"}}'
    description: Trigger the function by adding an item to the DynamoDB table
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificLambdaRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "lambda.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - Restrict `lambda:CreateEventSourceMapping` permissions
  - Monitor CloudTrail for Lambda function creation with event source mappings
  - Alert on Lambda functions with privileged roles being created
  - Implement resource-based policies on event sources
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - Lambda PassRole with Trigger
  url: https://github.com/BishopFox/iam-vulnerable
relatedPaths:
- lambda-001
- lambda-003
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L156-L160
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L645
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L40-L44
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/iam-passrole+lambda-createfunction+createeventsourcemapping-dynamodb
    description: Deploy Terraform into your own AWS account to practice this attack path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: Lambda-PassRoleToNewLambdaThenTrigger
    description: Deploy Terraform into your own AWS account and practice individual exploitation paths
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: lambda_privesc
    description: Deploy vulnerable infrastructure using CloudGoat to practice AWS attacks
toolSupport:
  pmapper: true
  iamVulnerable: true
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: lambda:CreateFunction
    resourceConstraints: Must have permission to create Lambda functions
  - permission: lambda:CreateEventSourceMapping
    resourceConstraints: Must have permission to create event source mappings
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
  - permission: dynamodb:PutItem
    resourceConstraints: Depending on what event source you configured, you might need permission to trigger it. We're using dynamodb:PutItem here only as an example. Ideally you will create an event source for something that is already happening so that you don't have to do anything manually.
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `iam:PassRole`, `lambda:CreateFunction`, and `lambda:CreateEventSourceMapping` permissions. This principal will create a Lambda function with a privileged role attached and configure it to be automatically triggered by an event source.
  - id: lambda_function
    label: New Lambda Function
    type: resource
    description: |
      The newly created Lambda function with malicious code. The function is created with `lambda:CreateFunction` and configured to use a privileged IAM role via `iam:PassRole`. Unlike lambda-001, this function does not require manual invocation - it will be automatically triggered by configured event sources.
  - id: event_source
    label: Event Source Mapping
    type: resource
    description: |
      An event source mapping configured with `lambda:CreateEventSourceMapping` that automatically triggers the Lambda function. Common event sources include DynamoDB streams, Kinesis streams, or SQS queues. When events occur in the source, the Lambda function is automatically invoked with the target role's permissions.
  - id: target_role
    label: Existing Role That Trusts the lambda Service
    type: resource
    description: |
      The privileged IAM role that is passed to the Lambda function during creation. This role must trust lambda.amazonaws.com as a principal in its trust policy. When the Lambda function is automatically triggered by events, it executes with this role's permissions without requiring manual invocation.
  - id: exfiltrate
    label: Exfiltrate credentials
    type: action
    color: '#99ccff'
    description: |
      When the event source triggers the Lambda function, the function code executes with the target role's permissions. The function can exfiltrate the temporary credentials to an attacker-controlled server, or directly perform privileged API calls using the role's permissions. The automatic triggering nature means the attacker doesn't need lambda:InvokeFunction permission.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent), the attacker gains full administrative access to the AWS account when the function is automatically triggered. The credentials or privileged actions can be captured through the function's output or external exfiltration.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has some elevated permissions but not full admin, the attacker gains partial privilege escalation when the function triggers. This could include access to sensitive data (S3, RDS, DynamoDB) or the ability to pursue additional escalation paths.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions or no interesting permissions, the automatic function execution may not provide meaningful additional access to the attacker, even when triggered by events.
  edges:
  - from: start
    to: lambda_function
    label: iam:PassRole + lambda:CreateFunction
    description: |
      The attacker creates a new Lambda function and passes a privileged role to it. The function is created with malicious code (typically in a ZIP file) that will execute when automatically triggered by events.

      Command:
      ```bash
      aws lambda create-function \
        --function-name privesc-triggered \
        --runtime python3.9 \
        --role "arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE" \
        --handler index.handler \
        --zip-file fileb://exploit.zip
      ```

      The exploit.zip contains code to exfiltrate credentials or perform privileged actions when triggered.
  - from: lambda_function
    to: event_source
    label: lambda:CreateEventSourceMapping
    description: |
      The attacker configures an event source mapping to automatically trigger the Lambda function. This connects the function to an existing event source like a DynamoDB stream, Kinesis stream, or SQS queue.

      Command:
      ```bash
      aws lambda create-event-source-mapping \
        --function-name privesc-triggered \
        --event-source-arn arn:aws:dynamodb:REGION:ACCOUNT_ID:table/TABLE_NAME/stream/STREAM_ID \
        --starting-position LATEST
      ```

      This eliminates the need for lambda:InvokeFunction permission - the function executes automatically when events occur.
  - from: event_source
    to: target_role
    label: Event triggers function
    description: |
      When events occur in the configured source (e.g., items added to DynamoDB, messages in SQS, records in Kinesis), the Lambda service automatically invokes the function. The function executes with all the permissions granted to the target role, without requiring manual invocation by the attacker.
  - from: target_role
    to: exfiltrate
    label: Function executes with role permissions
    description: |
      The Lambda function code executes automatically with the target role's permissions when triggered by events. The malicious code can retrieve its own credentials via the AWS SDK or IMDSv2, send them to an attacker-controlled server, or directly perform privileged API calls using the role's permissions.
  - from: exfiltrate
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent administrative permissions, the attacker gains full control over the AWS account when the function triggers. They can use the exfiltrated credentials or the results of privileged operations to compromise the entire account.
  - from: exfiltrate
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation when the function triggers. This might include access to sensitive data stores (S3 buckets, RDS databases, DynamoDB tables) or permissions that enable additional privilege escalation techniques.
  - from: exfiltrate
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal or non-sensitive permissions, the automatic function execution may not yield meaningful additional access. However, even limited access could be useful for reconnaissance or as part of a multi-step attack chain. 
