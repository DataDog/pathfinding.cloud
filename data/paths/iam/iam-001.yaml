id: iam-001
name: iam:CreatePolicyVersion
category: self-escalation
services:
- iam
description: Anyone with access to `iam:CreatePolicyVersion` can create a new version of an IAM policy. If a user can create
  a new version of a policy that is already attached to them, they can grant themselves administrative privileges by creating
  a new policy version with elevated permissions and setting it as the default version. A principal can also leverage this
  to escalate the permissions of another principal they can access.
prerequisites:
  admin:
  - Policy must already be attached to the actor's user, role, or group
  lateral:
  - Policy must already be attached to the actor's user, role, or group
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam create-policy-version --policy-arn @arn --policy-document file://admin_policy.json --set-as-default
    description: Create a new policy version with administrative permissions and set it as default
  pacu:
  - step: 1
    command: run iam__privesc_scan
    description: Scan for IAM privilege escalation opportunities including CreatePolicyVersion
recommendation: |
  Restrict access to `iam:CreatePolicyVersion` using the principle of least privilege.
  Very few principals need this permission, so it should be restricted to only the
  few principals that need it. Monitor use of this sensitive permission using
  CloudSIEM detections, and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-007
- iam-008
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-CreateNewPolicyVersion
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
attackVisualization:
  nodes:
    - id: start
      label: starting-principal
      type: principal
      description: |
        The principal initiating the attack. Can be an IAM user or role that has an IAM policy already attached to them (directly, via group, or inline). Must have iam:CreatePolicyVersion permission on that policy.

    - id: attached_policy
      label: attached-policy
      type: resource
      description: |
        An IAM customer managed policy that is already attached to the starting principal (directly, via group, or inline). The principal must have iam:CreatePolicyVersion permission for this specific policy ARN.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The new policy version is now the default and automatically takes effect. The starting principal immediately gains all permissions specified in the new policy version, including full administrative access if that was included.

  edges:
    - from: start
      to: attached_policy
      label: Has policy attached
      description: |
        The starting principal must already have a customer managed policy attached to them (directly, via their role, or via a group they belong to). This is a prerequisite for the attack.

    - from: attached_policy
      to: admin
      label: iam:CreatePolicyVersion
      description: |
        Execute the iam:CreatePolicyVersion API call to create a new version of the attached policy. Include a policy document with administrative permissions and use --set-as-default to make it active immediately.

        Example command:
        aws iam create-policy-version --policy-arn @arn --policy-document file://admin_policy.json --set-as-default

        The new policy version becomes the default and takes effect immediately. All principals with this policy attached (including the attacker) now have the permissions specified in the new version.
permissions:
  required:
  - permission: iam:CreatePolicyVersion
    resourceConstraints: Policy ARN must be in the Resource section and policy must be attached to the actor
