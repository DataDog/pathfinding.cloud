id: iam-008
name: iam:AttachUserPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:AttachUserPolicy` can attach managed policies to any user they have this permission
  on. This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also
  leverage this to escalate the permissions of another principal they can access.
prerequisites:
- A managed IAM policy with elevated privileges must exist in the account
- Principal must be a user (not a role)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam attach-user-policy --user-name @username --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    description: Attach the AdministratorAccess managed policy to the target user
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:AttachUserPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-001
- iam-007
- iam-009
- iam-010
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
toolSupport:
  pmapper: true
  iamVulnerable: true
permissions:
  required:
  - permission: iam:AttachUserPolicy
    resourceConstraints: Target user must be in the Resource section. For self-escalation, must have permission on own user.
