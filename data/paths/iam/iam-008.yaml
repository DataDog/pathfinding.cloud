id: iam-008
name: iam:AttachUserPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:AttachUserPolicy` can attach managed policies to any user they have this permission
  on. This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also
  leverage this to escalate the permissions of another principal they can access.
prerequisites:
- A managed IAM policy with elevated privileges must exist in the account
- Principal must be a user (not a role)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam attach-user-policy --user-name @username --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    description: Attach the AdministratorAccess managed policy to the target user
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:AttachUserPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamattachuserpolicy--iamattachgrouppolicy
- title: Well, That Escalated Quickly - Privesc 07
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- iam-001
- iam-007
- iam-009
- iam-010
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L131
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L289-L298
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L103
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-self-escalation/to-admin/iam-attachuserpolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-AttachUserPolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: iam_privesc_by_attachment
    description: "Deploy vulnerable infrastructure using CloudGoat to practice AWS privilege escalation through policy attachment"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamattachuserpolicy-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
    - id: start
      label: starting-user
      type: principal
      description: |
        The IAM user with iam:AttachUserPolicy permission on themselves. Can attach any existing managed policy in the account to themselves, including AWS managed policies like AdministratorAccess.

    - id: managed_policy
      label: managed-policy
      type: resource
      description: |
        An existing IAM managed policy in the account. This could be an AWS managed policy (like AdministratorAccess, PowerUserAccess, etc.) or a customer managed policy with elevated permissions. The policy must already exist in the account.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        If an administrative managed policy exists (e.g., AdministratorAccess or equivalent custom policy), the user gains full administrative access to the account. The policy takes effect immediately after being attached.

    - id: some_perms
      label: Some Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        If the attached managed policy has elevated but non-administrative permissions (e.g., PowerUserAccess, SecurityAudit, custom policies with specific permissions), the user gains those permissions. Check for data access paths or additional privilege escalation opportunities.

    - id: no_access
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        If only minimal or restrictive managed policies exist in the account, there may be no meaningful privilege escalation achieved. The user would still gain the permissions from the attached policy, but they may not provide additional access beyond what the user already had.

  edges:
    - from: start
      to: managed_policy
      label: iam:AttachUserPolicy
      description: |
        Execute iam:AttachUserPolicy to attach an existing managed policy to the user. The attacker must identify a managed policy with elevated permissions to attach.

        Command:
        ```bash
        aws iam attach-user-policy --user-name @username --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
        ```

        The policy takes effect immediately after being attached. The user gains all permissions specified in the managed policy.

    - from: managed_policy
      to: admin
      label: If policy has admin permissions
      branch: A
      condition: admin
      description: |
        If the attached managed policy is AdministratorAccess or an equivalent custom policy with administrative permissions, the user gains full administrative access to the AWS account. This is the most common and severe outcome.

    - from: managed_policy
      to: some_perms
      label: If policy has elevated permissions
      branch: B
      condition: some_permissions
      description: |
        If the attached managed policy has elevated but non-administrative permissions, the user gains those specific permissions. Examples include PowerUserAccess (excludes IAM), ReadOnlyAccess, SecurityAudit, or custom policies with permissions to specific services. Check for data access or additional escalation paths.

    - from: managed_policy
      to: no_access
      label: If only minimal policies exist
      branch: C
      condition: no_permissions
      description: |
        If the account only has managed policies with minimal or restrictive permissions (e.g., policies that only grant read access to non-sensitive resources), the escalation may not provide meaningful additional access. However, this is rare since AWS managed policies like AdministratorAccess exist in all accounts.
permissions:
  required:
  - permission: iam:AttachUserPolicy
    resourceConstraints: Target user must be in the Resource section. For self-escalation, must have permission on own user.
