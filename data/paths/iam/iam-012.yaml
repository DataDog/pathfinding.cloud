id: iam-012
name: iam:UpdateAssumeRolePolicy
category: principal-access
services:
- iam
description: Anyone with access to `iam:UpdateAssumeRolePolicy` can modify the trust
  policy of any role they have this permission  on. This permission is often abused
  by one principal to modify a privileged role's trust policy to allow themselves
  to assume   it, thereby gaining access to the privileged role's permissions. You
  might think that you would also need `sts:AssumeRole` permission to exploit this,
  but if you update the role policy of the target role to trust you explicitly (your
  full arn, not ACCOUNT_ID:root), then you do not need sts:AssumeRole permission to
  assume the role.
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam update-assume-role-policy --role-name @rolename --policy-document
      file://trust_policy.json
    description: Update the role's trust policy to allow your principal to assume
      it
  - step: 2
    command: aws sts assume-role --role-arn arn:aws:iam::123456789012:role/@rolename
      --role-session-name exploit
    description: Assume the privileged role
  - step: 3
    command: '# Configure AWS CLI with the temporary credentials from assume-role'
    description: Use the elevated permissions of the assumed role
recommendation: 'Restrict access to `iam:UpdateAssumeRolePolicy` using the principle of least privilege. Very few principals need this permission, so it should be restricted to only the few principals that need it. Monitor use of this sensitive permission using CloudSIEM detections, and look for usage anomalies.'
limitations: 'This path provides administrative access only if the attacker modifies a role that has administrative permissions. The attacker gains whatever permissions the modified role has. If the role has limited permissions, the attacker gains limited access. However, even limited access may enable multi-hop attacks.'
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamupdateassumerolepolicy
- title: HackingTheCloud - UpdateAssumeRolePolicy Privilege Escalation
  url: https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/#iamupdateassumerolepolicy
- title: Well, That Escalated Quickly - Privesc 14
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/iam_edges.py#L131
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/7f82e7ab0a1a714d20a69b1d0b892e4702754e6b/cloudsplaining/shared/constants.py#L126
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/50e7ad2d885b7ab4bc130f44b798ca85ed4d7a91/pacu/modules/iam__privesc_scan/main.py#L498
  prowler: https://github.com/prowler-cloud/prowler/blob/49c75cc4180e2304747d8fe4bd1b16dd38929d07/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L98
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinding-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinding-labs
    scenario: privesc-one-hop/to-admin/iam-updateassumerolepolicy
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-UpdatingAssumeRolePolicy
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The principal with iam:UpdateAssumeRolePolicy permission on the
      target role. Can be an IAM user or role with permission to modify trust policies.

      '
  - id: target_role
    label: Existing Role (Trust Policy to be Modified)
    type: principal
    description: 'The target IAM role whose trust policy will be modified. The attacker
      modifies this role''s trust policy to allow themselves to assume it, thereby
      gaining access to all permissions attached to the role.

      '
  - id: assumed_role
    label: Target Role (assumed)
    type: principal
    description: 'The target role after being assumed by the attacker. The attacker
      now has temporary credentials with all the permissions of this role.

      '
  - id: admin
    label: Effective Administrator
    type: outcome
    description: 'Full administrative access to the AWS account when the target role
      has AdministratorAccess or equivalent permissions.

      '
  - id: some_perms
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: 'The target role has some elevated permissions. Check for data access
      (S3, RDS, DynamoDB) or additional privilege escalation paths.

      '
  - id: no_access
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: 'The target role has no interesting permissions beyond what the starting
      principal already had.

      '
  edges:
  - from: start
    to: target_role
    label: iam:UpdateAssumeRolePolicy
    description: |
      Execute iam:UpdateAssumeRolePolicy to modify the target role's trust policy to allow the starting principal to assume it. This adds the starting principal's ARN to the role's trust policy.

      Command:
      ```bash
      aws iam update-assume-role-policy \
        --role-name @rolename \
        --policy-document file://trust_policy.json
      ```

      The trust_policy.json file should contain the starting principal's ARN in the Principal section.
  - from: target_role
    to: assumed_role
    label: sts:AssumeRole
    description: |
      After modifying the trust policy, assume the target role using sts:AssumeRole. This returns temporary credentials with all the permissions of the target role.

      Command:
      ```bash
      aws sts assume-role \
        --role-arn arn:aws:iam::123456789012:role/@rolename \
        --role-session-name exploit
      ```

      Configure the AWS CLI with the temporary credentials from the assume-role response.
  - from: assumed_role
    to: admin
    label: If role has admin permissions
    branch: A
    condition: admin
    description: 'If the target role has AdministratorAccess or equivalent permissions,
      the attacker gains full administrative access to the account.

      '
  - from: assumed_role
    to: some_perms
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: 'If the target role has some elevated permissions, check for data
      access (S3, RDS, DynamoDB) or additional privilege escalation paths.

      '
  - from: assumed_role
    to: no_access
    label: If role has no interesting permissions
    branch: C
    condition: no_permissions
    description: 'If the target role only has minimal permissions, there may be no
      meaningful privilege escalation achieved.

      '
permissions:
  required:
  - permission: iam:UpdateAssumeRolePolicy
    resourceConstraints: Target role must be in the Resource section
  additional:
  - permission: iam:ListUsers
    resourceConstraints: Helpful for discovering target users
  - permission: iam:GetUser
    resourceConstraints: Useful for viewing user details
