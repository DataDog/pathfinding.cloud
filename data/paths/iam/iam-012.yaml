id: iam-012
name: iam:UpdateAssumeRolePolicy
category: lateral-movement
services:
- iam
description: Anyone with access to `iam:UpdateAssumeRolePolicy` can modify the trust policy of any role they have this permission
  on. This permission is often abused by one principal to modify a privileged role's trust policy to allow themselves to assume
  it, thereby gaining access to the privileged role's permissions.
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam update-assume-role-policy --role-name @rolename --policy-document file://trust_policy.json
    description: Update the role's trust policy to allow your principal to assume it
  - step: 2
    command: aws sts assume-role --role-arn arn:aws:iam::123456789012:role/@rolename --role-session-name exploit
    description: Assume the privileged role
  - step: 3
    command: '# Configure AWS CLI with the temporary credentials from assume-role'
    description: Use the elevated permissions of the assumed role
recommendation: |
  Restrict access to `iam:UpdateAssumeRolePolicy` using the principle of least privilege.
  Very few principals need this permission, so it should be restricted to only the few
  principals that need it. Monitor use of this sensitive permission using CloudSIEM
  detections, and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/iam_edges.py#L130
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L127
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L675
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L115
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-updateassumerolepolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-UpdatingAssumeRolePolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with iam:UpdateAssumeRolePolicy permission on the target role. Can be an IAM user or role with permission to modify trust policies.

    - id: target_role
      label: Existing Role (Trust Policy to be Modified)
      type: resource
      description: |
        The target IAM role whose trust policy will be modified. The attacker modifies this role's trust policy to allow themselves to assume it, thereby gaining access to all permissions attached to the role.

    - id: assumed_role
      label: Target Role (assumed)
      type: resource
      description: |
        The target role after being assumed by the attacker. The attacker now has temporary credentials with all the permissions of this role.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        Full administrative access to the AWS account when the target role has AdministratorAccess or equivalent permissions.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The target role has some elevated permissions. Check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - id: no_access
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The target role has no interesting permissions beyond what the starting principal already had.

  edges:
    - from: start
      to: target_role
      label: iam:UpdateAssumeRolePolicy
      description: |
        Execute iam:UpdateAssumeRolePolicy to modify the target role's trust policy to allow the starting principal to assume it. This adds the starting principal's ARN to the role's trust policy.

        Command:
        ```bash
        aws iam update-assume-role-policy \
          --role-name @rolename \
          --policy-document file://trust_policy.json
        ```

        The trust_policy.json file should contain the starting principal's ARN in the Principal section.

    - from: target_role
      to: assumed_role
      label: sts:AssumeRole
      description: |
        After modifying the trust policy, assume the target role using sts:AssumeRole. This returns temporary credentials with all the permissions of the target role.

        Command:
        ```bash
        aws sts assume-role \
          --role-arn arn:aws:iam::123456789012:role/@rolename \
          --role-session-name exploit
        ```

        Configure the AWS CLI with the temporary credentials from the assume-role response.

    - from: assumed_role
      to: admin
      label: If role has admin permissions
      branch: A
      condition: admin
      description: |
        If the target role has AdministratorAccess or equivalent permissions, the attacker gains full administrative access to the account.

    - from: assumed_role
      to: some_perms
      label: If role has some permissions
      branch: B
      condition: some_permissions
      description: |
        If the target role has some elevated permissions, check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - from: assumed_role
      to: no_access
      label: If role has no interesting permissions
      branch: C
      condition: no_permissions
      description: |
        If the target role only has minimal permissions, there may be no meaningful privilege escalation achieved.
permissions:
  required:
  - permission: iam:UpdateAssumeRolePolicy
    resourceConstraints: Target role must be in the Resource section
  additional:
  - permission: iam:ListUsers
    resourceConstraints: Helpful for discovering target users
  - permission: iam:GetUser
    resourceConstraints: Useful for viewing user details
