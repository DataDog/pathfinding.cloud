id: iam-004
name: iam:CreateLoginProfile
category: lateral-movement
services:
- iam
description: Anyone with access to `iam:CreateLoginProfile` can create console login profiles for any user they have this
  permission on. This permission is often abused by one principal to gain access to another principal and the permissions
  associated with that principal via the AWS Console.
prerequisites:
  admin:
  - Target user must NOT currently have a login profile
  - Target user must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - Target user must NOT currently have a login profile
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam create-login-profile --user-name @username --password @password
    description: Create a console login profile with a known password for the target user
  - step: 2
    command: '# Login to AWS Console with the username and password'
    description: Access AWS Console as the target user
recommendation: |
  Restrict access to `iam:CreateLoginProfile` using the principle of least privilege. Only allow
  users to create login profiles for users they are authorized to manage. Very few principals
  need this permission on anyone other than themselves, so it should be restricted to only the
  few principals that need it. Monitor use of this sensitive permission using CloudSIEM
  detections, and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamcreateloginprofile--iamupdateloginprofile
- title: Well, That Escalated Quickly - Privesc 05
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
- title: s3cur3.it IAMVulnerable - Part 3
  url: https://s3cur3.it/home/practicing-aws-security-with-iamvulnerable-part-3
relatedPaths:
- iam-002
- iam-006
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-createloginprofile"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-CreateLoginProfile
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamcreateloginprofile-privesc/
    scenarioPricingModel: paid
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/iam_edges.py#L81
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L120
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L290
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L103
attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with iam:CreateLoginProfile permission on the target user. Can be an IAM user or role with permission to create console login profiles for other users.

    - id: target_user
      label: Existing target-user
      type: resource
      description: |
        The target IAM user for whom the console login profile is created. Must NOT currently have a login profile (AWS does not allow multiple profiles per user). Once the profile is created, the attacker can login to the AWS Console as this user with the password they set.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        Full administrative access to the AWS account when the target user has AdministratorAccess or equivalent permissions.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The target user has some elevated permissions. Check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - id: no_access
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The target user has no interesting permissions beyond what the starting principal already had.

  edges:
    - from: start
      to: target_user
      label: iam:CreateLoginProfile
      description: |
        Execute iam:CreateLoginProfile to create a console login profile with a password of your choosing for the target user. The target user must not currently have a login profile. Once created, login to the AWS Console using the target user's username and your chosen password to authenticate as the target user.

        Command: `aws iam create-login-profile --user-name @username --password @password`

    - from: target_user
      to: admin
      label: If user has admin permissions
      branch: A
      condition: admin
      description: |
        If the target user has AdministratorAccess or equivalent permissions, the attacker gains full administrative access to the account via the AWS Console.

    - from: target_user
      to: some_perms
      label: If user has some permissions
      branch: B
      condition: some_permissions
      description: |
        If the target user has some elevated permissions, check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - from: target_user
      to: no_access
      label: If user has no interesting permissions
      branch: C
      condition: no_permissions
      description: |
        If the target user only has minimal permissions, there may be no meaningful privilege escalation achieved.
permissions:
  required:
  - permission: iam:CreateLoginProfile
    resourceConstraints: Target IAM user must be in the Resource section
  additional:
  - permission: iam:ListUsers
    resourceConstraints: Helpful for discovering target users
  - permission: iam:GetUser
    resourceConstraints: Useful for viewing user details
