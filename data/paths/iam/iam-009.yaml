id: iam-009
name: iam:AttachRolePolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:AttachRolePolicy` can attach managed policies
  to any role they have this permission on. This permission is frequently exploited
  by a principal to grant themselves additional privileges. A principal can also leverage
  this to escalate the permissions of another principal they can access.
prerequisites:
- A managed IAM policy with elevated privileges must exist in the account
- Principal must be a role (not a user)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam attach-role-policy --role-name @rolename --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    description: Attach the AdministratorAccess managed policy to the target role
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: 'Restrict access to `iam:AttachRolePolicy` using the principle of
  least privilege. Very few

  principals need this permission, so it should be restricted to only the few principals

  that need it. Monitor use of this sensitive permission using CloudSIEM detections,

  and look for usage anomalies.

  '
limitations: 'This path provides administrative access only if an administrative managed
  policy (e.g., AdministratorAccess) exists in the AWS account. If only limited managed
  policies are available, the attacker gains access limited to those permissions.
  However, even limited privilege escalation may enable multi-hop attacks or access
  to sensitive data.

  '
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamattachrolepolicy--stsassumeroleiamcreaterole--iamputuserpolicy--iamputgrouppolicy--iamputrolepolicy
- title: HackingTheCloud - AttachRolePolicy Privilege Escalation
  url: https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/#iamattachrolepolicy
- title: Well, That Escalated Quickly - Privesc 09
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- iam-005
- iam-008
- iam-011
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/7f82e7ab0a1a714d20a69b1d0b892e4702754e6b/cloudsplaining/shared/constants.py#L121
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/50e7ad2d885b7ab4bc130f44b798ca85ed4d7a91/pacu/modules/iam__privesc_scan/main.py#L176
  prowler: https://github.com/prowler-cloud/prowler/blob/49c75cc4180e2304747d8fe4bd1b16dd38929d07/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L91
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-self-escalation/to-admin/iam-attachrolepolicy
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-AttachRolePolicy
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
  cybr:
    type: closed-source
    description: Hosted learning environment with interactive AWS security labs
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamattachrolepolicy-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
  - id: start
    label: starting-role
    type: principal
    description: 'The IAM role with iam:AttachRolePolicy permission on itself. The
      role can attach any managed policy to itself, including policies with full administrative
      access like AdministratorAccess.

      '
  - id: admin
    label: Effective Administrator
    type: outcome
    description: 'The attached managed policy takes effect immediately. The starting
      role now has all permissions specified in the attached policy, including full
      administrative access if AdministratorAccess or an equivalent managed policy
      was attached.

      '
  edges:
  - from: start
    to: admin
    label: iam:AttachRolePolicy
    description: 'Execute iam:AttachRolePolicy to attach a managed policy with administrative
      permissions to the role itself. The policy takes effect immediately and grants
      the role any permissions specified in the managed policy.


      Command:

      ```bash

      aws iam attach-role-policy --role-name @rolename --policy-arn arn:aws:iam::aws:policy/AdministratorAccess

      ```


      The role immediately gains all permissions from the attached managed policy.
      Common targets include:

      - arn:aws:iam::aws:policy/AdministratorAccess (full admin access)

      - arn:aws:iam::aws:policy/IAMFullAccess (full IAM permissions)

      - Any custom managed policy with elevated permissions

      '
permissions:
  required:
  - permission: iam:AttachRolePolicy
    resourceConstraints: Target role must be in the Resource section. For self-escalation,
      must have permission on own role.
