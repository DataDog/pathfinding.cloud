id: iam-009
name: iam:AttachRolePolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:AttachRolePolicy` can attach managed policies to any role they have this permission
  on. This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also
  leverage this to escalate the permissions of another principal they can access.
prerequisites:
- A managed IAM policy with elevated privileges must exist in the account
- Principal must be a role (not a user)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam attach-role-policy --role-name @rolename --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    description: Attach the AdministratorAccess managed policy to the target role
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:AttachRolePolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-005
- iam-008
- iam-011
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
toolSupport:
  pmapper: true
  iamVulnerable: true
attackVisualization:
  nodes:
    - id: start
      label: starting-role
      type: principal
      description: |
        The IAM role with iam:AttachRolePolicy permission on itself. The role can attach any managed policy to itself, including policies with full administrative access like AdministratorAccess.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The attached managed policy takes effect immediately. The starting role now has all permissions specified in the attached policy, including full administrative access if AdministratorAccess or an equivalent managed policy was attached.

  edges:
    - from: start
      to: admin
      label: iam:AttachRolePolicy
      description: |
        Execute iam:AttachRolePolicy to attach a managed policy with administrative permissions to the role itself. The policy takes effect immediately and grants the role any permissions specified in the managed policy.

        Command:
        ```bash
        aws iam attach-role-policy --role-name @rolename --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
        ```

        The role immediately gains all permissions from the attached managed policy. Common targets include:
        - arn:aws:iam::aws:policy/AdministratorAccess (full admin access)
        - arn:aws:iam::aws:policy/IAMFullAccess (full IAM permissions)
        - Any custom managed policy with elevated permissions
permissions:
  required:
  - permission: iam:AttachRolePolicy
    resourceConstraints: Target role must be in the Resource section. For self-escalation, must have permission on own role.
