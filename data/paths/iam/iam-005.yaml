id: iam-005
name: iam:PutRolePolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:PutRolePolicy` can attach inline policies to any role they have this permission on.
  This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also leverage
  this to escalate the permissions of another principal they can access.
prerequisites:
- Principal must be a role (not a user)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam put-role-policy --role-name @rolename --policy-name @policyname --policy-document file://escalation_policy.json
    description: Attach an inline policy with elevated permissions to the target role
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:PutRolePolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamattachrolepolicy--stsassumeroleiamcreaterole--iamputuserpolicy--iamputgrouppolicy--iamputrolepolicy
- title: Well, That Escalated Quickly - Privesc 12
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- iam-007
- iam-009
- iam-011
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L159
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L288
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L76
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-self-escalation/to-admin/iam-putrolepolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-PutRolePolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamputrolepolicy-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
    - id: start
      label: starting-role
      type: principal
      description: |
        The IAM role with iam:PutRolePolicy permission on itself. The role can attach an inline policy to itself with any permissions, including full administrative access.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The inline policy takes effect immediately. The starting role now has all permissions specified in the new inline policy, including full administrative access if that was included.

  edges:
    - from: start
      to: admin
      label: iam:PutRolePolicy
      description: |
        Execute iam:PutRolePolicy to attach an inline policy with administrative permissions to the role itself. The new inline policy takes effect immediately and grants the role any permissions specified in the policy document.

        Command:
        ```bash
        aws iam put-role-policy --role-name @rolename --policy-name @policyname --policy-document file://escalation_policy.json
        ```

        The role immediately gains all permissions in the policy document, including full administrative access if AdministratorAccess or equivalent permissions were included.
permissions:
  required:
  - permission: iam:PutRolePolicy
    resourceConstraints: Target role must be in the Resource section. For self-escalation, must have permission on own role.
