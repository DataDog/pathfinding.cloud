id: iam-010
name: iam:AttachGroupPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:AttachGroupPolicy` can attach managed policies to any group they have this permission
  on. This permission is frequently exploited by a principal to grant themselves additional privileges by attaching policies
  to a group they are a member of. A principal can also leverage this to escalate the permissions of other principals in the
  same group.
prerequisites:
- Principal must be a user (not a role)
- Principal must be a member of the target group
- A managed IAM policy with elevated privileges must exist in the account
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam attach-group-policy --group-name @groupname --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
    description: Attach the AdministratorAccess managed policy to the group
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active
recommendation: |
  Restrict access to `iam:AttachGroupPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamattachuserpolicy--iamattachgrouppolicy
- title: Well, That Escalated Quickly - Privesc 08
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- iam-008
- iam-011
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L155
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L432
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L74
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-self-escalation/to-admin/iam-attachgrouppolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-AttachGroupPolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/iamattachgrouppolicy-solution/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
    - id: start
      label: starting-user
      type: principal
      description: |
        The IAM user initiating the attack. Must be a member of the target group and have iam:AttachGroupPolicy permission on that group. This attack path requires a user (not a role) because group membership only applies to IAM users.

    - id: target_group
      label: Existing target-group
      type: resource
      description: |
        The IAM group that the starting user is a member of. The user must have iam:AttachGroupPolicy permission on this specific group resource. Once an admin policy is attached to this group, all members of the group (including the attacker) inherit those permissions.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        After attaching an administrative managed policy (such as AdministratorAccess) to the group, the starting user immediately gains full administrative access to the AWS account. All group members inherit the attached policy's permissions.

  edges:
    - from: start
      to: target_group
      label: Member of group
      description: |
        The starting user must be a member of the target group. This is a prerequisite for the attack to work, as IAM permissions granted to groups are automatically inherited by all member users.

    - from: target_group
      to: admin
      label: iam:AttachGroupPolicy
      description: |
        Execute the iam:AttachGroupPolicy API call to attach an administrative managed policy to the group. The AdministratorAccess policy is the most common choice, but any managed policy with elevated privileges can be used.

        Command:
        ```bash
        aws iam attach-group-policy \
          --group-name @groupname \
          --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
        ```

        The policy attachment takes effect immediately. All users in the group (including the attacker) now have the permissions granted by the attached policy. Verify with: `aws sts get-caller-identity` followed by testing an admin action.
permissions:
  required:
  - permission: iam:AttachGroupPolicy
    resourceConstraints: Target group must be in the Resource section. For self-escalation, must have permission on a group
      the principal belongs to.
