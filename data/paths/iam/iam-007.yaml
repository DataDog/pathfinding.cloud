id: iam-007
name: iam:PutUserPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:PutUserPolicy` can attach inline policies to any user they have this permission on.
  This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also leverage
  this to escalate the permissions of another principal they can access.
prerequisites:
- Principal must be a user (not a role)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam put-user-policy --user-name @username --policy-name @policyname --policy-document file://escalation_policy.json
    description: Attach an inline policy with elevated permissions to the target user
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:PutUserPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-001
- iam-005
- iam-008
- iam-010
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
toolSupport:
  pmapper: true
  iamVulnerable: true
permissions:
  required:
  - permission: iam:PutUserPolicy
    resourceConstraints: Target user must be in the Resource section. For self-escalation, must have permission on own user.
