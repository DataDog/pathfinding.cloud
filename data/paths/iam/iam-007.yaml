id: iam-007
name: iam:PutUserPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:PutUserPolicy` can attach inline policies to any user they have this permission on.
  This permission is frequently exploited by a principal to grant themselves additional privileges. A principal can also leverage
  this to escalate the permissions of another principal they can access.
prerequisites:
- Principal must be a user (not a role)
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam put-user-policy --user-name @username --policy-name @policyname --policy-document file://escalation_policy.json
    description: Attach an inline policy with elevated permissions to the target user
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active (for self-escalation)
recommendation: |
  Restrict access to `iam:PutUserPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-001
- iam-005
- iam-008
- iam-010
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L127
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L522-L525
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L109
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-self-escalation/to-admin/iam-putuserpolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-PutUserPolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamputuserpolicy-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
    - id: start
      label: starting-user
      type: principal
      description: |
        The IAM user with iam:PutUserPolicy permission on itself. The user can attach an inline policy to itself with any permissions, including full administrative access.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The inline policy takes effect immediately. The starting user now has all permissions specified in the new inline policy, including full administrative access if that was included.

  edges:
    - from: start
      to: admin
      label: iam:PutUserPolicy
      description: |
        Execute iam:PutUserPolicy to attach an inline policy with administrative permissions to the user itself. The new inline policy takes effect immediately and grants the user any permissions specified in the policy document.

        Command:
        ```bash
        aws iam put-user-policy --user-name @username --policy-name @policyname --policy-document file://escalation_policy.json
        ```

        The user immediately gains all permissions in the policy document, including full administrative access if AdministratorAccess or equivalent permissions were included.
permissions:
  required:
  - permission: iam:PutUserPolicy
    resourceConstraints: Target user must be in the Resource section. For self-escalation, must have permission on own user.
