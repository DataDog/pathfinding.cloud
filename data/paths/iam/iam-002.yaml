id: iam-002
name: iam:CreateAccessKey
category: lateral-movement
services:
- iam
description: Anyone with access to `iam:CreateAccessKey` can create access keys for any user they have this permission on.
  This permission is often abused by one principal to gain access to another principal and the permissions associated with
  that principal.
prerequisites:
  admin:
  - Target user must have fewer than 2 access keys already
  - Target user must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - Target user must have fewer than 2 access keys already
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam create-access-key --user-name @username
    description: Create a new access key for the target user
  - step: 2
    command: aws configure --profile target-user
    description: Configure AWS CLI with the newly created access key
  - step: 3
    command: aws sts get-caller-identity --profile target-user
    description: Verify access as the target user
  pacu:
  - step: 1
    command: run iam__enum_users_roles_policies_groups
    description: Enumerate IAM users to find target with fewer than 2 keys
  - step: 2
    command: run iam__create_access_key --user-name @username
    description: Create access key for target user and automatically configure profile
recommendation: |
  Restrict access to `iam:CreateAccessKey` using the principle of least privilege. Only allow
  users to create access keys for themselves or users they are authorized to manage. Very few
  principals need this permission on anyone other than themselves, so it should be restricted
  to only the few principals that need it.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
relatedPaths:
- iam-003
- iam-004
- iam-006
learningEnvironments:
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-CreateAccessKey
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
attackVisualization:
  nodes:
    - id: start
      label: starting-principal
      type: principal
      description: |
        The principal with iam:CreateAccessKey permission on the target user. Can be an IAM user or role with permission to create access keys for other users.

    - id: target_user
      label: target-user
      type: resource
      description: |
        The target IAM user for whom the access key is created. Must have fewer than 2 existing access keys (AWS limit). The attacker gains access to all permissions attached to this user.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        Full administrative access to the AWS account when the target user has AdministratorAccess or equivalent permissions.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The target user has some elevated permissions. Check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - id: no_access
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The target user has no interesting permissions beyond what the starting principal already had.

  edges:
    - from: start
      to: target_user
      label: iam:CreateAccessKey
      description: |
        Execute iam:CreateAccessKey to generate a new access key for the target user. The API returns both the AccessKeyId and SecretAccessKey in the response. Configure the AWS CLI with these credentials to authenticate as the target user.

        Command: `aws iam create-access-key --user-name @username`

    - from: target_user
      to: admin
      label: If user has admin permissions
      branch: A
      condition: admin
      description: |
        If the target user has AdministratorAccess or equivalent permissions, the attacker gains full administrative access to the account.

    - from: target_user
      to: some_perms
      label: If user has some permissions
      branch: B
      condition: some_permissions
      description: |
        If the target user has some elevated permissions, check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

    - from: target_user
      to: no_access
      label: If user has no interesting permissions
      branch: C
      condition: no_permissions
      description: |
        If the target user only has minimal permissions, there may be no meaningful privilege escalation achieved.
permissions:
  required:
  - permission: iam:CreateAccessKey
    resourceConstraints: Target IAM user must be in the Resource section
  additional:
  - permission: iam:ListUsers
    resourceConstraints: Helpful for discovering target users
  - permission: iam:GetUser
    resourceConstraints: Useful for viewing user details
