id: iam-002
name: iam:CreateAccessKey
category: principal-access
services:
- iam
description: Anyone with access to `iam:CreateAccessKey` can create access keys for
  any user they have this permission on. This permission is often abused by one principal
  to gain access to another principal and the permissions associated with that principal.
prerequisites:
  admin:
  - Target user must have fewer than 2 access keys already
  - Target user must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - Target user must have fewer than 2 access keys already
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam create-access-key --user-name @username
    description: Create a new access key for the target user
  - step: 2
    command: aws configure --profile target-user
    description: Configure AWS CLI with the newly created access key
  - step: 3
    command: aws sts get-caller-identity --profile target-user
    description: Verify access as the target user
  pacu:
  - step: 1
    command: run iam__enum_users_roles_policies_groups
    description: Enumerate IAM users to find target with fewer than 2 keys
  - step: 2
    command: run iam__backdoor_users_keys --usernames [TARGET_USER]
    description: Create access key for target user
recommendation: 'Restrict access to `iam:CreateAccessKey` using the principle of least
  privilege. Only allow

  users to create access keys for themselves or users they are authorized to manage.
  Very few

  principals need this permission on anyone other than themselves, so it should be
  restricted

  to only the few principals that need it.

  '
limitations: 'This path provides administrative access only if the target user or
  group has administrative permissions. The attacker gains whatever permissions the
  target principal has. If the target has limited permissions, the attacker gains
  limited access. However, even limited access may enable multi-hop attacks or access
  to sensitive data.

  '
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamcreateaccesskey
- title: HackingTheCloud - CreateAccessKey Privilege Escalation
  url: https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/#iamcreateaccesskey
- title: Well, That Escalated Quickly - Privesc 04
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
- title: s3cur3.it IAMVulnerable - Part 3
  url: https://s3cur3.it/home/practicing-aws-security-with-iamvulnerable-part-3
relatedPaths:
- iam-003
- iam-004
- iam-006
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/iam_edges.py#L70
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/7f82e7ab0a1a714d20a69b1d0b892e4702754e6b/cloudsplaining/shared/constants.py#L112
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/50e7ad2d885b7ab4bc130f44b798ca85ed4d7a91/pacu/modules/iam__privesc_scan/main.py#L218
  prowler: https://github.com/prowler-cloud/prowler/blob/49c75cc4180e2304747d8fe4bd1b16dd38929d07/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L86
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/iam-createaccesskey
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-CreateAccessKey
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: iam_privesc_by_key_rotation
    description: Deploy vulnerable infrastructure using CloudGoat to practice AWS
      attacks
  cybr:
    type: closed-source
    description: Hosted learning environment with interactive AWS security labs
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamcreateaccesskey-privesc/
    scenarioPricingModel: paid
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The principal with iam:CreateAccessKey permission on the target
      user. Can be an IAM user or role with permission to create access keys for other
      users.

      '
  - id: target_user
    label: Existing target-user
    type: principal
    description: 'The target IAM user for whom the access key is created. Must have
      fewer than 2 existing access keys (AWS limit). The attacker gains access to
      all permissions attached to this user.

      '
  - id: admin
    label: Effective Administrator
    type: outcome
    description: 'Full administrative access to the AWS account when the target user
      has AdministratorAccess or equivalent permissions.

      '
  - id: some_perms
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: 'The target user has some elevated permissions. Check for data access
      (S3, RDS, DynamoDB) or additional privilege escalation paths.

      '
  - id: no_access
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: 'The target user has no interesting permissions beyond what the starting
      principal already had.

      '
  edges:
  - from: start
    to: target_user
    label: iam:CreateAccessKey
    description: 'Execute iam:CreateAccessKey to generate a new access key for the
      target user. The API returns both the AccessKeyId and SecretAccessKey in the
      response. Configure the AWS CLI with these credentials to authenticate as the
      target user.


      Command: `aws iam create-access-key --user-name @username`

      '
  - from: target_user
    to: admin
    label: If user has admin permissions
    branch: A
    condition: admin
    description: 'If the target user has AdministratorAccess or equivalent permissions,
      the attacker gains full administrative access to the account.

      '
  - from: target_user
    to: some_perms
    label: If user has some permissions
    branch: B
    condition: some_permissions
    description: 'If the target user has some elevated permissions, check for data
      access (S3, RDS, DynamoDB) or additional privilege escalation paths.

      '
  - from: target_user
    to: no_access
    label: If user has no interesting permissions
    branch: C
    condition: no_permissions
    description: 'If the target user only has minimal permissions, there may be no
      meaningful privilege escalation achieved.

      '
permissions:
  required:
  - permission: iam:CreateAccessKey
    resourceConstraints: Target IAM user must be in the Resource section
  additional:
  - permission: iam:ListUsers
    resourceConstraints: Helpful for discovering target users
  - permission: iam:GetUser
    resourceConstraints: Useful for viewing user details
