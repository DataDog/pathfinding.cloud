id: iam-011
name: iam:PutGroupPolicy
category: self-escalation
services:
- iam
description: Anyone with access to `iam:PutGroupPolicy` can attach inline policies to any group they have this permission
  on. This permission is often abused by one principal to grant additional permissions to themselves by attaching an inline
  policy to a group they are a member of.
prerequisites:
- Principal must be a user (not a role)
- Principal must be a member of the target group
exploitationSteps:
  awscli:
  - step: 1
    command: aws iam put-group-policy --group-name @groupname --policy-name @policyname --policy-document file://escalation_policy.json
    description: Attach an inline policy with elevated permissions to the group
  - step: 2
    command: aws sts get-caller-identity
    description: Verify the new permissions are active
recommendation: |
  Restrict access to `iam:PutGroupPolicy` using the principle of least privilege. Very few
  principals need this permission, so it should be restricted to only the few principals
  that need it. Monitor use of this sensitive permission using CloudSIEM detections,
  and look for usage anomalies.
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - IAM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-iam-privesc/index.html#iamattachrolepolicy--stsassumeroleiamcreaterole--iamputuserpolicy--iamputgrouppolicy--iamputrolepolicy
- title: Well, That Escalated Quickly - Privesc 11
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws
relatedPaths:
- iam-005
- iam-007
- iam-010
detectionTools:
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L136
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L1261
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L106
detectionRules:
- platform: CloudSIEM
  url: https://docs.datadoghq.com/security/default_rules/7b6-2a8-df9/
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-self-escalation/to-admin/iam-putgrouppolicy"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: IAM-PutGroupPolicy
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cybr:
    type: closed-source
    description: "Hosted learning environment with interactive AWS security labs"
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/lessons/lab-ctf-iamputgrouppolicy-privesc/
    scenarioPricingModel: free
attackVisualization:
  nodes:
    - id: start
      label: starting-user
      type: principal
      description: |
        The IAM user initiating the attack. Must be a member of a target group and have iam:PutGroupPolicy permission on that group. This attack only works for IAM users since roles cannot be members of groups.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The inline policy is immediately applied to all members of the group, including the starting user. The user gains all permissions specified in the new inline policy, including full administrative access if that was included.

  edges:
    - from: start
      to: admin
      label: iam:PutGroupPolicy
      description: |
        Execute the iam:PutGroupPolicy API call to attach an inline policy with administrative permissions to a group that the starting user is a member of.

        Example command:
        ```bash
        aws iam put-group-policy \
          --group-name @groupname \
          --policy-name @policyname \
          --policy-document file://escalation_policy.json
        ```

        The inline policy is immediately applied to the group. All members of the group (including the attacker) now have the permissions specified in the new policy. The user can verify their new permissions with `aws sts get-caller-identity` or by attempting to use the new permissions.
permissions:
  required:
  - permission: iam:PutGroupPolicy
    resourceConstraints: Target group must be in the Resource section. For self-escalation, must have permission on a group
      the principal belongs to.
