id: sts-001
name: sts:AssumeRole
category: lateral-movement
services:
- sts
description: A principal with `sts:AssumeRole` permission can assume IAM roles that trust them in their trust policy. If a
  role with elevated permissions has a trust policy that allows the attacker's principal to assume it, they can gain those
  elevated permissions by assuming the role. This is one of the most straightforward privilege escalation paths when misconfigured
  trust relationships exist.
prerequisites:
  admin:
  - A role must exist with administrative permissions (e.g., AdministratorAccess)
  - The role's trust policy must allow the attacker's principal (user/role) to assume it
  lateral:
  - A role must exist with elevated permissions
  - The role's trust policy must allow the attacker's principal (user/role) to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws sts get-caller-identity
    description: Verify current identity before privilege escalation
  - step: 2
    command: aws iam list-roles --query 'Roles[*].[RoleName,Arn]' --output table
    description: List available roles to find targets with elevated permissions (optional but helpful for discovery)
  - step: 3
    command: aws iam get-role --role-name TARGET_ROLE
    description: Check the role's trust policy to confirm the attacker can assume it, and view attached policies (optional)
  - step: 4
    command: |
      aws sts assume-role \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/TARGET_ROLE \
        --role-session-name privesc-session
    description: Assume the privileged role to obtain temporary credentials with elevated permissions
  - step: 5
    command: |
      export AWS_ACCESS_KEY_ID=<AccessKeyId from step 4>
      export AWS_SECRET_ACCESS_KEY=<SecretAccessKey from step 4>
      export AWS_SESSION_TOKEN=<SessionToken from step 4>
    description: Configure the AWS CLI to use the assumed role credentials
  - step: 6
    command: aws sts get-caller-identity
    description: Verify the assumed role identity
  - step: 7
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained
  pacu:
  - step: 1
    command: run iam__enum_permissions
    description: Enumerate IAM permissions and identify assumable roles
  - step: 2
    command: run iam__assume_role --role-arn arn:aws:iam::ACCOUNT_ID:role/TARGET_ROLE
    description: Assume the privileged role using Pacu
recommendation: |
  Carefully audit IAM role trust policies to ensure they follow the principle of least privilege.
  Only allow trusted principals to assume sensitive roles.

  Example restrictive trust policy:
  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": {
          "AWS": "arn:aws:iam::ACCOUNT_ID:role/SpecificTrustedRole"
        },
        "Action": "sts:AssumeRole",
        "Condition": {
          "StringEquals": {
            "sts:ExternalId": "unique-external-id"
          },
          "IpAddress": {
            "aws:SourceIp": "203.0.113.0/24"
          }
        }
      }
    ]
  }
  ```

  Additional controls:
  - **Require MFA**: Require MFA for sensitive role assumptions using `aws:MultiFactorAuthPresent` condition
  - **Use External IDs**: Use external IDs for cross-account role assumptions to prevent confused deputy attacks
  - **IP Address Restrictions**: Implement IP address restrictions in trust policies using `aws:SourceIp` condition
  - **Session Policies**: Implement session policies to limit permissions even when assuming privileged roles, providing an additional layer of defense
  - **Monitor CloudTrail**: Alert on `AssumeRole` events on privileged roles, especially from unexpected principals
  - **IAM Access Analyzer**: Regularly audit role trust policies with AWS IAM Access Analyzer to identify overly permissive trust relationships
  - **Alert on Patterns**: Alert on unusual assume-role patterns or assumptions from unexpected IP addresses
  - **Service Control Policies**: Use SCPs to restrict which roles can be assumed at the organizational level
  - **AWS Config Rules**: Use AWS Config rules to detect roles with administrative permissions that can be assumed by users or have overly permissive trust policies
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - AssumeRole
  url: https://github.com/BishopFox/iam-vulnerable
relatedPaths:
- iam-002
- iam-003
- iam-004
toolSupport:
  pmapper: true
  iamVulnerable: true
  pacu: true
attackVisualization:
  nodes:
    - id: start
      label: starting-principal
      type: principal
      description: |
        The principal initiating the attack. Can be an IAM user or role with sts:AssumeRole permission on the target role.

    - id: target_role
      label: target-role
      type: resource
      description: |
        The privileged role being assumed. Must have a trust policy that allows the starting principal to assume it.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        Full administrative access to the AWS account when the target role has AdministratorAccess or equivalent permissions.

    - id: no_access
      label: No Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The assumed role has no interesting permissions beyond what the starting principal already had.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The assumed role has some permissions. Check for data access (S3, RDS, DynamoDB) or additional privilege escalation paths.

  edges:
    - from: start
      to: target_role
      label: sts:AssumeRole
      description: |
        Use sts:AssumeRole to assume the target role. Requires both the permission and a matching trust policy on the role.

    - from: target_role
      to: admin
      label: If role has admin permissions
      branch: A
      condition: admin
      description: |
        If the target role has AdministratorAccess or equivalent permissions, the attacker gains full administrative access to the account.

    - from: target_role
      to: no_access
      label: If role has no interesting permissions
      branch: B
      condition: no_permissions
      description: |
        If the role only has minimal permissions (like logs:PutLogEvents), there may be no additional access gained.

    - from: target_role
      to: some_perms
      label: If role has some permissions
      branch: C
      condition: some_permissions
      description: |
        If the role has permissions to access data or enable other escalation paths, further exploration is needed.
permissions:
  required:
  - permission: sts:AssumeRole
    resourceConstraints: Target role ARN must be in the Resource section and the role's trust policy must allow the principal
      to assume it
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to assume
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
