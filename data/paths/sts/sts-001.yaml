id: sts-001
name: sts:AssumeRole
category: principal-access
services:
- sts
description: A principal with `sts:AssumeRole` permission can assume IAM roles that
  trust them in their trust policy. We refer to this as two-way trust, or bidirectional
  trust. Direction 1 is the forward trust - the starting principal that has `sts:AssumeRole`
  permission on one or more roles. Direction 2 is the reverse trust - the target role
  must trust the starting principal to assume it. It's important to remember that
  if the target role trusts the account `root`, like this `arn:aws:iam::012345678901:root`,
  this trust extends to all principals in the account and satisfies direction 2. If
  this bidirectional trust is in place, the starting principal can assume the target
  role gain access to any elevated permissions by assuming the target role. However
  there is an edge case, noted in the prerequisites below. If the target role's trust
  policy trusts the starting principal explicitly, e.g, `arn:aws:iam::012345678901:user/startUser`,
  and that principal is in the same account as the target role, that principal does
  not need `sts:AssumeRole` permission. They just can assume the  role without any
  permissions.
prerequisites:
  admin:
  - A role must exist with administrative permissions (e.g., AdministratorAccess)
  - The role's trust policy must allow the attacker's principal (user/role) to assume
    it
  - If the role trusts the account root, e.g., `arn:aws:iam::012345678901:root`, any
    principal with `sts:AssumeRole` permission on the target role can assume it
  - If the role trusts the starting principal explicitly, e.g, `arn:aws:iam::012345678901:user/startUser`,
    and that principal is in the same account as the target role, that principal does
    not need `sts:AssumeRole` permission. They just can assume the  role without any
    permissions.t as the target role, that principal does not need `sts:AssumeRole`
    permission. They just can assume the  role without any permissions.
  lateral:
  - The role's trust policy must allow the attacker's principal (user/role) to assume
    it
  - If the role trusts the account root, e.g., `arn:aws:iam::012345678901:root`, any
    principal with `sts:AssumeRole` permission on the target role can assume it
  - If the role trusts the starting principal explicitly, e.g, `arn:aws:iam::012345678901:user/startUser`,
    and that principal is in the same account as the target role, that principal does
    not need `sts:AssumeRole` permission. They just can assume the  role without any
    permissions.
exploitationSteps:
  awscli:
  - step: 1
    command: aws sts get-caller-identity
    description: Verify current identity before privilege escalation
  - step: 2
    command: aws iam list-roles --query 'Roles[*].[RoleName,Arn]' --output table
    description: List available roles to find targets with elevated permissions (optional
      but helpful for discovery)
  - step: 3
    command: aws iam get-role --role-name TARGET_ROLE
    description: Check the role's trust policy to confirm the attacker can assume
      it, and view attached policies (optional)
  - step: 4
    command: "aws sts assume-role \\\n  --role-arn arn:aws:iam::ACCOUNT_ID:role/TARGET_ROLE\
      \ \\\n  --role-session-name privesc-session\n"
    description: Assume the privileged role to obtain temporary credentials with elevated
      permissions
  - step: 5
    command: "export AWS_ACCESS_KEY_ID=<AccessKeyId from step 4>\n export AWS_SECRET_ACCESS_KEY=<SecretAccessKey\
      \ from step 4>\n export AWS_SESSION_TOKEN=<SessionToken from step 4>\n"
    description: Configure the AWS CLI to use the assumed role credentials
  - step: 6
    command: aws sts get-caller-identity
    description: Verify the assumed role identity
  - step: 7
    command: aws iam list-users --max-items 3
    description: Verify administrative access was successfully obtained
recommendation: "- Avoiding using the account root notation (`arn:aws:iam::012345678901:root`)\
  \ for internal accounts. This is fine to use with external accounts along with the\
  \ externalID field, but is almost always overly permissive when used for internal\
  \ AWS accounts. \n- Only allow trusted principals to assume sensitive roles. Use\
  \ conditions when possible.  \n\nExample restrictive trust policy:\n```json\n{\n\
  \  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"\
  Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::ACCOUNT_ID:role/SpecificTrustedRole\"\
  \n      },\n      \"Action\": \"sts:AssumeRole\",\n      \"Condition\": {      \
  \    \n        \"IpAddress\": {\n          \"aws:SourceIp\": \"1.2.3.0/24\"\n  \
  \      }\n      }\n    }\n  ]\n}\n```\n\nAdditional controls:\n- **Require MFA**:\
  \ Require MFA for sensitive role assumptions using `aws:MultiFactorAuthPresent`\
  \ condition\n- **Use External IDs**: Use external IDs for third-party cross-account\
  \ role assumptions to prevent confused deputy attacks\n- **IP Address Restrictions**:\
  \ Implement IP address restrictions in trust policies using `aws:SourceIp` condition\
  \ when possible. \n- **Session Policies**: Implement session policies to limit permissions\
  \ even when assuming privileged roles, providing an additional layer of defense\n\
  - **Monitor CloudTrail**: Alert on `AssumeRole` events on privileged roles, especially\
  \ from unexpected principals\n- **Alert on Patterns**: Alert on unusual assume-role\
  \ patterns or assumptions from unexpected IP addresses \n"
limitations: 'This path provides administrative access only if a role exists with
  administrative permissions that trusts the starting principal to assume it. The
  attacker gains whatever permissions the assumed role has. If only limited roles
  are available that trust the principal, the attacker gains limited access. However,
  even limited access may enable multi-hop attacks or access to sensitive data.

  '
discoveryAttribution:
  firstDocumented:
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2018
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: HackTricks - AWS - STS Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-sts-privesc/index.html#stsassumerole
- title: IAM Vulnerable - AssumeRole
  url: https://github.com/BishopFox/iam-vulnerable
- title: AWS IAM privilege escalation paths
  url: https://pswalia2u.medium.com/aws-iam-privilege-escalation-paths-cba36be1aa9e
relatedPaths:
- iam-002
- iam-003
- iam-004
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/sts_edges.py#L73
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/sts-assumerole
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: STS-AssumeRole
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: lambda_privesc
    description: Deploy vulnerable infrastructure using CloudGoat to practice AWS
      attacks
  cybr:
    type: closed-source
    description: Hosted learning environment with interactive AWS security labs
    scenario: https://cybr.com/courses/iam-privilege-escalation-labs/
    scenarioPricingModel: paid
  pwnedlabs:
    type: closed-source
    description: Hosted cloud security labs with AWS privilege escalation scenarios
    scenario: https://labs.pwnedlabs.io/demo-breach-in-the-cloud
    scenarioPricingModel: paid
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The principal initiating the attack. Can be an IAM user or role
      with sts:AssumeRole permission on the target role.

      '
  - id: target_role
    label: Existing Target Role
    type: principal
    description: 'The privileged role being assumed. Must have a trust policy that
      allows the starting principal to assume it.

      '
  - id: admin
    label: Effective Administrator
    type: outcome
    description: 'Full administrative access to the AWS account when the target role
      has AdministratorAccess or equivalent permissions.

      '
  - id: no_access
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: 'The assumed role has no interesting permissions beyond what the
      starting principal already had.

      '
  - id: some_perms
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: 'The assumed role has some permissions. Check for data access (S3,
      RDS, DynamoDB) or additional privilege escalation paths.

      '
  edges:
  - from: start
    to: target_role
    label: sts:AssumeRole
    description: 'Use sts:AssumeRole to assume the target role. Requires both the
      permission and a matching trust policy on the role.

      '
  - from: target_role
    to: admin
    label: If role has admin permissions
    branch: A
    condition: admin
    description: 'If the target role has AdministratorAccess or equivalent permissions,
      the attacker gains full administrative access to the account.

      '
  - from: target_role
    to: no_access
    label: If role has no interesting permissions
    branch: B
    condition: no_permissions
    description: 'If the role only has minimal permissions (like logs:PutLogEvents),
      there may be no additional access gained.

      '
  - from: target_role
    to: some_perms
    label: If role has some permissions
    branch: C
    condition: some_permissions
    description: 'If the role has permissions to access data or enable other escalation
      paths, further exploration is needed.

      '
permissions:
  required:
  - permission: sts:AssumeRole
    resourceConstraints: Target role ARN must be in the Resource section and the role's
      trust policy must allow the principal to assume it
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to assume
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
