id: cloudformation-001
name: iam:PassRole + cloudformation:CreateStack
category: service-passrole
services:
- iam
- cloudformation
description: A principal with `iam:PassRole` and `cloudformation:CreateStack` can launch a CloudFormation template that creates
  AWS resources. The template executes with the permissions of the passed IAM role. This allows creation of resources controlled
  by the attacker, such as IAM users, Lambda functions, or EC2 instances. The level of access gained depends on the permissions
  of the available roles.
prerequisites:
  admin:
  - A role must exist that trusts cloudformation.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - A role must exist that trusts cloudformation.amazonaws.com to assume it
exploitationSteps:
  awscli:
  - step: 1
    command: aws cloudformation create-stack --stack-name privesc-stack --template-body file://exploit-template.yaml --capabilities
      CAPABILITY_IAM --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE
    description: Create a CloudFormation stack with a template that creates privileged resources
  - step: 2
    command: aws cloudformation describe-stacks --stack-name privesc-stack
    description: Monitor stack creation progress
  - step: 3
    command: '# Access the newly created resources (e.g., IAM user, Lambda function)'
    description: Use the elevated privileges of the created resources
  pacu:
  - step: 1
    command: run cloudformation__create_stack --stack-name privesc-stack --template exploit-template.yaml --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE
    description: Use Pacu to create CloudFormation stack with privileged role
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "`iam:PassRole`",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificCFNRole",
    "Condition": {
      "StringEquals": {
        "`iam:PassedToService`": "cloudformation.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - Restrict `cloudformation:CreateStack` to specific stack name patterns or templates
  - Use CloudFormation service roles with minimal required permissions
  - Enable CloudFormation stack policies to prevent unauthorized modifications
  - Monitor CloudTrail for CloudFormation stack creation and the resources they provision
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - PassExistingRoleToCloudFormation
  url: https://github.com/BishopFox/iam-vulnerable/blob/main/modules/free-resources/privesc-paths/privesc20-PassExistingRoleToCloudFormation.tf
- title: HackTricks - AWS - Cloudformation Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-cloudformation-privesc/index.html#iampassrole-cloudformationcreatestack
- title: Well, That Escalated Quickly - Privesc 20
  url: https://labs.bishopfox.com/tech-blog/privilege-escalation-in-aws  
relatedPaths:
- ec2-001
- lambda-001
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/cloudformation_edges.py#L109-L132
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L155-L157
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L465-L470
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L68-L72
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole-cloudformation"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: CloudFormation-PassExistingRoleToCloudFormation
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: cloudformation:CreateStack
    resourceConstraints: Must have permission to create CloudFormation stacks
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `iam:PassRole` and `cloudformation:CreateStack` permissions. This principal will create a CloudFormation stack that executes with a privileged role's permissions.
  - id: cfn_stack
    label: New CloudFormation Stack
    type: resource
    description: |
      The newly created CloudFormation stack with a malicious template. The stack is created with `cloudformation:CreateStack` and configured to use a privileged IAM role via `iam:PassRole`. The template defines AWS resources to be created with the target role's permissions.
  - id: target_role
    label: Existing Role That Trusts the cloudformation Service
    type: principal
    description: |
      The privileged IAM role that is passed to the CloudFormation stack during creation. This role must trust cloudformation.amazonaws.com as a principal in its trust policy. When CloudFormation creates resources, it uses this role's permissions.
  - id: execute_template
    label: Execute Template Resources
    type: action
    color: '#99ccff'
    description: |
      The CloudFormation template executes with the target role's permissions, creating AWS resources defined in the template. Common resources for privilege escalation include IAM users with access keys, Lambda functions, EC2 instances with User Data scripts, or IAM policies/roles that grant the starting principal elevated access.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent), the CloudFormation template can create resources that grant the attacker full administrative access to the AWS account. For example, the template could create an IAM user with AdministratorAccess and access keys for the attacker.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has some elevated permissions but not full admin, the CloudFormation template can create resources that grant partial privilege escalation. This could include access to sensitive data (S3, RDS, DynamoDB) or resources that enable additional privilege escalation techniques.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions or no interesting permissions, the CloudFormation template cannot create resources that provide meaningful additional access to the attacker. Limited usefulness for privilege escalation.
  edges:
  - from: start
    to: cfn_stack
    label: iam:PassRole + cloudformation:CreateStack
    description: |
      The attacker creates a new CloudFormation stack and passes a privileged role to it. The stack is created with a malicious template (YAML or JSON) that defines AWS resources to be provisioned.

      Command:
      ```bash
      aws cloudformation create-stack \
        --stack-name privesc-stack \
        --template-body file://exploit-template.yaml \
        --capabilities CAPABILITY_IAM \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE
      ```

      The exploit-template.yaml contains resource definitions that will execute with the target role's permissions. Note the `--capabilities CAPABILITY_IAM` flag is required when the template creates IAM resources.
  - from: cfn_stack
    to: target_role
    label: Stack assumes role
    description: |
      When the CloudFormation stack is created, the CloudFormation service automatically assumes the target role. All resource creation operations in the template execute with the permissions granted to this role.
  - from: target_role
    to: execute_template
    label: CloudFormation provisions resources
    description: |
      CloudFormation provisions the resources defined in the template using the target role's permissions. The template can create any AWS resources the role has permissions for, such as IAM users with access keys, Lambda functions, EC2 instances, S3 buckets, or IAM policies and roles.

      Monitor stack progress:
      ```bash
      aws cloudformation describe-stacks \
        --stack-name privesc-stack
      ```

      The created resources can then be accessed by the attacker to gain elevated privileges.
  - from: execute_template
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent administrative permissions, the CloudFormation template can create resources that grant the attacker full control over the AWS account. For example, the template could create an IAM user with AdministratorAccess policy attached and generate access keys that are output in the stack outputs or stored in an S3 bucket the attacker can access.
  - from: execute_template
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the CloudFormation template can create resources that grant partial privilege escalation. This might include Lambda functions with data access, EC2 instances with privileged instance profiles, or IAM policies that enable additional privilege escalation techniques. The attacker gains access through the newly created resources.
  - from: execute_template
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal or non-sensitive permissions, the CloudFormation template cannot create resources that provide meaningful additional access. The privilege escalation attempt may not yield significant results, though even limited access could be useful for reconnaissance or as part of a multi-step attack chain.
