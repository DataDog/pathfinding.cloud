id: ssm-001
name: ssm:StartSession
category: access-resource
services:
- ssm
- ec2
description: The `ssm:StartSession` permission allows a principal to remotely access
  any EC2 instance on which they have this permission. This access is contingent on
  the EC2 instance having the SSM agent installed and running, possessing the AmazonSSMManagedInstanceCore
  policy or equivalent permissions, and being in a running state. This permission
  provides SSH-like access via the AWS API. Consequently, the initiating principal
  may gain additional IAM permissions associated with the accessed instances. If an
  instance has a privileged IAM role attached, an attacker can abuse this permission
  to execute code that steals the credentials for that role, thereby escalating their
  own permissions.
prerequisites:
  admin:
  - EC2 instance must exist and be running
  - EC2 instance must have SSM agent installed and running
  - EC2 instance must have an instance profile attached to an IAM role
  - IAM role must have AmazonSSMManagedInstanceCore policy or equivalent
  - Target EC2 instance must have a role with administrative permissions attached
  lateral:
  - EC2 instance must exist and be running
  - EC2 instance must have SSM agent installed and running
  - EC2 instance must have an instance profile attached to an IAM role
  - IAM role must have AmazonSSMManagedInstanceCore policy or equivalent
exploitationSteps:
  awscli:
  - step: 1
    command: aws ssm start-session --target i-XXXXXXXXXXX
    description: Start an interactive SSM session on the target EC2 instance
  - step: 2
    command: curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
    description: Retrieve the role name from the instance metadata
  - step: 3
    command: curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLENAME
    description: Steal the temporary credentials for the instance's IAM role
recommendation: 'Restrict access to `ssm:StartSession` using the principle of least
  privilege. Use the Resource and Condition elements in IAM policies to limit which
  instances a principal can start sessions on. Monitor use of this sensitive permission
  using CloudSIEM detections.

  '
limitations: 'This path provides administrative access only if the target resource''s
  execution role has administrative permissions. The attacker gains whatever permissions
  the resource''s role has. If the role has limited permissions, the attacker gains
  limited access. However, even limited access may enable multi-hop attacks or access
  to sensitive data.

  '
discoveryAttribution:
  firstDocumented:
    author: Erik Steringer
    organization: NCC Group
    date: 2019
    link: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/ssm_edges.py
references:
- title: PMapper SSM Edges
  url: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/ssm_edges.py
- title: IAM Vulnerable - SSM StartSession
  url: https://github.com/BishopFox/iam-vulnerable
- title: HackTricks - AWS - SSM Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ssm-privesc/index.html#ssmstartsession
- title: AWS IAM privilege escalation paths
  url: https://pswalia2u.medium.com/aws-iam-privilege-escalation-paths-cba36be1aa9e
relatedPaths:
- ssm-002
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/ssm_edges.py#L103-L110
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/ssm-startsession
    description: Deploy Terraform into your own AWS account to practice this attack
      path
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: SSM-StartSession
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: ecs_efs_attack
    description: Deploy vulnerable infrastructure using CloudGoat to practice AWS
      attacks. This scenario uses ssm:StartSession to access EC2 instances after exploiting
      tag-based policies
permissions:
  required:
  - permission: ssm:StartSession
    resourceConstraints: Target EC2 instance must be in the Resource section
  additional:
  - permission: ec2:DescribeInstances
    resourceConstraints: Helpful for discovering available EC2 instances to target
  - permission: ssm:DescribeInstanceInformation
    resourceConstraints: Helpful for identifying instances with SSM agent installed
      and their online status
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The starting principal (user or role) with `ssm:StartSession` permission.
      This principal can start an interactive session on any EC2 instance that has
      the SSM agent installed and running, and that the principal has permission to
      access. The session provides shell access similar to SSH but operates entirely
      through the AWS API.

      '
  - id: ec2_instance
    label: EC2 Instance
    type: resource
    description: 'The target EC2 instance with SSM agent installed and running. The
      instance must have an IAM role attached via instance profile with the AmazonSSMManagedInstanceCore
      policy (or equivalent permissions) to enable Systems Manager functionality.
      The instance must also be in a running state for the session to be established.

      '
  - id: instance_role
    label: Existing Service Role
    type: principal
    description: 'The IAM role attached to the EC2 instance via instance profile.
      This role''s temporary credentials are available through the Instance Metadata
      Service (IMDS) at http://169.254.169.254/latest/meta-data/iam/security-credentials/.
      Once the attacker gains session access to the instance, they can use these credentials
      in several ways.

      '
  - id: method_direct_elevation
    label: 'Method 1: Direct Elevation via AWS CLI'
    type: payload
    color: '#99ccff'
    description: "Once the SSM session is established, use the AWS CLI on the EC2\
      \ instance to directly elevate the starting principal's permissions. The commands\
      \ run with the instance role's credentials and can perform privileged IAM actions\
      \ such as:\n- Attaching AdministratorAccess policy to the starting principal\
      \ (iam:AttachUserPolicy)\n- Creating new access keys for privileged users (iam:CreateAccessKey)\n\
      - Adding the starting principal to an admin IAM group (iam:AddUserToGroup)\n\
      - Modifying inline policies to grant elevated permissions (iam:PutUserPolicy)\n\
      \nExample commands from within the SSM session:\n```bash\naws iam attach-user-policy\
      \ \\\n  --user-name starting-user \\\n  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\n\
      ```\n\nThis approach is the most direct - it immediately grants the starting\
      \ principal elevated permissions using the instance role's credentials. No credential\
      \ exfiltration is needed.\n"
  - id: method_credential_exfil
    label: 'Method 2: Exfiltrate Credentials to Remote Host'
    type: payload
    color: '#99ccff'
    description: 'Once the SSM session is established, retrieve the instance role''s
      temporary credentials from IMDS and manually configure them on the attacker''s
      host. This provides the most flexibility as the attacker can use the credentials
      from any location.


      From within the SSM session, query IMDS to retrieve credentials:

      ```bash

      # Get the role name

      curl http://169.254.169.254/latest/meta-data/iam/security-credentials/


      # Get the credentials

      curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLE_NAME

      ```


      The output contains JSON with AccessKeyId, SecretAccessKey, and SessionToken.
      The attacker can then configure these on their own host:

      ```bash

      export AWS_ACCESS_KEY_ID="..."

      export AWS_SECRET_ACCESS_KEY="..."

      export AWS_SESSION_TOKEN="..."


      # Or use aws configure

      aws configure set aws_access_key_id "..." --profile exfiltrated

      aws configure set aws_secret_access_key "..." --profile exfiltrated

      aws configure set aws_session_token "..." --profile exfiltrated

      ```


      This approach provides maximum flexibility and persistence, allowing the attacker
      to work from their own environment and maintain access even if the SSM session
      is terminated.

      '
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: 'If the instance role has AdministratorAccess or equivalent administrative
      permissions, the attacker gains full administrative access to the AWS account
      using the exfiltrated credentials. They can perform any action in the account
      including creating new admin users, modifying resources, or accessing sensitive
      data.

      '
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: 'If the instance role has some elevated permissions but not full
      admin access, the attacker gains partial privilege escalation. This could include
      access to sensitive data stores (S3 buckets, RDS databases, DynamoDB tables),
      ability to modify certain resources, or permissions that enable additional privilege
      escalation paths.

      '
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: 'If the instance role only has minimal permissions (such as the basic
      AmazonSSMManagedInstanceCore policy for Systems Manager functionality), the
      credential exfiltration may not provide meaningful additional access beyond
      what the starting principal already had. However, even limited access could
      be useful for reconnaissance.

      '
  edges:
  - from: start
    to: ec2_instance
    label: ssm:StartSession
    description: 'Start an interactive Systems Manager session on the target EC2 instance
      using ssm:StartSession. This establishes a shell session similar to SSH but
      operates entirely through the AWS API without requiring network connectivity
      to the instance or open SSH ports.


      Command:

      ```bash

      aws ssm start-session --target i-XXXXXXXXXXX

      ```


      After executing this command, an interactive shell session is established on
      the instance.

      '
  - from: ec2_instance
    to: instance_role
    label: Session access to instance
    description: 'The SSM session provides shell access to the EC2 instance. The instance
      automatically provides access to the attached IAM role''s credentials through
      the Instance Metadata Service. The attacker can now choose one of several exploitation
      methods to leverage these credentials.

      '
  - from: instance_role
    to: method_direct_elevation
    label: Option A
    description: 'Use the AWS CLI on the EC2 instance to directly modify IAM and elevate
      the starting principal''s permissions. This is the most direct approach and
      doesn''t require credential exfiltration.

      '
  - from: instance_role
    to: method_credential_exfil
    label: Option B
    description: 'Query IMDS to retrieve the instance role''s credentials and manually
      configure them on the attacker''s host for use from any location.

      '
  - from: method_direct_elevation
    to: admin_outcome
    label: If instance role has admin permissions
    branch: A1
    condition: admin
    description: 'If the instance role has AdministratorAccess or equivalent administrative
      permissions, the direct elevation approach immediately grants the starting principal
      full administrative access by attaching admin policies or creating admin access
      keys.

      '
  - from: method_direct_elevation
    to: partial_outcome
    label: If instance role has some permissions
    branch: A2
    condition: some_permissions
    description: 'If the instance role has elevated but non-administrative permissions,
      the direct elevation approach can still grant the starting principal useful
      additional permissions by modifying IAM policies or group memberships within
      the instance role''s permission scope.

      '
  - from: method_direct_elevation
    to: minimal_outcome
    label: If instance role has minimal permissions
    branch: A3
    condition: no_permissions
    description: 'If the instance role only has minimal permissions (like AmazonSSMManagedInstanceCore),
      the direct elevation approach will fail because the role lacks the necessary
      IAM modification permissions. The attacker would need to choose a different
      exploitation method.

      '
  - from: method_credential_exfil
    to: admin_outcome
    label: If instance role has admin permissions
    branch: B1
    condition: admin
    description: 'If the instance role has AdministratorAccess or equivalent administrative
      permissions, the exfiltrated credentials provide the attacker with full administrative
      access to the AWS account from any location. They can create new admin users,
      access all resources, and modify security configurations.

      '
  - from: method_credential_exfil
    to: partial_outcome
    label: If instance role has some permissions
    branch: B2
    condition: some_permissions
    description: 'If the instance role has elevated but non-administrative permissions,
      the exfiltrated credentials provide partial privilege escalation. Common scenarios
      include access to S3 buckets, RDS databases, DynamoDB tables, or permissions
      to modify specific resources. The attacker can work from their own environment.

      '
  - from: method_credential_exfil
    to: minimal_outcome
    label: If instance role has minimal permissions
    branch: B3
    condition: no_permissions
    description: 'If the instance role only has minimal permissions such as AmazonSSMManagedInstanceCore
      or CloudWatch logs write access, the exfiltrated credentials may not provide
      significant additional access. However, having the credentials on the attacker''s
      host provides persistence even if the SSM session is terminated.

      '
