id: ec2-001
name: iam:PassRole + ec2:RunInstances
category: service-passrole
services:
- iam
- ec2
description: A principal with `iam:PassRole` and `ec2:RunInstances` permissions can launch a new EC2 instance and attach an
  existing IAM Role to it. By accessing this new instance (e.g., via User Data or SSM), the attacker can obtain the credentials
  of the passed role. The level of access gained depends on the permissions of the available roles.
prerequisites:
  admin:
  - A role must exist that trusts ec2.amazonaws.com to assume it
  - The role must have an instance profile associated with it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  lateral:
  - A role must exist that trusts ec2.amazonaws.com to assume it
  - The role must have an instance profile associated with it
exploitationSteps:
  awscli:
  - step: 1
    command: aws ec2 run-instances --image-id ami-12345678 --instance-type t2.micro --iam-instance-profile Arn="arn:aws:iam::ACCOUNT_ID:instance-profile/PRIVILEGED_ROLE"
      --user-data file://exploit.sh
    description: Launch EC2 instance with privileged role and user data script to exfiltrate credentials
  - step: 2
    command: '# User data script executes on boot and sends credentials to attacker-controlled server'
    description: Retrieve the temporary credentials from the attacker's server
  pacu:
  - step: 1
    command: run ec2__startup_shell_script --instance-profile PRIVILEGED_ROLE --script exploit.sh
    description: Use Pacu to launch EC2 instance with the target role and execute a shell script on startup
recommendation: |
  - Tightly control the `iam:PassRole` permission using the principle of least privilege.
  - Use IAM policy conditions to restrict which roles can be passed and to which services:

  ```json
  {
    "Effect": "Allow",
    "Action": "`iam:PassRole`",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificRole",
    "Condition": {
      "StringEquals": {
        "`iam:PassedToService`": "ec2.amazonaws.com"
      }
    }
  }
  ```

  - Monitor CloudTrail for suspicious PassRole + RunInstances patterns, especially:
    - PassRole events followed immediately by RunInstances
    - Roles being passed to EC2 that haven't been used before
    - EC2 instances launched with privileged roles by unusual principals
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - CreateEC2WithExistingIP
  url: https://github.com/BishopFox/iam-vulnerable/blob/main/modules/free-resources/privesc-paths/privesc3-CreateEC2WithExistingIP.tf
relatedPaths:
- lambda-001
- cloudformation-001
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/ec2_edges.py#L73-L127
  cloudsplaining: https://github.com/salesforce/cloudsplaining/blob/master/cloudsplaining/shared/constants.py#L131-L132
  pacu: https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/iam__privesc_scan/main.py#L733-L738
  prowler: https://github.com/prowler-cloud/prowler/blob/master/prowler/providers/aws/services/iam/lib/privilege_escalation.py#L26-L30
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/iam-passrole+ec2-runinstances"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: EC2-CreateInstanceWithExistingProfile
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
  cloudgoat:
    type: open-source
    githubLink: https://github.com/RhinoSecurityLabs/cloudgoat
    scenario: iam_privesc_by_attachment
    description: "Deploy vulnerable infrastructure using CloudGoat to practice AWS privilege escalation through instance profile manipulation"
  pwnedlabs:
    type: closed-source
    description: "Hosted cloud security labs with AWS privilege escalation scenarios"
    scenario: https://labs.pwnedlabs.io/command-injection-to-ec2-user-data-privilege-escalation
    scenarioPricingModel: paid
attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with iam:PassRole and ec2:RunInstances permissions. Can be an IAM user or role.

    - id: ec2_instance
      label: New EC2 Instance
      type: resource
      description: |
        New EC2 instance launched with a privileged IAM instance profile. The instance automatically assumes the attached role.

    - id: target_role
      label: Existing Role That Trusts the ec2 Service
      type: resource
      description: |
        IAM role attached to the EC2 instance via instance profile. The role must trust ec2.amazonaws.com and have an instance profile. Credentials are available via the instance metadata service at http://169.254.169.254/latest/meta-data/iam/security-credentials/

    - id: userdata_script
      label: User Data Script Takes Action
      type: action
      color: '#99ccff'
      description: |
        Create a User Data script that runs on instance boot and uses the target role's credentials. The script could:
        - Attach AdministratorAccess policy to starting principal
        - Create new admin access keys for starting principal
        - Add starting principal to admin group
        - Exfiltrate credentials to attacker-controlled server
        - Execute commands with the target role's permissions

    - id: reverse_shell
      label: Reverse Shell to Remote Listener
      type: action
      color: '#99ccff'
      description: |
        Create a User Data script that establishes a reverse shell connection to an attacker-controlled server, providing remote access to the EC2 instance with the target role's credentials. The attacker can then use these credentials from their own environment.

    - id: admin_via_userdata
      label: Starting Principal Elevated to Admin
      type: outcome
      description: |
        The User Data script successfully elevated the starting principal to administrator by modifying IAM policies/groups using the target role's credentials. The starting principal now has full administrative access.

    - id: some_perms_via_userdata
      label: Starting Principal Gains Some Access
      type: outcome
      color: '#ffeb99'
      description: |
        The User Data script was able to grant the starting principal some elevated permissions using the target role's credentials, but not full administrative access. This could still be useful for further attacks or data access.

    - id: no_access_via_userdata
      label: User Data Script Limited Effect
      type: outcome
      color: '#cccccc'
      description: |
        The target role has minimal permissions, so the User Data script cannot effectively elevate the starting principal. Limited usefulness for privilege escalation.

    - id: admin_via_reverse
      label: Remote Admin Access
      type: outcome
      description: |
        Via the reverse shell, the attacker has remote access with the target role's credentials. If the target role has administrative permissions, the attacker has full administrative access to the account.

    - id: some_perms_via_reverse
      label: Remote Partial Access
      type: outcome
      color: '#ffeb99'
      description: |
        Via the reverse shell, the attacker has remote access with the target role's credentials. The role has some elevated permissions that could be used for further attacks or data access.

    - id: no_access_via_reverse
      label: Remote Minimal Access
      type: outcome
      color: '#cccccc'
      description: |
        Via the reverse shell, the attacker has remote access but the target role has minimal permissions. Limited usefulness for further attacks.

  edges:
    - from: start
      to: ec2_instance
      label: iam:PassRole + ec2:RunInstances
      description: |
        Launch a new EC2 instance and pass the target role to it via the --iam-instance-profile parameter. Include a User Data script that will execute on instance boot.

    - from: ec2_instance
      to: target_role
      label: Instance assumes role
      description: |
        The EC2 instance automatically assumes the attached IAM role. Credentials are available via the instance metadata service.

    - from: target_role
      to: userdata_script
      label: User Data script approach
      branch: A
      description: |
        Configure the User Data script to use the target role's credentials to elevate the starting principal directly (e.g., attach admin policy, create access keys, modify IAM groups).

        The effectiveness depends on the target role's permissions.

    - from: target_role
      to: reverse_shell
      label: Reverse shell approach
      branch: B
      description: |
        Configure the User Data script to establish a reverse shell connection to an attacker-controlled server, exfiltrating the target role's credentials for remote use.

        This approach works regardless of the target role's permissions.

    - from: userdata_script
      to: admin_via_userdata
      label: If target role has admin or IAM write permissions
      branch: A1
      condition: admin
      description: |
        If the target role has AdministratorAccess or permissions to modify IAM (like iam:AttachUserPolicy, iam:PutUserPolicy, iam:AddUserToGroup, iam:CreateAccessKey), the User Data script can successfully elevate the starting principal to administrator.

    - from: userdata_script
      to: some_perms_via_userdata
      label: If target role has some elevated permissions
      branch: A2
      condition: some_permissions
      description: |
        If the target role has some elevated permissions (but not full admin or IAM write access), the User Data script can grant the starting principal some useful access for further attacks or data access.

    - from: userdata_script
      to: no_access_via_userdata
      label: If target role has minimal permissions
      branch: A3
      condition: no_permissions
      description: |
        If the target role only has minimal permissions (like logs:PutLogEvents), the User Data script cannot effectively elevate the starting principal. Limited usefulness for privilege escalation.

    - from: reverse_shell
      to: admin_via_reverse
      label: If target role has admin permissions
      branch: B1
      condition: admin
      description: |
        If the target role has AdministratorAccess or equivalent permissions, the attacker gains full administrative access via the reverse shell.

    - from: reverse_shell
      to: some_perms_via_reverse
      label: If target role has some permissions
      branch: B2
      condition: some_permissions
      description: |
        If the target role has some elevated permissions (data access, further escalation paths), the attacker can leverage these via the reverse shell.

    - from: reverse_shell
      to: no_access_via_reverse
      label: If target role has minimal permissions
      branch: B3
      condition: no_permissions
      description: |
        If the target role only has minimal permissions (like logs:PutLogEvents), the reverse shell provides limited value for further attacks.
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: ec2:RunInstances
    resourceConstraints: Must have permission to launch EC2 instances
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
